<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Home | public var hocaron</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Home" />
<meta name="author" content="Hocaron" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Minimal Jekyll theme for storytellers" />
<meta property="og:description" content="Minimal Jekyll theme for storytellers" />
<link rel="canonical" href="https://hocaron.github.io/ko/" />
<meta property="og:url" content="https://hocaron.github.io/" />
<meta property="og:site_name" content="public var hocaron" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Home" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebSite","author":{"@type":"Person","name":"Hocaron","url":"https://hocaron.github.io"},"description":"Minimal Jekyll theme for storytellers","headline":"Home","name":"public var hocaron","url":"https://hocaron.github.io/"}</script>
<!-- End Jekyll SEO tag -->


  <!-- CSS -->
  <link rel="stylesheet" href="/ko/assets/main.css">
  <link rel="stylesheet" href="../assets/main.js">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/all.min.css" />

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/ko/assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/ko/assets/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/ko/assets/apple-touch-icon.png">

  <!-- RSS -->
  <link type="application/atom+xml" rel="alternate" href="https://hocaron.github.io/ko/feed.xml" title="public var hocaron" />

  <!-- Google Analytics-->
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UAâ€”XXXXXXXX-X', 'auto');
  ga('send', 'pageview');
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

  <!-- JavaScript -->
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script type="text/javascript" src="../assets/main.js"></script>

  <!-- SEO for Polyglot -->
  
</head>


<body>
<div>
  




<nav class="nav">
  <div class="nav-container">
    <a href="/ko/">
      <h2 class="nav-title">public var hocaron</h2>
    </a>
    <ul>
      <li class="selected">
      <a href="/ko/">Posts</a>
      </li>
      <li >
        <a href="/ko/series">Series</a>
      </li>
      <li >
        <a href="/ko/about">About</a>
      </li>

      <li>
        
        
        
        <a class="lang active"
           href="
                /ko/
              ">
          KOR
          |
        </a>
        
        
        
        <a class="lang "
           href="
                /
              ">
          ENG
          
        </a>
        
      </li>

    </ul>
  </div>
</nav>


  <main>
    <div class="catalogue">
  
    
  
    
  

  
    <a href="/ko/dead-lock-by-index/" class="catalogue-item">
  <div>
    
    <time datetime="2023-05-23 00:00:00 +0000" class="catalogue-time">May 23, 2023</time>
    <h1 class="catalogue-title">[íŠ¸ëŸ¬ë¸”ìŠˆíŒ… - DB] ì¸ë±ìŠ¤(Index)ì™€ ë°ë“œë½(DeadLock)</h1>
    <div class="catalogue-line"></div>

    <p>
      
        

ì—­ì‹œ í•´ì¹˜ì› ë‚˜ë¥¼ ì™¸ì¹˜ë©´ ì•ˆ ë˜ëŠ” ê²ƒì¸ê°€â€¦ ë˜ ìš¸ê¸° ì‹œì‘í•œ í˜í˜â€¦ (ê·¸ë§Œ ìš¸ì–´ì‡!)
ì˜ë¯¸ìˆëŠ” ê²½í—˜ìœ¼ë¡œ ë‚¨ê¸°ê¸°ìœ„í•´ ê¸°ë¡í•´ë³´ì.


ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ìƒí™© ë‹¤ì‹œ ì¬í˜„

í˜„ì¬ í…Œì´ë¸” ìƒíƒœ
CREATE TABLE parent
(
    id             bigint        not null primary key,
    name           varchar(255)  null,
    updated_at     datetime(6)   null
);

CREATE TABLE child
(
    id           bigint          not null primary key,
    name         varchar(255)    null,
    parent_id    bigint          null,
    CONSTRAINT parent_id_unique UNIQUE (parent_id)
);


CREATE TABLE child_index
(
    id           bigint          not null primary key,
    name         varchar(255)    null,
    parent_id    bigint          null,
);
CREATE INDEX parent_id ON child_index (parent_id);

INSERT INTO parent VALUES (1, 'parent_1', NOW());


  parent í…Œì´ë¸”ì˜ idë¥¼ indexë¡œ ê°€ì§€ê³  ìˆëŠ” child_index í…Œì´ë¸” ìƒì„±(ì™¸ë˜í‚¤ëŠ” ìš´ì˜ì—ì„œ ì‚­ì œë˜ì–´ì„œ í…ŒìŠ¤íŠ¸ì‹œ ê³ ë ¤í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤)
  parent í…Œì´ë¸”ì˜ idë¥¼ ìœ ë‹ˆí¬ í‚¤ë¡œ ê°€ì§€ê³  ìˆëŠ” child í…Œì´ë¸” ìƒì„±(ë§ˆì°¬ê°€ì§€ë¡œ ì™¸ë˜í‚¤ ê³ ë ¤í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)
  parent í…Œì´ë¸”ì— í…ŒìŠ¤íŠ¸ ë°ì´í„° ì ì¬


ê·¸ëŸ¼ ì´ì œ ë°ë“œë½ì„ ë°œìƒì‹œì¼œ ë³´ì
index ê±¸ë ¤ìˆëŠ” row delete â†’  index ê±¸ë ¤ìˆëŠ” ìì‹ row insertê°€ ë‘ê°œì˜ ì„¸ì…˜ì—ì„œ ìˆ˜í–‰ë˜ë©´, ë°ë“œë½ì´ ë°œìƒ ğŸ’£



  
    
      TX1
      TX2
      lock
    
  
  
    
      BEGIN ;   DELETE FROM child_index WHERE parent_id = 2;
      Â 
      (1) child X Lock ì¸ë°, TX2ì—ì„œ X Lock íšë“ ê°€ëŠ¥í• ê¹Œ ğŸ¤”
    
    
      Â 
      BEGIN ;   DELETE FROM child_index WHERE parent_id = 2;
      (2) child X Lock
    
    
      INSERT INTO child_index VALUES (â€˜1â€™, â€˜name2â€™, 2);
      Â 
      (3) child X,INSERT_INTENTION Lock ëŒ€ê¸°
    
    
      Â 
      INSERT INTO child_index VALUES (â€˜2â€™, â€˜name2â€™, 2);
      (4) child X,INSERT_INTENTION Lock ëŒ€ê¸°
    
    
      Â 
      Deadlock found when trying to get lock; try restarting transaction
      (4) child X lock ì´ í•„ìš”í•˜ì§€ë§Œ, (2) ì—ì„œ child X lock ìƒíƒœ  (4) í•´ì†Œë¥¼ ìœ„í•´ì„œ (3) í•´ì†Œ í•„ìš”  -&gt; (3) í•´ì†Œ ìœ„í•´ì„œ TX2 ì»¤ë°‹ í•„ìš”  -&gt; TX2 ì»¤ë°‹í•˜ë ¤ë©´ (4) í•´ì†Œ í•„ìš”  -&gt; ë°ë“œë½ ë°œìƒ
    
  


ìš´ì˜í™˜ê²½ì—ì„œ ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ë¡œì§ì„ ì‚´í´ë³´ì

index ê±¸ë ¤ìˆëŠ” row delete â†’  index ê±¸ë ¤ìˆëŠ” ìì‹ row insertê°€ ë‘ê°œì˜ ì„¸ì…˜ì—ì„œ ìˆ˜í–‰ë˜ë©´, ë°ë“œë½ì´ ë°œìƒ ğŸ’£
SELECT * from parent WHERE id = 1;
INSERT INTO child VALUES (1, 'child_1', 1);
DELETE FROM child_index WHERE parent_id = 1;
INSERT INTO child_index VALUES (1, 'child_index_1', 1);
UPDATE parent SET  updated_at = NOW() WHERE id = 1;


  @Transactional
  public void createChildAndChildIndex (long parentId) {

    var parent = parentRepository.findById(parentId);
    
    childIndexRepository.deleteByParent(parent);
    childIndexRepository.save(new Child_Index('child_index_1', parent));

  }


  í•œê°€ì§€ ì‹ ê¸°í•œ ì ì€ delete í•˜ë ¤ëŠ” ë°ì´í„°ê°€ ì—†ì„ ë•Œ, ë°ë“œë½ì´ ë°œìƒí•œë‹¤.
  delete í•˜ë ¤ëŠ” ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ì—ëŠ” ê°™ì€ ë¡œì§ì„ ìˆ˜í–‰í•˜ë©´ ë½ì„ ì¡ì„ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê²Œ ëœë‹¤.


ì›ì¸ì€ ì•Œì•˜ê³ , ì„œë²„ì—ì„œ ë°ë“œë½ì„ í•´ê²°í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ê³ ë¯¼í•´ë³´ì
â ì²«ë²ˆì§¸ ì‹œë„, ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ row ì‚­ì œ
  @Transactional
  public void createParent (long parentId) {

    var parent = parentRepository.findById(parentId);
    
    if(childIndexRepository.findByParent(parent).isPresent()) {
        childIndexRepository.deleteByParent(parent);
    }
    childIndexRepository.save(new Child_Index('child_index_1', parent));
  }


  ë¬´ì¡°ê±´ delete í•˜ëŠ” ë¡œì§ìœ¼ë¡œ ì¸í•œ ë°°íƒ€ë½ì€ ë°©ì§€ ê°€ëŠ¥í•˜ë‹¤.
  ë™ì‹œ ìš”ì²­ì‹œì— childIndexRepository.findByParent ì— ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ë¡œ ë¶„ê¸°ì²˜ë¦¬ë˜ëŠ” ê²½ìš°, ë°ì´í„°ê°€ 2ë°°ë¡œ ì ì¬ë  ìˆ˜ ìˆë‹¤.
    
      300ms ë¡œ ì“°ë ˆë“œ sleep() ê±¸ì–´ì„œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ 2ë°°ë¡œ ìŒ“ì´ëŠ” ê²ƒì„ í™•ì¸
    
  


âœ… ë‘ë²ˆì§¸ ì‹œë„, ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ row ì‚­ì œí•˜ë©´ì„œ ìœ ë‹ˆí¬ ì¡°ê±´ ì¶”ê°€
CREATE TABLE child_index
(
    id           bigint          not null primary key,
    name         varchar(255)    null,
    parent_id    bigint          null,
    CONSTRAINT parent_id_unique UNIQUE (parent_id)
);
CREATE INDEX parent_id ON child_index (parent_id);


  ë™ì‹œ ìš”ì²­ì‹œì— childIndexRepository.findByParent ì— ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ë¡œ ë¶„ê¸°ì²˜ë¦¬ë˜ëŠ” ê²½ìš°, í›„ì— ì»¤ë°‹ë˜ì–´ ì ì¬ëœ ë°ì´í„°ëŠ” ì¤‘ë³µí‚¤ ì—ëŸ¬ ì²˜ë¦¬ëœë‹¤.


â ì„¸ë²ˆì§¸ ì‹œë„, Redis ì— ë™ì‹œì„± ì œì–´ë¥¼ ìœ„í•œ í‚¤ ì¶”ê°€

  ê°„í—ì ì¸ ë°ë“œë½ì´ê³ , ìœ„ ì„œë¹„ìŠ¤ì—ì„œ Redisë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ ìºì‹œ ë¦¬ì†ŒìŠ¤ê°€ ë” í´ ê²ƒ ê°™ì•„ ë‚˜ê°€ë¦¬!


â ë„¤ë²ˆì§¸ ì‹œë„, ìš”ì²­ ì œí•œ

  Bucket4jë¥¼ ì´ìš©í•´ì„œ í´ë¼ì´ì–¸íŠ¸ê°€ íŠ¹ì • ì‹œê°„ í”„ë ˆì„ ë‚´ì— ë§Œë“¤ ìˆ˜ ìˆëŠ” API í˜¸ì¶œ ìˆ˜ë¥¼ ì œí•œí•œë‹¤.
  ìœ„ ì„œë¹„ìŠ¤ëŠ” ì„œë²„ê°€ ì—¬ëŸ¬ëŒ€ì¸ ê²½ìš°ë¼ì„œ ë‹¤ë¥¸ ì„œë²„ë¡œ ë™ì‹œ ìš”ì²­ì´ ë“¤ì–´ê°€ëŠ” ê²½ìš°, ë°ë“œë½ ë°©ì§€ ë¶ˆê°€ëŠ¥


ì •ë¦¬

  ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°, ì‚­ì œ ì¿¼ë¦¬ë¥¼ ë‚ ë¦¬ë©´ delete, select ëŠ” ê°€ëŠ¥í•˜ì§€ë§Œ insert ì‹œì— ë½ì„ ê¸°ë‹¤ë¦¬ê²Œ ëœë‹¤.
  ë½ì´ ê¶ê¸ˆí•˜ë‹¤ë©´, MySQL ê³µì‹ë¬¸ì„œ ì¤‘ InnoDB Lock ë©”ë‰´ì–¼ì„ ì°¸ê³ í•´ë³´ì. (ì˜ˆì œì™€ í•¨ê»˜ ì •ë¦¬ê°€ ë„ˆë¬´ ì˜ ë˜ì–´ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.)


í¥ë¯¸ë¡œìš´ ì‹¤í—˜
ì¸ë±ìŠ¤ê°€ ê±¸ë¦° ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ì¿¼ë¦¬

  ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ì—ëŠ”, 2ë²ˆì§¸ íŠ¸ëœì­ì…˜ì—ì„œ delete ì‹œì— ë½ íšë“ì„ ê¸°ë‹¤ë¦°ë‹¤.
    BEGIN ;
DELETE FROM child_index WHERE parent_id = 1;
INSERT INTO child_index VALUES (1, 'child_index_1', 1);
COMMIT ;
    
  
  ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ì—ëŠ”, 2ë²ˆì§¸ íŠ¸ëœì­ì…˜ì—ì„œ delete ì‹œì— ë½ íšë“ì´ ë°”ë¡œ ê°€ëŠ¥í•˜ë‹¤.
    BEGIN ;
DELETE FROM child_index WHERE parent_id = 1;
INSERT INTO child_index VALUES (1, 'child_index_1', 1);
COMMIT ;
    
    ì¸ë±ìŠ¤ê°€ ê±¸ë¦¬ì§€ ì•Šì€ ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ì¿¼ë¦¬
  
  ë°ì´í„°ê°€ ìˆëŠ” / ì—†ëŠ” ê²½ìš°, 2ë²ˆì§¸ íŠ¸ëœì­ì…˜ì—ì„œ delete ì‹œì— ë½ íšë“ì„ ê¸°ë‹¤ë¦°ë‹¤.
    BEGIN ;
DELETE FROM child_index WHERE name = 'child_index_2';
INSERT INTO child_index VALUES (1, 'child_index_1', 1);
COMMIT ;
    
  


ê¸°ë¡ìš©

SHOW ENGINE innodb STATUS;
  *** (1) TRANSACTION:TRANSACTION 13034, ACTIVE 6 sec insertingmysql tables in use 1, locked 1LOCK WAIT 4 lock struct(s), heap size 1128, 3 row lock(s), undo log entries 1MySQL thread id 280, OS thread handle 6136639488, query id 21716 localhost 127.0.0.1 root update/* ApplicationName=DataGrip 2022.3.2 */ insert into child values ('2', 'name2', 2)

*** (1) HOLDS THE LOCK(S):RECORD LOCKS space id 154 page no 4 n bits 72 index PRIMARY of table jpa.child trx id 13034 lock_mode X locks rec but not gapRecord lock, heap no 3 PHYSICAL RECORD: n_fields 5; compact format; info bits 0

*** (1) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 154 page no 5 n bits 72 index parent_id of table jpa.child trx id 13034 lock_mode X insert intention waitingRecord lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0

*** (2) TRANSACTION:TRANSACTION 13035, ACTIVE 4 sec insertingmysql tables in use 1, locked 1LOCK WAIT 3 lock struct(s), heap size 1128, 2 row lock(s)MySQL thread id 281, OS thread handle 6135525376, query id 21726 localhost 127.0.0.1 root update/* ApplicationName=DataGrip 2022.3.2 */ insert into child values ('2', 'name2', 2)

*** (2) HOLDS THE LOCK(S):RECORD LOCKS space id 154 page no 5 n bits 72 index parent_id of table jpa.child trx id 13035 lock_mode XRecord lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0

*** (2) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 154 page no 4 n bits 72 index PRIMARY of table jpa.child trx id 13035 lock mode S locks rec but not gap waitingRecord lock, heap no 3 PHYSICAL RECORD: n_fields 5; compact format; info bits 0

- SELECT * FROM performance_schema.data_locks;

| INDEX\_NAME | OBJECT\_INSTANCE\_BEGIN | LOCK\_TYPE | LOCK\_MODE | LOCK\_STATUS | LOCK\_DATA |
| :--- | :--- | :--- | :--- | :--- | :--- |
| null | 4813003272 | TABLE | IX | GRANTED | null |
| parent\_id | 4823656472 | RECORD | X | GRANTED | supremum pseudo-record |
| parent\_id | 4823656816 | RECORD | X,INSERT\_INTENTION | GRANTED | supremum pseudo-record |
| parent\_id | 4823657160 | RECORD | X,GAP | GRANTED | 1, 1 |


      
    </p>

  </div>
</a>

  
    <a href="/ko/dead-lock-by-fk/" class="catalogue-item">
  <div>
    
    <time datetime="2023-05-22 00:00:00 +0000" class="catalogue-time">May 22, 2023</time>
    <h1 class="catalogue-title">[Troubleshooting - DB] ì™¸ë˜í‚¤(Foreign Key)ì™€ ë°ë“œë½(DeadLock) ê·¸ë¦¬ê³  ì¿¼ë¦¬ ì§€ì—° ì‹¤í–‰</h1>
    <div class="catalogue-line"></div>

    <p>
      
        
ë°ë“œë½ì´ ë°œìƒí•  ë•Œë§ˆë‹¤, í˜í˜ê°€ ìš¸ê³  ìˆë‹¤ğŸ˜¢ ê°„í—ì ìœ¼ë¡œ ë°œìƒí•˜ë˜ ë°ë“œë½ì˜ ì›ì¸ì„ ë¶„ì„í•˜ê³ , í•´ê²° ê³¼ì •ì„ ê¸°ë¡í•´ë³´ì.

ì™¸ë˜í‚¤(Foreign Key)ì™€ ë°ë“œë½(DeadLock)
ë°ë“œë½ì´ë€, ë‘˜ ì´ìƒì˜ í”„ë¡œì„¸ìŠ¤ê°€ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ê°€ ì ìœ í•˜ê³  ìˆëŠ” ìì›ì„ ì„œë¡œ ê¸°ë‹¤ë¦´ ë•Œ ë¬´í•œ ëŒ€ê¸°ì— ë¹ ì§€ëŠ” ìƒí™©ì´ë‹¤.

P1ì€ P2ê°€ ê°€ì§€ê³  ìˆëŠ” ìì›ì´ í•´ì œ ë˜ê¸¸ ê¸°ë‹¤ë¦¬ê³ , P2ëŠ” P3ì´ ê°€ì§„ ìì›, ê·¸ ë‹¤ìŒ..ê³¼ ê°™ì€ í˜•ì‹ìœ¼ë¡œ ê°€ì¥ ë§ˆì§€ë§‰ì˜ í”„ë¡œì„¸ìŠ¤ Pnê°€ ë‹¤ì‹œ P1ì´ ê°€ì§„ ìì›ì„ ìš”ì²­í•˜ê³  í•´ì œ ë˜ê¸¸ ê¸°ë‹¤ë¦¬ëŠ” í˜•íƒœì´ë‹¤.

ì™¸ë˜í‚¤ë€, ì™¸ë˜í‚¤ëŠ” ë‘ í…Œì´ë¸”ì„ ì„œë¡œ ì—°ê²°í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” í‚¤ì´ë‹¤. ì™¸ë˜í‚¤ê°€ í¬í•¨ëœ í…Œì´ë¸”ì„ ìì‹ í…Œì´ë¸”ì´ë¼ê³  í•˜ê³  ì™¸ë˜í‚¤ ê°’ì„ ì œê³µí•˜ëŠ” í…Œì´ë¸”ì„ ë¶€ëª¨ í…Œì´ë¸”ì´ë¼ê³  í•œë‹¤.


  Real MySQL 3ì¥ì„ ë³´ë©´, ì•„ë˜ì™€ ê°™ì€ ê¸€ì´ ìˆë‹¤.
â€œì™¸ë˜í‚¤ëŠ” ë¶€ëª¨í…Œì´ë¸”ì´ë‚˜ ìì‹ í…Œì´ë¸”ì— ë°ì´í„°ê°€ ìˆëŠ”ì§€ ì²´í¬í•˜ëŠ” ì‘ì—…ì´ í•„ìš”í•˜ë¯€ë¡œ ì ê¸ˆì´ ì—¬ëŸ¬ í…Œì´ë¸”ë¡œ ì „íŒŒë˜ê³ , ê·¸ë¡œì¸í•´ ë°ë“œë½ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤. ê·¸ë˜ì„œ ì‹¤ë¬´ì—ì„œëŠ” ì˜ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.â€



ì˜¤í˜¸ë¼â€¦ ì ê¸ˆì´ ì—¬ëŸ¬í…Œì´ë¸”ë¡œ ì „íŒŒëœë‹¤ê³ ?!!

ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ìƒí™© ì¬í˜„
ì¤€ë¹„ë¬¼ì€ ì´ë ‡ê²Œ ì¤€ë¹„í•´ì£¼ì„¸ìš”

CREATE TABLE parent
(
    id             bigint        not null primary key,
    name           varchar(255)  null,
    updated_at     datetime(6)   null
);

CREATE TABLE child
(
    id           bigint          not null primary key,
    name         varchar(255)    null,
    parent_id    bigint          null,
    CONSTRAINT parent_id_unique UNIQUE (parent_id),
    CONSTRAINT child_fk FOREIGN KEY (parent_id) REFERENCES parent (id)
);


CREATE TABLE child_index
(
    id           bigint          not null primary key,
    name         varchar(255)    null,
    parent_id    bigint          null,
    CONSTRAINT child_index_fk FOREIGN KEY (parent_id) REFERENCES parent (id)
);
CREATE INDEX parent_id ON child_index (parent_id);

INSERT INTO parent VALUES (1, 'parent_1', NOW());


  parent í…Œì´ë¸”ì˜ idë¥¼ foreign key / unique keyë¡œ ê°€ì§€ê³  ìˆëŠ” child í…Œì´ë¸” ìƒì„±
  parent í…Œì´ë¸”ì˜ idë¥¼ foreign key / idnexë¡œ ê°€ì§€ê³  ìˆëŠ” child_index í…Œì´ë¸” ìƒì„±
  parent í…Œì´ë¸”ì— í…ŒìŠ¤íŠ¸ ë°ì´í„° ì ì¬


ê·¸ëŸ¼ ì´ì œ ë°ë“œë½ì„ ë°œìƒì‹œì¼œ ë³´ì
ìì‹ row insert -&gt; ë¶€ëª¨ row update ê°€ 2ê°œì˜ ì„¸ì…˜ì—ì„œ ìˆ˜í–‰ë˜ë©´, ë°ë“œë½ì´ ë°œìƒ ğŸ’£



  
    
      TX1
      TX2
      lock
    
  
  
    
      BEGIN ;   INSERT INTO child VALUES (1, â€˜child1â€™, 1);
      Â 
      (1) child X,REC_NOT_GAP Lock, parent S Lock
    
    
      Â 
      BEGIN ;   INSERT INTO child VALUES (1, â€˜child1â€™, 1);
      (2) child X Lock ëŒ€ê¸°, parent S Lock
    
    
      UPDATE parent SET name = â€˜newParentâ€™ WHERE id = 1;
      Â 
      (3)
    
    
      Â 
      Deadlock found when trying to get lock; try restarting transaction
      (3) parent X lock ì´ í•„ìš”í•˜ì§€ë§Œ, (2) ì—ì„œ parentëŠ” S lock ìƒíƒœ  (3) í•´ì†Œë¥¼ ìœ„í•´ì„œ (2) í•´ì†Œ í•„ìš”  -&gt; (2) í•´ì†Œ ìœ„í•´ì„œ TX1 ì»¤ë°‹ í•„ìš”  -&gt; TX1ì´ ì»¤ë°‹í•˜ë ¤ë©´ (3) í•´ì†Œ í•„ìš”  -&gt; ë°ë“œë½ ë°œìƒ
    
  





  ìì‹ í…Œì´ë¸”ì— ëŒ€í•œ ì“°ê¸° ì¿¼ë¦¬ë¥¼ ìˆ˜í–‰í•  ë•Œ foreign í‚¤ ì œì•½ìœ¼ë¡œ ì¸í•´ ë¶€ëª¨ì˜ ì ê¸ˆ ìƒíƒœë¥¼ í™•ì¸í›„ ë¬¸ì œê°€ ì—†ìœ¼ë©´ ì¿¼ë¦¬ë¥¼ ìˆ˜í–‰í•˜ê³ , ì •í•©ì„±ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ ë¶€ëª¨ í…Œì´ë¸”ì— í•´ë‹¹ í–‰ì„ ê³µìœ ì ê¸ˆ í•œë‹¤.



  ê³µìœ  ë½(Shared(S) Lock)
ê³µìœ  ë½(Shared Lock)ì€ ì½ê¸° ë½(Read Lock)ì´ë¼ê³ ë„ ë¶ˆë¦°ë‹¤. ê³µìœ  ë½ì´ ê±¸ë¦° ë°ì´í„°ì— ëŒ€í•´ì„œëŠ” ì½ê¸° ì—°ì‚°(SELECT)ë§Œ ì‹¤í–‰ ê°€ëŠ¥í•˜ë©°, ì“°ê¸° ì—°ì‚°ì€ ì‹¤í–‰ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤. ê³µìœ  ë½ì´ ê±¸ë¦° ë°ì´í„°ì— ëŒ€í•´ì„œ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ë„ ë˜‘ê°™ì´ ê³µìœ  ë½ì„ íšë“í•  ìˆ˜ ìˆìœ¼ë‚˜, ë°°íƒ€ ë½ì€ íšë“í•  ìˆ˜ ì—†ë‹¤. ê³µìœ  ë½ì´ ê±¸ë ¤ë„ ì½ê¸° ì‘ì—…ì€ ê°€ëŠ¥í•˜ë‹¤ëŠ” ëœ»ì´ë‹¤.
ê³µìœ  ë½ì„ ì‚¬ìš©í•˜ë©´, ì¡°íšŒí•œ ë°ì´í„°ê°€ íŠ¸ëœì­ì…˜ ë‚´ë‚´ ë³€ê²½ë˜ì§€ ì•ŠìŒì„ ë³´ì¥í•œë‹¤.



  ë² íƒ€ ë½(Exclusive(X) Lock)
ë°°íƒ€ ë½ì€ ì“°ê¸° ë½(Write Lock)ì´ë¼ê³ ë„ ë¶ˆë¦°ë‹¤. ë°ì´í„°ì— ëŒ€í•´ ë°°íƒ€ ë½ì„ íšë“í•œ íŠ¸ëœì­ì…˜ì€, ì½ê¸° ì—°ì‚°ê³¼ ì“°ê¸° ì—°ì‚°ì„ ëª¨ë‘ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤. ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì€ ë°°íƒ€ ë½ì´ ê±¸ë¦° ë°ì´í„°ì— ëŒ€í•´ ì½ê¸° ì‘ì—…ë„, ì“°ê¸° ì‘ì—…ë„ ìˆ˜í–‰í•  ìˆ˜ ì—†ë‹¤. ì¦‰, ë°°íƒ€ ë½ì´ ê±¸ë ¤ìˆë‹¤ë©´ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì€ ê³µìœ  ë½, ë°°íƒ€ ë½ ë‘˜ ë‹¤ íšë“ í•  ìˆ˜ ì—†ë‹¤. ë°°íƒ€ ë½ì„ íšë“í•œ íŠ¸ëœì­ì…˜ì€ í•´ë‹¹ ë°ì´í„°ì— ëŒ€í•œ ë…ì ê¶Œì„ ê°–ëŠ” ê²ƒì´ë‹¤.


ë¶€ëª¨ row update â†’ ìì‹ row insert ê°€ ë‘ê°œì˜ ì„¸ì…˜ì—ì„œ ìˆ˜í–‰ë˜ë©´, ì¤‘ë³µí‚¤ ì—ëŸ¬ ë°œìƒ

ë¶€ëª¨ row ì—ì„œ ë¨¼ì € update ê°€ ì¼ì–´ë‚˜ë©´, ë°ë“œë½ì€ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤. ì¤‘ë³µí‚¤ ì—ëŸ¬ëŠ” ì„œë¹„ìŠ¤ íŠ¹ì„±ìƒ í•„ìš”í•´ì„œ ì¶”ê°€í•œ ì˜µì…˜ì´ë‹¤.

ìš´ì˜í™˜ê²½ì—ì„œ ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ë¡œì§ì„ ì‚´í´ë³´ì

  ì„œë¹„ìŠ¤ì—ì„œëŠ” jpa ë¥¼ ì‚¬ìš©í•˜ê³  ìˆì–´, show-sql ì˜µì…˜ì„ í†µí•´ í™•ì¸í•˜ì.
    SELECT * from parent WHERE id = 1;
INSERT INTO child VALUES (1, 'child_1', 1);
DELETE FROM child_index WHERE parent_id = 1;
INSERT INTO child_index VALUES (1, 'child_index_1', 1);
UPDATE parent SET  updated_at = NOW() WHERE id = 1;
    
    (í…Œì´ë¸” ë° ì»¬ëŸ¼ì„ ê°„ì†Œí™” ì‹œí‚¨ ë²„ì „)
  


ìì‹ row insert -&gt; ë¶€ëª¨ row update ê°€ 2ê°œì˜ ì„¸ì…˜ì—ì„œ ìˆ˜í–‰ë˜ë©´, ë°ë“œë½ì´ ë°œìƒ ğŸ’£



  2ê°œì˜ ì„¸ì…˜ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì´ìœ ë¥¼ í”„ë¡ íŠ¸ì—ì„œ ë³´ë‚´ëŠ” ë”°ë‹¥(2ë²ˆ ì´ìƒì˜ ë™ì‹œ ìš”ì²­)ìœ¼ë¡œ ë³´ì•˜ë‹¤. ğŸ–±ğŸ¤ğŸ–±ğŸ¤
  í”„ë¡ íŠ¸ì˜ ë‹¤ë¥¸ ë²„íŠ¼ì—ì„œëŠ” ê°™ì€ ì´ìŠˆê°€ ì—†ëŠ”ë°, í•´ë‹¹ ë²„íŠ¼ë§Œ ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ê²ƒë„ ê¶ê¸ˆí•˜ë‹¤ ğŸ¤”


ì›ì¸ì€ ì•Œì•˜ê³ , ì„œë²„ì—ì„œ ë°ë“œë½ì„ í•´ê²°í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ê³ ë¯¼í•´ë³´ì

â ì²«ë²ˆì§¸ ì‹œë„, ë¶€ëª¨ row update â†’ ìì‹ row insert ë¡œì§ìœ¼ë¡œ ë³€ê²½í•´ì„œ ì¤‘ë³µí‚¤ ì—ëŸ¬ ë°œìƒí•˜ë„ë¡ ì¡°ì •
  @Transactional
  public void createChildAndChildIndex (long parentId) {

    var parent = parentRepository.findById(parentId);
    // ë¶€ëª¨ row update 
    paraent.setUpdateAt(LocalDateTime.now());
    
    // ìì‹ row insert
    childRepository.save(new Child('child_1', parent));
    
    childIndexRepository.deleteByParent(parent);
    childIndexRepository.save(new Child_Index('child_index_1', parent));

  }

í•˜ì§€ë§Œ ì—¬ì „íˆ ìì‹ row insert â†’ ë¶€ëª¨ row update ë¡œì§ìœ¼ë¡œ ì¿¼ë¦¬ê°€ ë‚˜ê°€ì„œ ë°ë“œë½ì´ ë°œìƒí•˜ê³  ìˆë‹¤. ğŸ˜‡

Hibernate ì¿¼ë¦¬ ì‹¤í–‰ ìš°ì„ ìˆœìœ„
JPA ì“°ê¸° ì§€ì—° ë•ë¶„ì— service method ê°€ ëë‚˜ê³  íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë˜ëŠ” ì‹œì ì— ì¿¼ë¦¬ê°€ DBì— ë°˜ì˜ëœë‹¤ëŠ” ê²ƒì€ ì•Œê³  ìˆì—ˆì§€ë§Œ, ìš°ì„ ìˆœìœ„ê°€ ìˆì—ˆë‹¤ê³ ..??

OrphanRemovalAction
AbstractEntityInsertAction
EntityUpdateAction
QueuedOperationCollectionAction
CollectionRemoveAction
CollectionUpdateAction
CollectionRecreateAction
EntityDeleteAction

1. Inserts, in the order they were performed
2. Updates
3. Deletion of collection elements
4. Insertion of collection elements
5. Deletes, in the order they were performed

fyi; í•˜ì´ë²„ë„¤ì´íŠ¸ ì¿¼ë¦¬ ì‹¤í–‰ ìˆœì„œ


  ì™¸ë˜í‚¤ ì œì•½ ì¡°ê±´ì´ë€?
ì™¸ë˜í‚¤ë¥¼ ê°–ëŠ” í…Œì´ë¸”ì— ë°ì´í„°ë¥¼ ì‚½ì…í•  ë•ŒëŠ” ê¸°ì¤€ í…Œì´ë¸”(ì™¸ë˜í‚¤ì— í•´ë‹¹ë˜ëŠ” í…Œì´ë¸”)ì— ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ” ë°ì´í„°ë§Œ ì°¸ì¡°í•´ì•¼ í•œë‹¤. ì—†ëŠ” ë°ì´í„°ë¥¼ ì°¸ì¡°í•´ì„œ ì™¸ë˜í‚¤ë¡œ ì¨ë¨¹ìœ¼ë©´ ì•ˆëœë‹¤ê³ . ê·¸ë˜ì„œ í•­ìƒ insertê°€ ë¨¼ì € ë˜ê²Œ í•˜ëŠ” ê²ƒ ê°™ë‹¤!


ë¡œì§ì„ ë³€ê²½í–ˆìŒì—ë„ ì—¬ì „íˆ ìì‹ row insert â†’ ë¶€ëª¨ row update ë¡œì§ìœ¼ë¡œ ì¿¼ë¦¬ê°€ ë‚˜ê°€ëŠ” ì´ìœ ëŠ” ì“°ê¸° ì§€ì—°ì— ì˜í•´ ìì‹ row insert ê°€ ë¶€ëª¨ row update ë³´ë‹¤ ìš°ì„  ìˆ˜í–‰ë˜ê¸° ë•Œë¬¸ì´êµ°!

â ë‘ë²ˆì§¸ ì‹œë„, ë¶€ëª¨ row update í›„ì— flush() í•˜ì—¬ ì¿¼ë¦¬ ì‹¤í–‰
  @Transactional
  public void createParent (long parentId) {

    var parent = parentRepository.findById(parentId);
    // ë¶€ëª¨ row update 
    paraent.setUpdateAt(LocalDateTime.now());
    // ë¶€ëª¨ row update í›„ì— flush()
    parentRepository.flush();
    
    // ìì‹ row insert
    childRepository.save(new Child('child_1', parent));
    
    childIndexRepository.deleteByParent(parent);
    childIndexRepository.save(new Child_Index('child_index_1', parent));

  }


ë¡œì§ëŒ€ë¡œ ì¿¼ë¦¬ê°€ ë‚˜ê°„ë‹¤!
SELECT * from parent WHERE id = 1;
UPDATE parent SET  updated_at = NOW() WHERE id = 1;
INSERT INTO child VALUES (1, 'child_1', 1);
DELETE FROM child_index WHERE parent_id = 1;
INSERT INTO child_index VALUES (1, 'child_index_1', 1);


  í•˜ì§€ë§Œ flush() ê°€ ì–´ë–¤ ì‚¬ì´ë“œ ì´í™ì´ ìˆì„ì§€ì™€ ë‚˜ì¤‘ì— íˆìŠ¤í† ë¦¬ë¥¼ ëª¨ë¥´ëŠ” ë™ë£Œê°€ ëœ¬ê¸ˆì—†ëŠ” flush() ë¥¼ ë³´ê³  ì´í•´í•˜ì§€ ëª» í•˜ëŠ” ë¬¸ì œê°€ ìˆë‹¤.


âœ… ì„¸ë²ˆì§¸ ì‹œë„, ìì‹ í…Œì´ë¸”ì— ì¡´ì¬í•˜ëŠ” ì™¸ë˜í‚¤ ì œê±°
ğŸ¤” 2288112 ê°œì˜ row ê°€ ìˆëŠ” í…Œì´ë¸”ì—ì„œ ì™¸ë˜í‚¤ ì œê±°í•˜ëŠ”ë° ì†Œìš”ë˜ëŠ” ì‹œê°„ì€?!


  ìì‹ row ì— ë³€ê²½ì‚¬í•­ ë•Œë¬¸ì— ë¶€ëª¨ rowê¹Œì§€ ê³µìœ ì ê¸ˆì´ ê±¸ë ¤ì„œ ë°ë“œë½ì´ ë°œìƒí•˜ê³  ìˆë‹¤. ê·¼ë³¸ì ì¸ ë¬¸ì œë¥¼ ì œê±°í•˜ë©´ ë˜ì§€ ì•Šì„ê¹Œ?
  ì™¸ë˜í‚¤ë¥¼ ì œê±°í•˜ëŠ” ë™ì•ˆ ì„œë¹„ìŠ¤ ì¤‘ë‹¨ì´ ìƒê¸¸ê¹Œ ê±±ì •ì´ ë˜ê¸°ë„ í•˜ê³ , ê¶ê¸ˆí•´ì„œ í•´ë³¸ í…ŒìŠ¤íŠ¸
54973 ê¸°ì¤€ 14 ms ì†Œìš”




  íŒ€ì—ì„œ ë…¼ì˜ í›„ì— ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ì—†ì´ fk í‚¤ë¥¼ ì œê±°í•˜ì˜€ê³ , ëª¨ë‹ˆí„°ë§ ê²°ê³¼ ì™¸ë˜í‚¤ ì œê±° í›„ì— ìì‹ í…Œì´ë¸”ì—ì„œ ë°œìƒí•˜ë˜ SQLTransactionRollbackException(ë°ë“œë½) ì€ DataIntegrityViolationException(ì¤‘ë³µí‚¤) ë¡œ ë°œìƒëœë‹¤.




ëª» í•´ì¹˜ì› ã„´â€¦
ì¸ë±ìŠ¤ê°€ ë‚  ê¸°ë‹¤ë¦¬ê³  ìˆì—ˆ..

ì •ë¦¬

  ì™¸ë˜í‚¤ê°€ ê±¸ë ¤ìˆëŠ” ê²½ìš°, ìì‹ rowì— ë³€ê²½ì´ ì¼ì–´ë‚˜ë©´ ë¶€ëª¨ rowì— ê³µìœ  ì ê¸ˆì´ ê±¸ë¦°ë‹¤.
  JPA ì¿¼ë¦¬ ì§€ì—°ì—ëŠ” ì‹¤í–‰ ìˆœì„œê°€ ìˆë‹¤.
  FK í‚¤ë¥¼ ì œê±°í•˜ëŠ”ë° ì†Œìš”ë˜ëŠ” ì‹œê°„ì€ ìƒê°ë³´ë‹¤ ì ë‹¤.


ê¸°ë¡ìš©

SHOW ENGINE innodb STATUS;
- SHOW ENGINE innodb STATUS;
  LOCK WAIT 4 lock struct(s), heap size 1128, 2 row lock(s), undo log entries 1
  *** (1) HOLDS THE LOCK(S):

  RECORD LOCKS space id 148 page no 4 n bits 72 index PRIMARY of table `jpa`.`parent` trx id 12534 lock mode S locks rec but not gap

  Record lock, heap no 2 PHYSICAL RECORD: n_fields 4; compact format; info bits 0

  *** (1) WAITING FOR THIS LOCK TO BE GRANTED:
  RECORD LOCKS space id 149 page no 5 n bits 72 index parent_id_unique of table `jpa`.`child` trx id 12534 lock mode S waiting
  Record lock, heap no 2 PHYSICAL RECORD: n_fields 2; compact format; info bits 0

  *** (2) TRANSACTION:

  TRANSACTION 12533, ACTIVE 13 sec starting index read

  mysql tables in use 1, locked 1

  LOCK WAIT 6 lock struct(s), heap size 1128, 3 row lock(s), undo log entries 1

  MySQL thread id 128, OS thread handle 6143324160, query id 12894 localhost 127.0.0.1 root updating

  /* ApplicationName=DataGrip 2022.3.2 */ UPDATE parent SET name = 'newParent' WHERE id = 1

  *** (2) HOLDS THE LOCK(S):
  RECORD LOCKS space id 149 page no 5 n bits 72 index parent_id_unique of table `jpa`.`child` trx id 12533 lock_mode X locks rec but not gap
  Record lock, heap no 2 PHYSICAL RECORD: n_fields 2; compact format; info bits 0

  *** (2) WAITING FOR THIS LOCK TO BE GRANTED:
  RECORD LOCKS space id 148 page no 4 n bits 72 index PRIMARY of table `jpa`.`parent` trx id 12533 lock_mode X locks rec but not gap waiting

  Record lock, heap no 2 PHYSICAL RECORD: n_fields 4; compact format; info bits 0


      
    </p>

  </div>
</a>

  
</div>

<div class="pagination">
  
  

  <span>1</span>
</div>

  </main>

  <footer>
  <a href="mailto:kkannu0407@gmail.com">
    <i class="far fa-envelope fa-fw"></i>
  </a>
  <a href="https://github.com/hocaron" target="_blank">
    <i class="fab fa-github fa-fw"></i>
  </a>
  <a href="https://www.linkedin.com/in/sunwoo-ho-86b45823a" target="_blank">
    <i class="fab fa-linkedin fa-fw"></i>
  </a>

  <br>
  <span>&copy; 2024 Hocaron</span>
</footer>

</div>
</body>
</html>
