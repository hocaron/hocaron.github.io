<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.3">Jekyll</generator><link href="https://hocaron.github.io/ko/feed.xml" rel="self" type="application/atom+xml" /><link href="https://hocaron.github.io/ko/" rel="alternate" type="text/html" /><updated>2024-05-19T07:37:10+00:00</updated><id>https://hocaron.github.io/feed.xml</id><title type="html">this.hocaron</title><subtitle>Minimal Jekyll theme for storytellers</subtitle><author><name>Hocaron</name><email>kkannu0407@gmail.com</email></author><entry xml:lang="ko"><title type="html">[Troubleshooting - DB] ì¸ë±ìŠ¤(Index)ì™€ ë°ë“œë½(DeadLock)</title><link href="https://hocaron.github.io/ko/dead-lock-by-index/" rel="alternate" type="text/html" title="[Troubleshooting - DB] ì¸ë±ìŠ¤(Index)ì™€ ë°ë“œë½(DeadLock)" /><published>2023-05-23T00:00:00+00:00</published><updated>2023-05-23T00:00:00+00:00</updated><id>https://hocaron.github.io/dead-lock-by-index</id><content type="html" xml:base="https://hocaron.github.io/dead-lock-by-index/"><![CDATA[<p><img src="https://velog.velcdn.com/images/haron/post/329afb75-8be4-47ed-ab19-cb087ec1a934/image.png" alt="" /></p>

<p>ì—­ì‹œ <a href="https://velog.io/@haron/%EC%99%B8%EB%9E%98%ED%82%A4Foreign-Key%EC%99%80-%EB%8D%B0%EB%93%9C%EB%9D%BDDeadLock-%EA%B7%B8%EB%A6%AC%EA%B3%A0-%EC%BF%BC%EB%A6%AC-%EC%A7%80%EC%97%B0-%EC%8B%A4%ED%96%89-eruedsy4">í•´ì¹˜ì› ë‚˜</a>ë¥¼ ì™¸ì¹˜ë©´ ì•ˆ ë˜ëŠ” ê²ƒì¸ê°€â€¦ ë˜ ìš¸ê¸° ì‹œì‘í•œ í˜í˜â€¦ (ê·¸ë§Œ ìš¸ì–´ì‡!)
ì˜ë¯¸ìˆëŠ” ê²½í—˜ìœ¼ë¡œ ë‚¨ê¸°ê¸°ìœ„í•´ ê¸°ë¡í•´ë³´ì.
<img src="https://velog.velcdn.com/images/haron/post/1687c152-873d-425f-96f9-174735a9c262/image.png" alt="" /></p>

<h2 id="ë°ë“œë½ì´-ë°œìƒí•˜ëŠ”-ìƒí™©-ë‹¤ì‹œ-ì¬í˜„">ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ìƒí™© ë‹¤ì‹œ ì¬í˜„</h2>

<h3 id="í˜„ì¬-í…Œì´ë¸”-ìƒíƒœ">í˜„ì¬ í…Œì´ë¸” ìƒíƒœ</h3>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">parent</span>
<span class="p">(</span>
    <span class="n">id</span>             <span class="nb">bigint</span>        <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">name</span>           <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>  <span class="k">null</span><span class="p">,</span>
    <span class="n">updated_at</span>     <span class="nb">datetime</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>   <span class="k">null</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">child</span>
<span class="p">(</span>
    <span class="n">id</span>           <span class="nb">bigint</span>          <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">name</span>         <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>    <span class="k">null</span><span class="p">,</span>
    <span class="n">parent_id</span>    <span class="nb">bigint</span>          <span class="k">null</span><span class="p">,</span>
    <span class="k">CONSTRAINT</span> <span class="n">parent_id_unique</span> <span class="k">UNIQUE</span> <span class="p">(</span><span class="n">parent_id</span><span class="p">)</span>
<span class="p">);</span>


<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">child_index</span>
<span class="p">(</span>
    <span class="n">id</span>           <span class="nb">bigint</span>          <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">name</span>         <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>    <span class="k">null</span><span class="p">,</span>
    <span class="n">parent_id</span>    <span class="nb">bigint</span>          <span class="k">null</span><span class="p">,</span>
<span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">parent_id</span> <span class="k">ON</span> <span class="n">child_index</span> <span class="p">(</span><span class="n">parent_id</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">parent</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'parent_1'</span><span class="p">,</span> <span class="n">NOW</span><span class="p">());</span>
</code></pre></div></div>
<ol>
  <li>parent í…Œì´ë¸”ì˜ idë¥¼ indexë¡œ ê°€ì§€ê³  ìˆëŠ” child_index í…Œì´ë¸” ìƒì„±(ì™¸ë˜í‚¤ëŠ” ìš´ì˜ì—ì„œ ì‚­ì œë˜ì–´ì„œ í…ŒìŠ¤íŠ¸ì‹œ ê³ ë ¤í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤)</li>
  <li>parent í…Œì´ë¸”ì˜ idë¥¼ ìœ ë‹ˆí¬ í‚¤ë¡œ ê°€ì§€ê³  ìˆëŠ” child í…Œì´ë¸” ìƒì„±(ë§ˆì°¬ê°€ì§€ë¡œ ì™¸ë˜í‚¤ ê³ ë ¤í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)</li>
  <li>parent í…Œì´ë¸”ì— í…ŒìŠ¤íŠ¸ ë°ì´í„° ì ì¬</li>
</ol>

<h3 id="ê·¸ëŸ¼-ì´ì œ-ë°ë“œë½ì„-ë°œìƒì‹œì¼œ-ë³´ì">ê·¸ëŸ¼ ì´ì œ ë°ë“œë½ì„ ë°œìƒì‹œì¼œ ë³´ì</h3>
<h3 id="index-ê±¸ë ¤ìˆëŠ”-row-delete---index-ê±¸ë ¤ìˆëŠ”-ìì‹-row-insertê°€-ë‘ê°œì˜-ì„¸ì…˜ì—ì„œ-ìˆ˜í–‰ë˜ë©´-ë°ë“œë½ì´-ë°œìƒ-">index ê±¸ë ¤ìˆëŠ” row delete â†’  index ê±¸ë ¤ìˆëŠ” ìì‹ row insertê°€ ë‘ê°œì˜ ì„¸ì…˜ì—ì„œ ìˆ˜í–‰ë˜ë©´, ë°ë“œë½ì´ ë°œìƒ ğŸ’£</h3>
<p><img src="https://velog.velcdn.com/images/haron/post/bc47166e-b1b7-4f30-ac1f-09932cb38ff7/image.png" alt="" /></p>

<table>
  <thead>
    <tr>
      <th>TX1</th>
      <th>TX2</th>
      <th>lock</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>BEGIN ;  <br /> DELETE FROM child_index WHERE parent_id = 2;</td>
      <td>Â </td>
      <td>(1) child X Lock ì¸ë°, TX2ì—ì„œ X Lock íšë“ ê°€ëŠ¥í• ê¹Œ ğŸ¤”</td>
    </tr>
    <tr>
      <td>Â </td>
      <td>BEGIN ;  <br /> DELETE FROM child_index WHERE parent_id = 2;</td>
      <td>(2) child X Lock</td>
    </tr>
    <tr>
      <td>INSERT INTO child_index VALUES (â€˜1â€™, â€˜name2â€™, 2);</td>
      <td>Â </td>
      <td>(3) child X,INSERT_INTENTION Lock ëŒ€ê¸°</td>
    </tr>
    <tr>
      <td>Â </td>
      <td>INSERT INTO child_index VALUES (â€˜2â€™, â€˜name2â€™, 2);</td>
      <td>(4) child X,INSERT_INTENTION Lock ëŒ€ê¸°</td>
    </tr>
    <tr>
      <td>Â </td>
      <td>Deadlock found when trying to get lock; try restarting transaction</td>
      <td>(4) child X lock ì´ í•„ìš”í•˜ì§€ë§Œ, (2) ì—ì„œ child X lock ìƒíƒœ <br /> (4) í•´ì†Œë¥¼ ìœ„í•´ì„œ (3) í•´ì†Œ í•„ìš” <br /> -&gt; (3) í•´ì†Œ ìœ„í•´ì„œ TX2 ì»¤ë°‹ í•„ìš” <br /> -&gt; TX2 ì»¤ë°‹í•˜ë ¤ë©´ (4) í•´ì†Œ í•„ìš” <br /> -&gt; ë°ë“œë½ ë°œìƒ</td>
    </tr>
  </tbody>
</table>

<h2 id="ìš´ì˜í™˜ê²½ì—ì„œ-ë°ë“œë½ì´-ë°œìƒí•˜ëŠ”-ë¡œì§ì„-ì‚´í´ë³´ì">ìš´ì˜í™˜ê²½ì—ì„œ ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ë¡œì§ì„ ì‚´í´ë³´ì</h2>

<h3 id="index-ê±¸ë ¤ìˆëŠ”-row-delete---index-ê±¸ë ¤ìˆëŠ”-ìì‹-row-insertê°€-ë‘ê°œì˜-ì„¸ì…˜ì—ì„œ-ìˆ˜í–‰ë˜ë©´-ë°ë“œë½ì´-ë°œìƒ--1">index ê±¸ë ¤ìˆëŠ” row delete â†’  index ê±¸ë ¤ìˆëŠ” ìì‹ row insertê°€ ë‘ê°œì˜ ì„¸ì…˜ì—ì„œ ìˆ˜í–‰ë˜ë©´, ë°ë“œë½ì´ ë°œìƒ ğŸ’£</h3>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">parent</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">child</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'child_1'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">child_index</span> <span class="k">WHERE</span> <span class="n">parent_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">child_index</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'child_index_1'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">UPDATE</span> <span class="n">parent</span> <span class="k">SET</span>  <span class="n">updated_at</span> <span class="o">=</span> <span class="n">NOW</span><span class="p">()</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nd">@Transactional</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createChildAndChildIndex</span> <span class="o">(</span><span class="kt">long</span> <span class="n">parentId</span><span class="o">)</span> <span class="o">{</span>

    <span class="kt">var</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">parentRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">parentId</span><span class="o">);</span>
    
    <span class="n">childIndexRepository</span><span class="o">.</span><span class="na">deleteByParent</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
    <span class="n">childIndexRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="n">Child_Index</span><span class="o">(</span><span class="err">'</span><span class="n">child_index_1</span><span class="err">'</span><span class="o">,</span> <span class="n">parent</span><span class="o">));</span>

  <span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>í•œê°€ì§€ ì‹ ê¸°í•œ ì ì€ delete í•˜ë ¤ëŠ” ë°ì´í„°ê°€ ì—†ì„ ë•Œ, ë°ë“œë½ì´ ë°œìƒí•œë‹¤.</li>
  <li>delete í•˜ë ¤ëŠ” ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ì—ëŠ” ê°™ì€ ë¡œì§ì„ ìˆ˜í–‰í•˜ë©´ ë½ì„ ì¡ì„ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê²Œ ëœë‹¤.</li>
</ul>

<h2 id="ì›ì¸ì€-ì•Œì•˜ê³ -ì„œë²„ì—ì„œ-ë°ë“œë½ì„-í•´ê²°í• -ìˆ˜-ìˆëŠ”-ë°©ë²•ì„-ê³ ë¯¼í•´ë³´ì">ì›ì¸ì€ ì•Œì•˜ê³ , ì„œë²„ì—ì„œ ë°ë“œë½ì„ í•´ê²°í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ê³ ë¯¼í•´ë³´ì</h2>
<h3 id="-ì²«ë²ˆì§¸-ì‹œë„-ì¡´ì¬í•˜ëŠ”-ê²½ìš°ì—ë§Œ-row-ì‚­ì œ">â ì²«ë²ˆì§¸ ì‹œë„, ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ row ì‚­ì œ</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nd">@Transactional</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createParent</span> <span class="o">(</span><span class="kt">long</span> <span class="n">parentId</span><span class="o">)</span> <span class="o">{</span>

    <span class="kt">var</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">parentRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">parentId</span><span class="o">);</span>
    
    <span class="k">if</span><span class="o">(</span><span class="n">childIndexRepository</span><span class="o">.</span><span class="na">findByParent</span><span class="o">(</span><span class="n">parent</span><span class="o">).</span><span class="na">isPresent</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">childIndexRepository</span><span class="o">.</span><span class="na">deleteByParent</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">childIndexRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="n">Child_Index</span><span class="o">(</span><span class="err">'</span><span class="n">child_index_1</span><span class="err">'</span><span class="o">,</span> <span class="n">parent</span><span class="o">));</span>
  <span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>ë¬´ì¡°ê±´ delete í•˜ëŠ” ë¡œì§ìœ¼ë¡œ ì¸í•œ ë°°íƒ€ë½ì€ ë°©ì§€ ê°€ëŠ¥í•˜ë‹¤.</li>
  <li>ë™ì‹œ ìš”ì²­ì‹œì— childIndexRepository.findByParent ì— ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ë¡œ ë¶„ê¸°ì²˜ë¦¬ë˜ëŠ” ê²½ìš°, ë°ì´í„°ê°€ 2ë°°ë¡œ ì ì¬ë  ìˆ˜ ìˆë‹¤.
    <ul>
      <li>300ms ë¡œ ì“°ë ˆë“œ sleep() ê±¸ì–´ì„œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ 2ë°°ë¡œ ìŒ“ì´ëŠ” ê²ƒì„ í™•ì¸</li>
    </ul>
  </li>
</ul>

<h3 id="-ë‘ë²ˆì§¸-ì‹œë„-ì¡´ì¬í•˜ëŠ”-ê²½ìš°ì—ë§Œ-row-ì‚­ì œí•˜ë©´ì„œ-ìœ ë‹ˆí¬-ì¡°ê±´-ì¶”ê°€">âœ… ë‘ë²ˆì§¸ ì‹œë„, ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ row ì‚­ì œí•˜ë©´ì„œ ìœ ë‹ˆí¬ ì¡°ê±´ ì¶”ê°€</h3>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">child_index</span>
<span class="p">(</span>
    <span class="n">id</span>           <span class="nb">bigint</span>          <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">name</span>         <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>    <span class="k">null</span><span class="p">,</span>
    <span class="n">parent_id</span>    <span class="nb">bigint</span>          <span class="k">null</span><span class="p">,</span>
    <span class="k">CONSTRAINT</span> <span class="n">parent_id_unique</span> <span class="k">UNIQUE</span> <span class="p">(</span><span class="n">parent_id</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">parent_id</span> <span class="k">ON</span> <span class="n">child_index</span> <span class="p">(</span><span class="n">parent_id</span><span class="p">);</span>
</code></pre></div></div>
<ul>
  <li>ë™ì‹œ ìš”ì²­ì‹œì— childIndexRepository.findByParent ì— ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ë¡œ ë¶„ê¸°ì²˜ë¦¬ë˜ëŠ” ê²½ìš°, í›„ì— ì»¤ë°‹ë˜ì–´ ì ì¬ëœ ë°ì´í„°ëŠ” ì¤‘ë³µí‚¤ ì—ëŸ¬ ì²˜ë¦¬ëœë‹¤.</li>
</ul>

<h3 id="-ì„¸ë²ˆì§¸-ì‹œë„-redis-ì—-ë™ì‹œì„±-ì œì–´ë¥¼-ìœ„í•œ-í‚¤-ì¶”ê°€">â ì„¸ë²ˆì§¸ ì‹œë„, Redis ì— ë™ì‹œì„± ì œì–´ë¥¼ ìœ„í•œ í‚¤ ì¶”ê°€</h3>
<ul>
  <li>ê°„í—ì ì¸ ë°ë“œë½ì´ê³ , ìœ„ ì„œë¹„ìŠ¤ì—ì„œ Redisë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ ìºì‹œ ë¦¬ì†ŒìŠ¤ê°€ ë” í´ ê²ƒ ê°™ì•„ ë‚˜ê°€ë¦¬!</li>
</ul>

<h3 id="-ë„¤ë²ˆì§¸-ì‹œë„-ìš”ì²­-ì œí•œ">â ë„¤ë²ˆì§¸ ì‹œë„, ìš”ì²­ ì œí•œ</h3>
<ul>
  <li>Bucket4jë¥¼ ì´ìš©í•´ì„œ í´ë¼ì´ì–¸íŠ¸ê°€ íŠ¹ì • ì‹œê°„ í”„ë ˆì„ ë‚´ì— ë§Œë“¤ ìˆ˜ ìˆëŠ” API í˜¸ì¶œ ìˆ˜ë¥¼ ì œí•œí•œë‹¤.</li>
  <li>ìœ„ ì„œë¹„ìŠ¤ëŠ” ì„œë²„ê°€ ì—¬ëŸ¬ëŒ€ì¸ ê²½ìš°ë¼ì„œ ë‹¤ë¥¸ ì„œë²„ë¡œ ë™ì‹œ ìš”ì²­ì´ ë“¤ì–´ê°€ëŠ” ê²½ìš°, ë°ë“œë½ ë°©ì§€ ë¶ˆê°€ëŠ¥</li>
</ul>

<h2 id="ì •ë¦¬">ì •ë¦¬</h2>
<ol>
  <li>ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°, ì‚­ì œ ì¿¼ë¦¬ë¥¼ ë‚ ë¦¬ë©´ delete, select ëŠ” ê°€ëŠ¥í•˜ì§€ë§Œ insert ì‹œì— ë½ì„ ê¸°ë‹¤ë¦¬ê²Œ ëœë‹¤.</li>
  <li>ë½ì´ ê¶ê¸ˆí•˜ë‹¤ë©´, <a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html#innodb-record-locks">MySQL ê³µì‹ë¬¸ì„œ ì¤‘ InnoDB Lock ë©”ë‰´ì–¼</a>ì„ ì°¸ê³ í•´ë³´ì. (ì˜ˆì œì™€ í•¨ê»˜ ì •ë¦¬ê°€ ë„ˆë¬´ ì˜ ë˜ì–´ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.)</li>
</ol>

<h3 id="í¥ë¯¸ë¡œìš´-ì‹¤í—˜">í¥ë¯¸ë¡œìš´ ì‹¤í—˜</h3>
<h4 id="ì¸ë±ìŠ¤ê°€-ê±¸ë¦°-ì»¬ëŸ¼-ê¸°ì¤€ìœ¼ë¡œ-ì¿¼ë¦¬">ì¸ë±ìŠ¤ê°€ ê±¸ë¦° ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ì¿¼ë¦¬</h4>
<ul>
  <li>ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ì—ëŠ”, 2ë²ˆì§¸ íŠ¸ëœì­ì…˜ì—ì„œ delete ì‹œì— ë½ íšë“ì„ ê¸°ë‹¤ë¦°ë‹¤.
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">BEGIN</span> <span class="p">;</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">child_index</span> <span class="k">WHERE</span> <span class="n">parent_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">child_index</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'child_index_1'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">COMMIT</span> <span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ì—ëŠ”, 2ë²ˆì§¸ íŠ¸ëœì­ì…˜ì—ì„œ delete ì‹œì— ë½ íšë“ì´ ë°”ë¡œ ê°€ëŠ¥í•˜ë‹¤.
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">BEGIN</span> <span class="p">;</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">child_index</span> <span class="k">WHERE</span> <span class="n">parent_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">child_index</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'child_index_1'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">COMMIT</span> <span class="p">;</span>
</code></pre></div>    </div>
    <h4 id="ì¸ë±ìŠ¤ê°€-ê±¸ë¦¬ì§€-ì•Šì€-ì»¬ëŸ¼-ê¸°ì¤€ìœ¼ë¡œ-ì¿¼ë¦¬">ì¸ë±ìŠ¤ê°€ ê±¸ë¦¬ì§€ ì•Šì€ ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ì¿¼ë¦¬</h4>
  </li>
  <li>ë°ì´í„°ê°€ ìˆëŠ” / ì—†ëŠ” ê²½ìš°, 2ë²ˆì§¸ íŠ¸ëœì­ì…˜ì—ì„œ delete ì‹œì— ë½ íšë“ì„ ê¸°ë‹¤ë¦°ë‹¤.
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">BEGIN</span> <span class="p">;</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">child_index</span> <span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">'child_index_2'</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">child_index</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'child_index_1'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">COMMIT</span> <span class="p">;</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="ê¸°ë¡ìš©">ê¸°ë¡ìš©</h3>
<details>
<summary>SHOW ENGINE innodb STATUS;</summary>
  *** (1) TRANSACTION:TRANSACTION 13034, ACTIVE 6 sec insertingmysql tables in use 1, locked 1LOCK WAIT 4 lock struct(s), heap size 1128, 3 row lock(s), undo log entries 1MySQL thread id 280, OS thread handle 6136639488, query id 21716 localhost 127.0.0.1 root update/* ApplicationName=DataGrip 2022.3.2 */ insert into child values ('2', 'name2', 2)

*** (1) HOLDS THE LOCK(S):RECORD LOCKS space id 154 page no 4 n bits 72 index PRIMARY of table jpa.child trx id 13034 lock_mode X locks rec but not gapRecord lock, heap no 3 PHYSICAL RECORD: n_fields 5; compact format; info bits 0

*** (1) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 154 page no 5 n bits 72 index parent_id of table jpa.child trx id 13034 lock_mode X insert intention waitingRecord lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0

*** (2) TRANSACTION:TRANSACTION 13035, ACTIVE 4 sec insertingmysql tables in use 1, locked 1LOCK WAIT 3 lock struct(s), heap size 1128, 2 row lock(s)MySQL thread id 281, OS thread handle 6135525376, query id 21726 localhost 127.0.0.1 root update/* ApplicationName=DataGrip 2022.3.2 */ insert into child values ('2', 'name2', 2)

*** (2) HOLDS THE LOCK(S):RECORD LOCKS space id 154 page no 5 n bits 72 index parent_id of table jpa.child trx id 13035 lock_mode XRecord lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0

*** (2) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 154 page no 4 n bits 72 index PRIMARY of table jpa.child trx id 13035 lock mode S locks rec but not gap waitingRecord lock, heap no 3 PHYSICAL RECORD: n_fields 5; compact format; info bits 0

- SELECT * FROM performance_schema.data_locks;

| INDEX\_NAME | OBJECT\_INSTANCE\_BEGIN | LOCK\_TYPE | LOCK\_MODE | LOCK\_STATUS | LOCK\_DATA |
| :--- | :--- | :--- | :--- | :--- | :--- |
| null | 4813003272 | TABLE | IX | GRANTED | null |
| parent\_id | 4823656472 | RECORD | X | GRANTED | supremum pseudo-record |
| parent\_id | 4823656816 | RECORD | X,INSERT\_INTENTION | GRANTED | supremum pseudo-record |
| parent\_id | 4823657160 | RECORD | X,GAP | GRANTED | 1, 1 |
</details>]]></content><author><name>Hocaron</name><email>kkannu0407@gmail.com</email></author><category term="Troubleshooting" /><summary type="html"><![CDATA[ì—­ì‹œ í•´ì¹˜ì› ë‚˜ë¥¼ ì™¸ì¹˜ë©´ ì•ˆ ë˜ëŠ” ê²ƒì¸ê°€â€¦ ë˜ ìš¸ê¸° ì‹œì‘í•œ í˜í˜â€¦ (ê·¸ë§Œ ìš¸ì–´ì‡!) ì˜ë¯¸ìˆëŠ” ê²½í—˜ìœ¼ë¡œ ë‚¨ê¸°ê¸°ìœ„í•´ ê¸°ë¡í•´ë³´ì. ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ìƒí™© ë‹¤ì‹œ ì¬í˜„ í˜„ì¬ í…Œì´ë¸” ìƒíƒœ CREATE TABLE parent ( id bigint not null primary key, name varchar(255) null, updated_at datetime(6) null ); CREATE TABLE child ( id bigint not null primary key, name varchar(255) null, parent_id bigint null, CONSTRAINT parent_id_unique UNIQUE (parent_id) ); CREATE TABLE child_index ( id bigint not null primary key, name varchar(255) null, parent_id bigint null, ); CREATE INDEX parent_id ON child_index (parent_id); INSERT INTO parent VALUES (1, 'parent_1', NOW()); parent í…Œì´ë¸”ì˜ idë¥¼ indexë¡œ ê°€ì§€ê³  ìˆëŠ” child_index í…Œì´ë¸” ìƒì„±(ì™¸ë˜í‚¤ëŠ” ìš´ì˜ì—ì„œ ì‚­ì œë˜ì–´ì„œ í…ŒìŠ¤íŠ¸ì‹œ ê³ ë ¤í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤) parent í…Œì´ë¸”ì˜ idë¥¼ ìœ ë‹ˆí¬ í‚¤ë¡œ ê°€ì§€ê³  ìˆëŠ” child í…Œì´ë¸” ìƒì„±(ë§ˆì°¬ê°€ì§€ë¡œ ì™¸ë˜í‚¤ ê³ ë ¤í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.) parent í…Œì´ë¸”ì— í…ŒìŠ¤íŠ¸ ë°ì´í„° ì ì¬ ê·¸ëŸ¼ ì´ì œ ë°ë“œë½ì„ ë°œìƒì‹œì¼œ ë³´ì index ê±¸ë ¤ìˆëŠ” row delete â†’ index ê±¸ë ¤ìˆëŠ” ìì‹ row insertê°€ ë‘ê°œì˜ ì„¸ì…˜ì—ì„œ ìˆ˜í–‰ë˜ë©´, ë°ë“œë½ì´ ë°œìƒ ğŸ’£ TX1 TX2 lock BEGIN ; DELETE FROM child_index WHERE parent_id = 2; Â  (1) child X Lock ì¸ë°, TX2ì—ì„œ X Lock íšë“ ê°€ëŠ¥í• ê¹Œ ğŸ¤” Â  BEGIN ; DELETE FROM child_index WHERE parent_id = 2; (2) child X Lock INSERT INTO child_index VALUES (â€˜1â€™, â€˜name2â€™, 2); Â  (3) child X,INSERT_INTENTION Lock ëŒ€ê¸° Â  INSERT INTO child_index VALUES (â€˜2â€™, â€˜name2â€™, 2); (4) child X,INSERT_INTENTION Lock ëŒ€ê¸° Â  Deadlock found when trying to get lock; try restarting transaction (4) child X lock ì´ í•„ìš”í•˜ì§€ë§Œ, (2) ì—ì„œ child X lock ìƒíƒœ (4) í•´ì†Œë¥¼ ìœ„í•´ì„œ (3) í•´ì†Œ í•„ìš” -&gt; (3) í•´ì†Œ ìœ„í•´ì„œ TX2 ì»¤ë°‹ í•„ìš” -&gt; TX2 ì»¤ë°‹í•˜ë ¤ë©´ (4) í•´ì†Œ í•„ìš” -&gt; ë°ë“œë½ ë°œìƒ ìš´ì˜í™˜ê²½ì—ì„œ ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ë¡œì§ì„ ì‚´í´ë³´ì index ê±¸ë ¤ìˆëŠ” row delete â†’ index ê±¸ë ¤ìˆëŠ” ìì‹ row insertê°€ ë‘ê°œì˜ ì„¸ì…˜ì—ì„œ ìˆ˜í–‰ë˜ë©´, ë°ë“œë½ì´ ë°œìƒ ğŸ’£ SELECT * from parent WHERE id = 1; INSERT INTO child VALUES (1, 'child_1', 1); DELETE FROM child_index WHERE parent_id = 1; INSERT INTO child_index VALUES (1, 'child_index_1', 1); UPDATE parent SET updated_at = NOW() WHERE id = 1; @Transactional public void createChildAndChildIndex (long parentId) { var parent = parentRepository.findById(parentId); childIndexRepository.deleteByParent(parent); childIndexRepository.save(new Child_Index('child_index_1', parent)); } í•œê°€ì§€ ì‹ ê¸°í•œ ì ì€ delete í•˜ë ¤ëŠ” ë°ì´í„°ê°€ ì—†ì„ ë•Œ, ë°ë“œë½ì´ ë°œìƒí•œë‹¤. delete í•˜ë ¤ëŠ” ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ì—ëŠ” ê°™ì€ ë¡œì§ì„ ìˆ˜í–‰í•˜ë©´ ë½ì„ ì¡ì„ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê²Œ ëœë‹¤. ì›ì¸ì€ ì•Œì•˜ê³ , ì„œë²„ì—ì„œ ë°ë“œë½ì„ í•´ê²°í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ê³ ë¯¼í•´ë³´ì â ì²«ë²ˆì§¸ ì‹œë„, ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ row ì‚­ì œ @Transactional public void createParent (long parentId) { var parent = parentRepository.findById(parentId); if(childIndexRepository.findByParent(parent).isPresent()) { childIndexRepository.deleteByParent(parent); } childIndexRepository.save(new Child_Index('child_index_1', parent)); } ë¬´ì¡°ê±´ delete í•˜ëŠ” ë¡œì§ìœ¼ë¡œ ì¸í•œ ë°°íƒ€ë½ì€ ë°©ì§€ ê°€ëŠ¥í•˜ë‹¤. ë™ì‹œ ìš”ì²­ì‹œì— childIndexRepository.findByParent ì— ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ë¡œ ë¶„ê¸°ì²˜ë¦¬ë˜ëŠ” ê²½ìš°, ë°ì´í„°ê°€ 2ë°°ë¡œ ì ì¬ë  ìˆ˜ ìˆë‹¤. 300ms ë¡œ ì“°ë ˆë“œ sleep() ê±¸ì–´ì„œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ 2ë°°ë¡œ ìŒ“ì´ëŠ” ê²ƒì„ í™•ì¸ âœ… ë‘ë²ˆì§¸ ì‹œë„, ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ row ì‚­ì œí•˜ë©´ì„œ ìœ ë‹ˆí¬ ì¡°ê±´ ì¶”ê°€ CREATE TABLE child_index ( id bigint not null primary key, name varchar(255) null, parent_id bigint null, CONSTRAINT parent_id_unique UNIQUE (parent_id) ); CREATE INDEX parent_id ON child_index (parent_id); ë™ì‹œ ìš”ì²­ì‹œì— childIndexRepository.findByParent ì— ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ë¡œ ë¶„ê¸°ì²˜ë¦¬ë˜ëŠ” ê²½ìš°, í›„ì— ì»¤ë°‹ë˜ì–´ ì ì¬ëœ ë°ì´í„°ëŠ” ì¤‘ë³µí‚¤ ì—ëŸ¬ ì²˜ë¦¬ëœë‹¤. â ì„¸ë²ˆì§¸ ì‹œë„, Redis ì— ë™ì‹œì„± ì œì–´ë¥¼ ìœ„í•œ í‚¤ ì¶”ê°€ ê°„í—ì ì¸ ë°ë“œë½ì´ê³ , ìœ„ ì„œë¹„ìŠ¤ì—ì„œ Redisë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ ìºì‹œ ë¦¬ì†ŒìŠ¤ê°€ ë” í´ ê²ƒ ê°™ì•„ ë‚˜ê°€ë¦¬! â ë„¤ë²ˆì§¸ ì‹œë„, ìš”ì²­ ì œí•œ Bucket4jë¥¼ ì´ìš©í•´ì„œ í´ë¼ì´ì–¸íŠ¸ê°€ íŠ¹ì • ì‹œê°„ í”„ë ˆì„ ë‚´ì— ë§Œë“¤ ìˆ˜ ìˆëŠ” API í˜¸ì¶œ ìˆ˜ë¥¼ ì œí•œí•œë‹¤. ìœ„ ì„œë¹„ìŠ¤ëŠ” ì„œë²„ê°€ ì—¬ëŸ¬ëŒ€ì¸ ê²½ìš°ë¼ì„œ ë‹¤ë¥¸ ì„œë²„ë¡œ ë™ì‹œ ìš”ì²­ì´ ë“¤ì–´ê°€ëŠ” ê²½ìš°, ë°ë“œë½ ë°©ì§€ ë¶ˆê°€ëŠ¥ ì •ë¦¬ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°, ì‚­ì œ ì¿¼ë¦¬ë¥¼ ë‚ ë¦¬ë©´ delete, select ëŠ” ê°€ëŠ¥í•˜ì§€ë§Œ insert ì‹œì— ë½ì„ ê¸°ë‹¤ë¦¬ê²Œ ëœë‹¤. ë½ì´ ê¶ê¸ˆí•˜ë‹¤ë©´, MySQL ê³µì‹ë¬¸ì„œ ì¤‘ InnoDB Lock ë©”ë‰´ì–¼ì„ ì°¸ê³ í•´ë³´ì. (ì˜ˆì œì™€ í•¨ê»˜ ì •ë¦¬ê°€ ë„ˆë¬´ ì˜ ë˜ì–´ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.) í¥ë¯¸ë¡œìš´ ì‹¤í—˜ ì¸ë±ìŠ¤ê°€ ê±¸ë¦° ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ì¿¼ë¦¬ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ì—ëŠ”, 2ë²ˆì§¸ íŠ¸ëœì­ì…˜ì—ì„œ delete ì‹œì— ë½ íšë“ì„ ê¸°ë‹¤ë¦°ë‹¤. BEGIN ; DELETE FROM child_index WHERE parent_id = 1; INSERT INTO child_index VALUES (1, 'child_index_1', 1); COMMIT ; ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ì—ëŠ”, 2ë²ˆì§¸ íŠ¸ëœì­ì…˜ì—ì„œ delete ì‹œì— ë½ íšë“ì´ ë°”ë¡œ ê°€ëŠ¥í•˜ë‹¤. BEGIN ; DELETE FROM child_index WHERE parent_id = 1; INSERT INTO child_index VALUES (1, 'child_index_1', 1); COMMIT ; ì¸ë±ìŠ¤ê°€ ê±¸ë¦¬ì§€ ì•Šì€ ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ì¿¼ë¦¬ ë°ì´í„°ê°€ ìˆëŠ” / ì—†ëŠ” ê²½ìš°, 2ë²ˆì§¸ íŠ¸ëœì­ì…˜ì—ì„œ delete ì‹œì— ë½ íšë“ì„ ê¸°ë‹¤ë¦°ë‹¤. BEGIN ; DELETE FROM child_index WHERE name = 'child_index_2'; INSERT INTO child_index VALUES (1, 'child_index_1', 1); COMMIT ; ê¸°ë¡ìš© SHOW ENGINE innodb STATUS; *** (1) TRANSACTION:TRANSACTION 13034, ACTIVE 6 sec insertingmysql tables in use 1, locked 1LOCK WAIT 4 lock struct(s), heap size 1128, 3 row lock(s), undo log entries 1MySQL thread id 280, OS thread handle 6136639488, query id 21716 localhost 127.0.0.1 root update/* ApplicationName=DataGrip 2022.3.2 */ insert into child values ('2', 'name2', 2) *** (1) HOLDS THE LOCK(S):RECORD LOCKS space id 154 page no 4 n bits 72 index PRIMARY of table jpa.child trx id 13034 lock_mode X locks rec but not gapRecord lock, heap no 3 PHYSICAL RECORD: n_fields 5; compact format; info bits 0 *** (1) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 154 page no 5 n bits 72 index parent_id of table jpa.child trx id 13034 lock_mode X insert intention waitingRecord lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0 *** (2) TRANSACTION:TRANSACTION 13035, ACTIVE 4 sec insertingmysql tables in use 1, locked 1LOCK WAIT 3 lock struct(s), heap size 1128, 2 row lock(s)MySQL thread id 281, OS thread handle 6135525376, query id 21726 localhost 127.0.0.1 root update/* ApplicationName=DataGrip 2022.3.2 */ insert into child values ('2', 'name2', 2) *** (2) HOLDS THE LOCK(S):RECORD LOCKS space id 154 page no 5 n bits 72 index parent_id of table jpa.child trx id 13035 lock_mode XRecord lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0 *** (2) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 154 page no 4 n bits 72 index PRIMARY of table jpa.child trx id 13035 lock mode S locks rec but not gap waitingRecord lock, heap no 3 PHYSICAL RECORD: n_fields 5; compact format; info bits 0 - SELECT * FROM performance_schema.data_locks; | INDEX\_NAME | OBJECT\_INSTANCE\_BEGIN | LOCK\_TYPE | LOCK\_MODE | LOCK\_STATUS | LOCK\_DATA | | :--- | :--- | :--- | :--- | :--- | :--- | | null | 4813003272 | TABLE | IX | GRANTED | null | | parent\_id | 4823656472 | RECORD | X | GRANTED | supremum pseudo-record | | parent\_id | 4823656816 | RECORD | X,INSERT\_INTENTION | GRANTED | supremum pseudo-record | | parent\_id | 4823657160 | RECORD | X,GAP | GRANTED | 1, 1 |]]></summary></entry><entry xml:lang="ko"><title type="html">[Troubleshooting - DB] ì™¸ë˜í‚¤(Foreign Key)ì™€ ë°ë“œë½(DeadLock) ê·¸ë¦¬ê³  ì¿¼ë¦¬ ì§€ì—° ì‹¤í–‰</title><link href="https://hocaron.github.io/ko/dead-lock-by-fk/" rel="alternate" type="text/html" title="[Troubleshooting - DB] ì™¸ë˜í‚¤(Foreign Key)ì™€ ë°ë“œë½(DeadLock) ê·¸ë¦¬ê³  ì¿¼ë¦¬ ì§€ì—° ì‹¤í–‰" /><published>2023-05-22T00:00:00+00:00</published><updated>2023-05-22T00:00:00+00:00</updated><id>https://hocaron.github.io/dead-lock-by-fk</id><content type="html" xml:base="https://hocaron.github.io/dead-lock-by-fk/"><![CDATA[<p><img src="https://velog.velcdn.com/images/haron/post/b3f75582-672b-43ae-9972-b5fc8e5a1cc9/image.png" alt="" />
ë°ë“œë½ì´ ë°œìƒí•  ë•Œë§ˆë‹¤, í˜í˜ê°€ ìš¸ê³  ìˆë‹¤ğŸ˜¢ ê°„í—ì ìœ¼ë¡œ ë°œìƒí•˜ë˜ ë°ë“œë½ì˜ ì›ì¸ì„ ë¶„ì„í•˜ê³ , í•´ê²° ê³¼ì •ì„ ê¸°ë¡í•´ë³´ì.</p>

<h2 id="ì™¸ë˜í‚¤foreign-keyì™€-ë°ë“œë½deadlock">ì™¸ë˜í‚¤(Foreign Key)ì™€ ë°ë“œë½(DeadLock)</h2>
<p><strong>ë°ë“œë½</strong>ì´ë€, ë‘˜ ì´ìƒì˜ í”„ë¡œì„¸ìŠ¤ê°€ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ê°€ ì ìœ í•˜ê³  ìˆëŠ” ìì›ì„ ì„œë¡œ ê¸°ë‹¤ë¦´ ë•Œ ë¬´í•œ ëŒ€ê¸°ì— ë¹ ì§€ëŠ” ìƒí™©ì´ë‹¤.<br />
<img src="https://velog.velcdn.com/images/haron/post/33d1e1aa-b838-40e9-bbbd-af4480a0d5fe/image.png" alt="" /><br />
P1ì€ P2ê°€ ê°€ì§€ê³  ìˆëŠ” ìì›ì´ í•´ì œ ë˜ê¸¸ ê¸°ë‹¤ë¦¬ê³ , P2ëŠ” P3ì´ ê°€ì§„ ìì›, ê·¸ ë‹¤ìŒ..ê³¼ ê°™ì€ í˜•ì‹ìœ¼ë¡œ ê°€ì¥ ë§ˆì§€ë§‰ì˜ í”„ë¡œì„¸ìŠ¤ Pnê°€ ë‹¤ì‹œ P1ì´ ê°€ì§„ ìì›ì„ ìš”ì²­í•˜ê³  í•´ì œ ë˜ê¸¸ ê¸°ë‹¤ë¦¬ëŠ” í˜•íƒœì´ë‹¤.</p>

<p><strong>ì™¸ë˜í‚¤</strong>ë€, ì™¸ë˜í‚¤ëŠ” ë‘ í…Œì´ë¸”ì„ ì„œë¡œ ì—°ê²°í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” í‚¤ì´ë‹¤. ì™¸ë˜í‚¤ê°€ í¬í•¨ëœ í…Œì´ë¸”ì„ ìì‹ í…Œì´ë¸”ì´ë¼ê³  í•˜ê³  ì™¸ë˜í‚¤ ê°’ì„ ì œê³µí•˜ëŠ” í…Œì´ë¸”ì„ ë¶€ëª¨ í…Œì´ë¸”ì´ë¼ê³  í•œë‹¤.</p>

<blockquote>
  <p>Real MySQL 3ì¥ì„ ë³´ë©´, ì•„ë˜ì™€ ê°™ì€ ê¸€ì´ ìˆë‹¤.
â€œì™¸ë˜í‚¤ëŠ” ë¶€ëª¨í…Œì´ë¸”ì´ë‚˜ ìì‹ í…Œì´ë¸”ì— ë°ì´í„°ê°€ ìˆëŠ”ì§€ ì²´í¬í•˜ëŠ” ì‘ì—…ì´ í•„ìš”í•˜ë¯€ë¡œ ì ê¸ˆì´ ì—¬ëŸ¬ í…Œì´ë¸”ë¡œ ì „íŒŒë˜ê³ , ê·¸ë¡œì¸í•´ ë°ë“œë½ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤. ê·¸ë˜ì„œ ì‹¤ë¬´ì—ì„œëŠ” ì˜ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.â€</p>
</blockquote>

<p><img src="https://velog.velcdn.com/images/haron/post/9cb67c04-19fc-4701-98c1-b6a45971eaa9/image.png" alt="" /><br />
ì˜¤í˜¸ë¼â€¦ ì ê¸ˆì´ ì—¬ëŸ¬í…Œì´ë¸”ë¡œ ì „íŒŒëœë‹¤ê³ ?!!</p>

<h2 id="ë°ë“œë½ì´-ë°œìƒí•˜ëŠ”-ìƒí™©-ì¬í˜„">ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ìƒí™© ì¬í˜„</h2>
<h3 id="ì¤€ë¹„ë¬¼ì€-ì´ë ‡ê²Œ-ì¤€ë¹„í•´ì£¼ì„¸ìš”">ì¤€ë¹„ë¬¼ì€ ì´ë ‡ê²Œ ì¤€ë¹„í•´ì£¼ì„¸ìš”</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">parent</span>
<span class="p">(</span>
    <span class="n">id</span>             <span class="nb">bigint</span>        <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">name</span>           <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>  <span class="k">null</span><span class="p">,</span>
    <span class="n">updated_at</span>     <span class="nb">datetime</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>   <span class="k">null</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">child</span>
<span class="p">(</span>
    <span class="n">id</span>           <span class="nb">bigint</span>          <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">name</span>         <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>    <span class="k">null</span><span class="p">,</span>
    <span class="n">parent_id</span>    <span class="nb">bigint</span>          <span class="k">null</span><span class="p">,</span>
    <span class="k">CONSTRAINT</span> <span class="n">parent_id_unique</span> <span class="k">UNIQUE</span> <span class="p">(</span><span class="n">parent_id</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">child_fk</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">parent_id</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">parent</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">);</span>


<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">child_index</span>
<span class="p">(</span>
    <span class="n">id</span>           <span class="nb">bigint</span>          <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">name</span>         <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>    <span class="k">null</span><span class="p">,</span>
    <span class="n">parent_id</span>    <span class="nb">bigint</span>          <span class="k">null</span><span class="p">,</span>
    <span class="k">CONSTRAINT</span> <span class="n">child_index_fk</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">parent_id</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">parent</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">parent_id</span> <span class="k">ON</span> <span class="n">child_index</span> <span class="p">(</span><span class="n">parent_id</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">parent</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'parent_1'</span><span class="p">,</span> <span class="n">NOW</span><span class="p">());</span>
</code></pre></div></div>
<ol>
  <li>parent í…Œì´ë¸”ì˜ idë¥¼ foreign key / unique keyë¡œ ê°€ì§€ê³  ìˆëŠ” child í…Œì´ë¸” ìƒì„±</li>
  <li>parent í…Œì´ë¸”ì˜ idë¥¼ foreign key / idnexë¡œ ê°€ì§€ê³  ìˆëŠ” child_index í…Œì´ë¸” ìƒì„±</li>
  <li>parent í…Œì´ë¸”ì— í…ŒìŠ¤íŠ¸ ë°ì´í„° ì ì¬</li>
</ol>

<h3 id="ê·¸ëŸ¼-ì´ì œ-ë°ë“œë½ì„-ë°œìƒì‹œì¼œ-ë³´ì">ê·¸ëŸ¼ ì´ì œ ë°ë“œë½ì„ ë°œìƒì‹œì¼œ ë³´ì</h3>
<h3 id="ìì‹-row-insert---ë¶€ëª¨-row-update-ê°€-2ê°œì˜-ì„¸ì…˜ì—ì„œ-ìˆ˜í–‰ë˜ë©´-ë°ë“œë½ì´-ë°œìƒ-">ìì‹ row insert -&gt; ë¶€ëª¨ row update ê°€ 2ê°œì˜ ì„¸ì…˜ì—ì„œ ìˆ˜í–‰ë˜ë©´, ë°ë“œë½ì´ ë°œìƒ ğŸ’£</h3>
<p><img src="https://velog.velcdn.com/images/haron/post/64f10100-a470-43a9-af95-c4a372b5bd22/image.png" alt="" /></p>

<table>
  <thead>
    <tr>
      <th>TX1</th>
      <th>TX2</th>
      <th>lock</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>BEGIN ;  <br /> INSERT INTO child VALUES (1, â€˜child1â€™, 1);</td>
      <td>Â </td>
      <td>(1) child X,REC_NOT_GAP Lock, parent S Lock</td>
    </tr>
    <tr>
      <td>Â </td>
      <td>BEGIN ;  <br /> INSERT INTO child VALUES (1, â€˜child1â€™, 1);</td>
      <td>(2) child X Lock ëŒ€ê¸°, parent S Lock</td>
    </tr>
    <tr>
      <td>UPDATE parent SET name = â€˜newParentâ€™ WHERE id = 1;</td>
      <td>Â </td>
      <td>(3)</td>
    </tr>
    <tr>
      <td>Â </td>
      <td>Deadlock found when trying to get lock; try restarting transaction</td>
      <td>(3) parent X lock ì´ í•„ìš”í•˜ì§€ë§Œ, (2) ì—ì„œ parentëŠ” S lock ìƒíƒœ <br /> (3) í•´ì†Œë¥¼ ìœ„í•´ì„œ (2) í•´ì†Œ í•„ìš” <br /> -&gt; (2) í•´ì†Œ ìœ„í•´ì„œ TX1 ì»¤ë°‹ í•„ìš” <br /> -&gt; TX1ì´ ì»¤ë°‹í•˜ë ¤ë©´ (3) í•´ì†Œ í•„ìš” <br /> -&gt; ë°ë“œë½ ë°œìƒ</td>
    </tr>
  </tbody>
</table>

<p><img src="https://velog.velcdn.com/images/haron/post/609d3b4c-6e3d-4743-af14-5449b7b730fe/image.jpeg" alt="" /></p>

<blockquote>
  <p>ìì‹ í…Œì´ë¸”ì— ëŒ€í•œ ì“°ê¸° ì¿¼ë¦¬ë¥¼ ìˆ˜í–‰í•  ë•Œ foreign í‚¤ ì œì•½ìœ¼ë¡œ ì¸í•´ ë¶€ëª¨ì˜ ì ê¸ˆ ìƒíƒœë¥¼ í™•ì¸í›„ ë¬¸ì œê°€ ì—†ìœ¼ë©´ ì¿¼ë¦¬ë¥¼ ìˆ˜í–‰í•˜ê³ , ì •í•©ì„±ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ ë¶€ëª¨ í…Œì´ë¸”ì— í•´ë‹¹ í–‰ì„ ê³µìœ ì ê¸ˆ í•œë‹¤.</p>
</blockquote>

<blockquote>
  <p>ê³µìœ  ë½(Shared(S) Lock)
ê³µìœ  ë½(Shared Lock)ì€ ì½ê¸° ë½(Read Lock)ì´ë¼ê³ ë„ ë¶ˆë¦°ë‹¤. ê³µìœ  ë½ì´ ê±¸ë¦° ë°ì´í„°ì— ëŒ€í•´ì„œëŠ” ì½ê¸° ì—°ì‚°(SELECT)ë§Œ ì‹¤í–‰ ê°€ëŠ¥í•˜ë©°, ì“°ê¸° ì—°ì‚°ì€ ì‹¤í–‰ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤. ê³µìœ  ë½ì´ ê±¸ë¦° ë°ì´í„°ì— ëŒ€í•´ì„œ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ë„ ë˜‘ê°™ì´ ê³µìœ  ë½ì„ íšë“í•  ìˆ˜ ìˆìœ¼ë‚˜, ë°°íƒ€ ë½ì€ íšë“í•  ìˆ˜ ì—†ë‹¤. ê³µìœ  ë½ì´ ê±¸ë ¤ë„ ì½ê¸° ì‘ì—…ì€ ê°€ëŠ¥í•˜ë‹¤ëŠ” ëœ»ì´ë‹¤.
ê³µìœ  ë½ì„ ì‚¬ìš©í•˜ë©´, ì¡°íšŒí•œ ë°ì´í„°ê°€ íŠ¸ëœì­ì…˜ ë‚´ë‚´ ë³€ê²½ë˜ì§€ ì•ŠìŒì„ ë³´ì¥í•œë‹¤.</p>
</blockquote>

<blockquote>
  <p>ë² íƒ€ ë½(Exclusive(X) Lock)
ë°°íƒ€ ë½ì€ ì“°ê¸° ë½(Write Lock)ì´ë¼ê³ ë„ ë¶ˆë¦°ë‹¤. ë°ì´í„°ì— ëŒ€í•´ ë°°íƒ€ ë½ì„ íšë“í•œ íŠ¸ëœì­ì…˜ì€, ì½ê¸° ì—°ì‚°ê³¼ ì“°ê¸° ì—°ì‚°ì„ ëª¨ë‘ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤. ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì€ ë°°íƒ€ ë½ì´ ê±¸ë¦° ë°ì´í„°ì— ëŒ€í•´ ì½ê¸° ì‘ì—…ë„, ì“°ê¸° ì‘ì—…ë„ ìˆ˜í–‰í•  ìˆ˜ ì—†ë‹¤. ì¦‰, ë°°íƒ€ ë½ì´ ê±¸ë ¤ìˆë‹¤ë©´ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì€ ê³µìœ  ë½, ë°°íƒ€ ë½ ë‘˜ ë‹¤ íšë“ í•  ìˆ˜ ì—†ë‹¤. ë°°íƒ€ ë½ì„ íšë“í•œ íŠ¸ëœì­ì…˜ì€ í•´ë‹¹ ë°ì´í„°ì— ëŒ€í•œ ë…ì ê¶Œì„ ê°–ëŠ” ê²ƒì´ë‹¤.</p>
</blockquote>

<h3 id="ë¶€ëª¨-row-update--ìì‹-row-insert-ê°€-ë‘ê°œì˜-ì„¸ì…˜ì—ì„œ-ìˆ˜í–‰ë˜ë©´-ì¤‘ë³µí‚¤-ì—ëŸ¬-ë°œìƒ">ë¶€ëª¨ row update â†’ ìì‹ row insert ê°€ ë‘ê°œì˜ ì„¸ì…˜ì—ì„œ ìˆ˜í–‰ë˜ë©´, ì¤‘ë³µí‚¤ ì—ëŸ¬ ë°œìƒ</h3>
<p><img src="https://velog.velcdn.com/images/haron/post/f36e285b-25f9-42f7-a233-7864a0ad9244/image.png" alt="" /><br />
ë¶€ëª¨ row ì—ì„œ ë¨¼ì € update ê°€ ì¼ì–´ë‚˜ë©´, ë°ë“œë½ì€ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤. ì¤‘ë³µí‚¤ ì—ëŸ¬ëŠ” ì„œë¹„ìŠ¤ íŠ¹ì„±ìƒ í•„ìš”í•´ì„œ ì¶”ê°€í•œ ì˜µì…˜ì´ë‹¤.</p>

<h2 id="ìš´ì˜í™˜ê²½ì—ì„œ-ë°ë“œë½ì´-ë°œìƒí•˜ëŠ”-ë¡œì§ì„-ì‚´í´ë³´ì">ìš´ì˜í™˜ê²½ì—ì„œ ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ë¡œì§ì„ ì‚´í´ë³´ì</h2>
<ul>
  <li>ì„œë¹„ìŠ¤ì—ì„œëŠ” jpa ë¥¼ ì‚¬ìš©í•˜ê³  ìˆì–´, <code class="language-plaintext highlighter-rouge">show-sql</code> ì˜µì…˜ì„ í†µí•´ í™•ì¸í•˜ì.
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">parent</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">child</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'child_1'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">child_index</span> <span class="k">WHERE</span> <span class="n">parent_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">child_index</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'child_index_1'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">UPDATE</span> <span class="n">parent</span> <span class="k">SET</span>  <span class="n">updated_at</span> <span class="o">=</span> <span class="n">NOW</span><span class="p">()</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div>    </div>
    <p>(í…Œì´ë¸” ë° ì»¬ëŸ¼ì„ ê°„ì†Œí™” ì‹œí‚¨ ë²„ì „)</p>
  </li>
</ul>

<h3 id="ìì‹-row-insert---ë¶€ëª¨-row-update-ê°€-2ê°œì˜-ì„¸ì…˜ì—ì„œ-ìˆ˜í–‰ë˜ë©´-ë°ë“œë½ì´-ë°œìƒ--1">ìì‹ row insert -&gt; ë¶€ëª¨ row update ê°€ 2ê°œì˜ ì„¸ì…˜ì—ì„œ ìˆ˜í–‰ë˜ë©´, ë°ë“œë½ì´ ë°œìƒ ğŸ’£</h3>
<p><img src="https://velog.velcdn.com/images/haron/post/b5700769-98a0-45f6-9858-2594d362f922/image.png" alt="" /></p>

<ul>
  <li>2ê°œì˜ ì„¸ì…˜ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì´ìœ ë¥¼ í”„ë¡ íŠ¸ì—ì„œ ë³´ë‚´ëŠ” ë”°ë‹¥(2ë²ˆ ì´ìƒì˜ ë™ì‹œ ìš”ì²­)ìœ¼ë¡œ ë³´ì•˜ë‹¤. ğŸ–±ğŸ¤ğŸ–±ğŸ¤</li>
  <li>í”„ë¡ íŠ¸ì˜ ë‹¤ë¥¸ ë²„íŠ¼ì—ì„œëŠ” ê°™ì€ ì´ìŠˆê°€ ì—†ëŠ”ë°, í•´ë‹¹ ë²„íŠ¼ë§Œ ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ê²ƒë„ ê¶ê¸ˆí•˜ë‹¤ ğŸ¤”</li>
</ul>

<h2 id="ì›ì¸ì€-ì•Œì•˜ê³ -ì„œë²„ì—ì„œ-ë°ë“œë½ì„-í•´ê²°í• -ìˆ˜-ìˆëŠ”-ë°©ë²•ì„-ê³ ë¯¼í•´ë³´ì">ì›ì¸ì€ ì•Œì•˜ê³ , ì„œë²„ì—ì„œ ë°ë“œë½ì„ í•´ê²°í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ê³ ë¯¼í•´ë³´ì</h2>

<h3 id="-ì²«ë²ˆì§¸-ì‹œë„-ë¶€ëª¨-row-update--ìì‹-row-insert-ë¡œì§ìœ¼ë¡œ-ë³€ê²½í•´ì„œ-ì¤‘ë³µí‚¤-ì—ëŸ¬-ë°œìƒí•˜ë„ë¡-ì¡°ì •">â ì²«ë²ˆì§¸ ì‹œë„, ë¶€ëª¨ row update â†’ ìì‹ row insert ë¡œì§ìœ¼ë¡œ ë³€ê²½í•´ì„œ ì¤‘ë³µí‚¤ ì—ëŸ¬ ë°œìƒí•˜ë„ë¡ ì¡°ì •</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nd">@Transactional</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createChildAndChildIndex</span> <span class="o">(</span><span class="kt">long</span> <span class="n">parentId</span><span class="o">)</span> <span class="o">{</span>

    <span class="kt">var</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">parentRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">parentId</span><span class="o">);</span>
    <span class="c1">// ë¶€ëª¨ row update </span>
    <span class="n">paraent</span><span class="o">.</span><span class="na">setUpdateAt</span><span class="o">(</span><span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
    
    <span class="c1">// ìì‹ row insert</span>
    <span class="n">childRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">Child</span><span class="o">(</span><span class="err">'</span><span class="n">child_1</span><span class="err">'</span><span class="o">,</span> <span class="n">parent</span><span class="o">));</span>
    
    <span class="n">childIndexRepository</span><span class="o">.</span><span class="na">deleteByParent</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
    <span class="n">childIndexRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="n">Child_Index</span><span class="o">(</span><span class="err">'</span><span class="n">child_index_1</span><span class="err">'</span><span class="o">,</span> <span class="n">parent</span><span class="o">));</span>

  <span class="o">}</span>
</code></pre></div></div>
<p>í•˜ì§€ë§Œ ì—¬ì „íˆ ìì‹ row insert â†’ ë¶€ëª¨ row update ë¡œì§ìœ¼ë¡œ ì¿¼ë¦¬ê°€ ë‚˜ê°€ì„œ ë°ë“œë½ì´ ë°œìƒí•˜ê³  ìˆë‹¤. ğŸ˜‡</p>

<h3 id="hibernate-ì¿¼ë¦¬-ì‹¤í–‰-ìš°ì„ ìˆœìœ„">Hibernate ì¿¼ë¦¬ ì‹¤í–‰ ìš°ì„ ìˆœìœ„</h3>
<p>JPA ì“°ê¸° ì§€ì—° ë•ë¶„ì— service method ê°€ ëë‚˜ê³  íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë˜ëŠ” ì‹œì ì— ì¿¼ë¦¬ê°€ DBì— ë°˜ì˜ëœë‹¤ëŠ” ê²ƒì€ ì•Œê³  ìˆì—ˆì§€ë§Œ, ìš°ì„ ìˆœìœ„ê°€ ìˆì—ˆë‹¤ê³ ..??</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>OrphanRemovalAction
AbstractEntityInsertAction
EntityUpdateAction
QueuedOperationCollectionAction
CollectionRemoveAction
CollectionUpdateAction
CollectionRecreateAction
EntityDeleteAction

1. Inserts, in the order they were performed
2. Updates
3. Deletion of collection elements
4. Insertion of collection elements
5. Deletes, in the order they were performed
</code></pre></div></div>
<p>fyi; <a href="https://docs.jboss.org/hibernate/orm/6.1/javadocs/org/hibernate/event/internal/AbstractFlushingEventListener.html#performExecutions(org.hibernate.event.spi.EventSource)">í•˜ì´ë²„ë„¤ì´íŠ¸ ì¿¼ë¦¬ ì‹¤í–‰ ìˆœì„œ</a></p>

<blockquote>
  <p>ì™¸ë˜í‚¤ ì œì•½ ì¡°ê±´ì´ë€?
ì™¸ë˜í‚¤ë¥¼ ê°–ëŠ” í…Œì´ë¸”ì— ë°ì´í„°ë¥¼ ì‚½ì…í•  ë•ŒëŠ” ê¸°ì¤€ í…Œì´ë¸”(ì™¸ë˜í‚¤ì— í•´ë‹¹ë˜ëŠ” í…Œì´ë¸”)ì— ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ” ë°ì´í„°ë§Œ ì°¸ì¡°í•´ì•¼ í•œë‹¤. ì—†ëŠ” ë°ì´í„°ë¥¼ ì°¸ì¡°í•´ì„œ ì™¸ë˜í‚¤ë¡œ ì¨ë¨¹ìœ¼ë©´ ì•ˆëœë‹¤ê³ . ê·¸ë˜ì„œ í•­ìƒ insertê°€ ë¨¼ì € ë˜ê²Œ í•˜ëŠ” ê²ƒ ê°™ë‹¤!</p>
</blockquote>

<p>ë¡œì§ì„ ë³€ê²½í–ˆìŒì—ë„ ì—¬ì „íˆ ìì‹ row insert â†’ ë¶€ëª¨ row update ë¡œì§ìœ¼ë¡œ ì¿¼ë¦¬ê°€ ë‚˜ê°€ëŠ” ì´ìœ ëŠ” ì“°ê¸° ì§€ì—°ì— ì˜í•´ ìì‹ row insert ê°€ ë¶€ëª¨ row update ë³´ë‹¤ ìš°ì„  ìˆ˜í–‰ë˜ê¸° ë•Œë¬¸ì´êµ°!</p>

<h3 id="-ë‘ë²ˆì§¸-ì‹œë„-ë¶€ëª¨-row-update-í›„ì—-flush-í•˜ì—¬-ì¿¼ë¦¬-ì‹¤í–‰">â ë‘ë²ˆì§¸ ì‹œë„, ë¶€ëª¨ row update í›„ì— flush() í•˜ì—¬ ì¿¼ë¦¬ ì‹¤í–‰</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nd">@Transactional</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createParent</span> <span class="o">(</span><span class="kt">long</span> <span class="n">parentId</span><span class="o">)</span> <span class="o">{</span>

    <span class="kt">var</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">parentRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">parentId</span><span class="o">);</span>
    <span class="c1">// ë¶€ëª¨ row update </span>
    <span class="n">paraent</span><span class="o">.</span><span class="na">setUpdateAt</span><span class="o">(</span><span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
    <span class="c1">// ë¶€ëª¨ row update í›„ì— flush()</span>
    <span class="n">parentRepository</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    
    <span class="c1">// ìì‹ row insert</span>
    <span class="n">childRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">Child</span><span class="o">(</span><span class="err">'</span><span class="n">child_1</span><span class="err">'</span><span class="o">,</span> <span class="n">parent</span><span class="o">));</span>
    
    <span class="n">childIndexRepository</span><span class="o">.</span><span class="na">deleteByParent</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
    <span class="n">childIndexRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="n">Child_Index</span><span class="o">(</span><span class="err">'</span><span class="n">child_index_1</span><span class="err">'</span><span class="o">,</span> <span class="n">parent</span><span class="o">));</span>

  <span class="o">}</span>
</code></pre></div></div>

<p>ë¡œì§ëŒ€ë¡œ ì¿¼ë¦¬ê°€ ë‚˜ê°„ë‹¤!</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">parent</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">UPDATE</span> <span class="n">parent</span> <span class="k">SET</span>  <span class="n">updated_at</span> <span class="o">=</span> <span class="n">NOW</span><span class="p">()</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">child</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'child_1'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">child_index</span> <span class="k">WHERE</span> <span class="n">parent_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">child_index</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'child_index_1'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</code></pre></div></div>
<ul>
  <li>í•˜ì§€ë§Œ flush() ê°€ ì–´ë–¤ ì‚¬ì´ë“œ ì´í™ì´ ìˆì„ì§€ì™€ ë‚˜ì¤‘ì— íˆìŠ¤í† ë¦¬ë¥¼ ëª¨ë¥´ëŠ” ë™ë£Œê°€ ëœ¬ê¸ˆì—†ëŠ” flush() ë¥¼ ë³´ê³  ì´í•´í•˜ì§€ ëª» í•˜ëŠ” ë¬¸ì œê°€ ìˆë‹¤.</li>
</ul>

<h3 id="-ì„¸ë²ˆì§¸-ì‹œë„-ìì‹-í…Œì´ë¸”ì—-ì¡´ì¬í•˜ëŠ”-ì™¸ë˜í‚¤-ì œê±°">âœ… ì„¸ë²ˆì§¸ ì‹œë„, ìì‹ í…Œì´ë¸”ì— ì¡´ì¬í•˜ëŠ” ì™¸ë˜í‚¤ ì œê±°</h3>
<p>ğŸ¤” 2288112 ê°œì˜ row ê°€ ìˆëŠ” í…Œì´ë¸”ì—ì„œ ì™¸ë˜í‚¤ ì œê±°í•˜ëŠ”ë° ì†Œìš”ë˜ëŠ” ì‹œê°„ì€?!</p>

<ul>
  <li>ìì‹ row ì— ë³€ê²½ì‚¬í•­ ë•Œë¬¸ì— ë¶€ëª¨ rowê¹Œì§€ ê³µìœ ì ê¸ˆì´ ê±¸ë ¤ì„œ ë°ë“œë½ì´ ë°œìƒí•˜ê³  ìˆë‹¤. ê·¼ë³¸ì ì¸ ë¬¸ì œë¥¼ ì œê±°í•˜ë©´ ë˜ì§€ ì•Šì„ê¹Œ?</li>
  <li>ì™¸ë˜í‚¤ë¥¼ ì œê±°í•˜ëŠ” ë™ì•ˆ ì„œë¹„ìŠ¤ ì¤‘ë‹¨ì´ ìƒê¸¸ê¹Œ ê±±ì •ì´ ë˜ê¸°ë„ í•˜ê³ , ê¶ê¸ˆí•´ì„œ í•´ë³¸ í…ŒìŠ¤íŠ¸
54973 ê¸°ì¤€ 14 ms ì†Œìš”</li>
</ul>

<p><img src="https://velog.velcdn.com/images/haron/post/b66d04a1-8e93-4f24-a8bb-f135946f7669/image.png" alt="" /></p>
<ul>
  <li>íŒ€ì—ì„œ ë…¼ì˜ í›„ì— ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ì—†ì´ fk í‚¤ë¥¼ ì œê±°í•˜ì˜€ê³ , ëª¨ë‹ˆí„°ë§ ê²°ê³¼ ì™¸ë˜í‚¤ ì œê±° í›„ì— ìì‹ í…Œì´ë¸”ì—ì„œ ë°œìƒí•˜ë˜ <code class="language-plaintext highlighter-rouge">SQLTransactionRollbackException</code>(ë°ë“œë½) ì€ <code class="language-plaintext highlighter-rouge">DataIntegrityViolationException</code>(ì¤‘ë³µí‚¤) ë¡œ ë°œìƒëœë‹¤.</li>
</ul>

<p><img src="https://velog.velcdn.com/images/haron/post/fa8c8a3e-ad61-4977-b1ff-585b0d262293/image.png" alt="" /></p>

<h3 id="ëª»-í•´ì¹˜ì› ã„´">ëª» í•´ì¹˜ì› ã„´â€¦</h3>
<p><a href="https://velog.io/@haron/%ED%8A%B8%EB%9F%AC%EB%B8%94%EC%8A%88%ED%8C%85-DB-%EC%9D%B8%EB%8D%B1%EC%8A%A4Index%EC%99%80-%EB%8D%B0%EB%93%9C%EB%9D%BDDeadLock-in8ryzsm">ì¸ë±ìŠ¤ê°€ ë‚  ê¸°ë‹¤ë¦¬ê³  ìˆì—ˆ..</a></p>

<h2 id="ì •ë¦¬">ì •ë¦¬</h2>
<ol>
  <li>ì™¸ë˜í‚¤ê°€ ê±¸ë ¤ìˆëŠ” ê²½ìš°, ìì‹ rowì— ë³€ê²½ì´ ì¼ì–´ë‚˜ë©´ ë¶€ëª¨ rowì— ê³µìœ  ì ê¸ˆì´ ê±¸ë¦°ë‹¤.</li>
  <li>JPA ì¿¼ë¦¬ ì§€ì—°ì—ëŠ” ì‹¤í–‰ ìˆœì„œê°€ ìˆë‹¤.</li>
  <li>FK í‚¤ë¥¼ ì œê±°í•˜ëŠ”ë° ì†Œìš”ë˜ëŠ” ì‹œê°„ì€ ìƒê°ë³´ë‹¤ ì ë‹¤.</li>
</ol>

<h3 id="ê¸°ë¡ìš©">ê¸°ë¡ìš©</h3>
<details>
<summary>SHOW ENGINE innodb STATUS;</summary>
- SHOW ENGINE innodb STATUS;
  LOCK WAIT 4 lock struct(s), heap size 1128, 2 row lock(s), undo log entries 1
  *** (1) HOLDS THE LOCK(S):

  RECORD LOCKS space id 148 page no 4 n bits 72 index PRIMARY of table `jpa`.`parent` trx id 12534 lock mode S locks rec but not gap

  Record lock, heap no 2 PHYSICAL RECORD: n_fields 4; compact format; info bits 0

  *** (1) WAITING FOR THIS LOCK TO BE GRANTED:
  RECORD LOCKS space id 149 page no 5 n bits 72 index parent_id_unique of table `jpa`.`child` trx id 12534 lock mode S waiting
  Record lock, heap no 2 PHYSICAL RECORD: n_fields 2; compact format; info bits 0

  *** (2) TRANSACTION:

  TRANSACTION 12533, ACTIVE 13 sec starting index read

  mysql tables in use 1, locked 1

  LOCK WAIT 6 lock struct(s), heap size 1128, 3 row lock(s), undo log entries 1

  MySQL thread id 128, OS thread handle 6143324160, query id 12894 localhost 127.0.0.1 root updating

  /* ApplicationName=DataGrip 2022.3.2 */ UPDATE parent SET name = 'newParent' WHERE id = 1

  *** (2) HOLDS THE LOCK(S):
  RECORD LOCKS space id 149 page no 5 n bits 72 index parent_id_unique of table `jpa`.`child` trx id 12533 lock_mode X locks rec but not gap
  Record lock, heap no 2 PHYSICAL RECORD: n_fields 2; compact format; info bits 0

  *** (2) WAITING FOR THIS LOCK TO BE GRANTED:
  RECORD LOCKS space id 148 page no 4 n bits 72 index PRIMARY of table `jpa`.`parent` trx id 12533 lock_mode X locks rec but not gap waiting

  Record lock, heap no 2 PHYSICAL RECORD: n_fields 4; compact format; info bits 0
</details>]]></content><author><name>Hocaron</name><email>kkannu0407@gmail.com</email></author><category term="Troubleshooting" /><summary type="html"><![CDATA[ë°ë“œë½ì´ ë°œìƒí•  ë•Œë§ˆë‹¤, í˜í˜ê°€ ìš¸ê³  ìˆë‹¤ğŸ˜¢ ê°„í—ì ìœ¼ë¡œ ë°œìƒí•˜ë˜ ë°ë“œë½ì˜ ì›ì¸ì„ ë¶„ì„í•˜ê³ , í•´ê²° ê³¼ì •ì„ ê¸°ë¡í•´ë³´ì. ì™¸ë˜í‚¤(Foreign Key)ì™€ ë°ë“œë½(DeadLock) ë°ë“œë½ì´ë€, ë‘˜ ì´ìƒì˜ í”„ë¡œì„¸ìŠ¤ê°€ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ê°€ ì ìœ í•˜ê³  ìˆëŠ” ìì›ì„ ì„œë¡œ ê¸°ë‹¤ë¦´ ë•Œ ë¬´í•œ ëŒ€ê¸°ì— ë¹ ì§€ëŠ” ìƒí™©ì´ë‹¤. P1ì€ P2ê°€ ê°€ì§€ê³  ìˆëŠ” ìì›ì´ í•´ì œ ë˜ê¸¸ ê¸°ë‹¤ë¦¬ê³ , P2ëŠ” P3ì´ ê°€ì§„ ìì›, ê·¸ ë‹¤ìŒ..ê³¼ ê°™ì€ í˜•ì‹ìœ¼ë¡œ ê°€ì¥ ë§ˆì§€ë§‰ì˜ í”„ë¡œì„¸ìŠ¤ Pnê°€ ë‹¤ì‹œ P1ì´ ê°€ì§„ ìì›ì„ ìš”ì²­í•˜ê³  í•´ì œ ë˜ê¸¸ ê¸°ë‹¤ë¦¬ëŠ” í˜•íƒœì´ë‹¤. ì™¸ë˜í‚¤ë€, ì™¸ë˜í‚¤ëŠ” ë‘ í…Œì´ë¸”ì„ ì„œë¡œ ì—°ê²°í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” í‚¤ì´ë‹¤. ì™¸ë˜í‚¤ê°€ í¬í•¨ëœ í…Œì´ë¸”ì„ ìì‹ í…Œì´ë¸”ì´ë¼ê³  í•˜ê³  ì™¸ë˜í‚¤ ê°’ì„ ì œê³µí•˜ëŠ” í…Œì´ë¸”ì„ ë¶€ëª¨ í…Œì´ë¸”ì´ë¼ê³  í•œë‹¤. Real MySQL 3ì¥ì„ ë³´ë©´, ì•„ë˜ì™€ ê°™ì€ ê¸€ì´ ìˆë‹¤. â€œì™¸ë˜í‚¤ëŠ” ë¶€ëª¨í…Œì´ë¸”ì´ë‚˜ ìì‹ í…Œì´ë¸”ì— ë°ì´í„°ê°€ ìˆëŠ”ì§€ ì²´í¬í•˜ëŠ” ì‘ì—…ì´ í•„ìš”í•˜ë¯€ë¡œ ì ê¸ˆì´ ì—¬ëŸ¬ í…Œì´ë¸”ë¡œ ì „íŒŒë˜ê³ , ê·¸ë¡œì¸í•´ ë°ë“œë½ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤. ê·¸ë˜ì„œ ì‹¤ë¬´ì—ì„œëŠ” ì˜ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.â€ ì˜¤í˜¸ë¼â€¦ ì ê¸ˆì´ ì—¬ëŸ¬í…Œì´ë¸”ë¡œ ì „íŒŒëœë‹¤ê³ ?!! ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ìƒí™© ì¬í˜„ ì¤€ë¹„ë¬¼ì€ ì´ë ‡ê²Œ ì¤€ë¹„í•´ì£¼ì„¸ìš” CREATE TABLE parent ( id bigint not null primary key, name varchar(255) null, updated_at datetime(6) null ); CREATE TABLE child ( id bigint not null primary key, name varchar(255) null, parent_id bigint null, CONSTRAINT parent_id_unique UNIQUE (parent_id), CONSTRAINT child_fk FOREIGN KEY (parent_id) REFERENCES parent (id) ); CREATE TABLE child_index ( id bigint not null primary key, name varchar(255) null, parent_id bigint null, CONSTRAINT child_index_fk FOREIGN KEY (parent_id) REFERENCES parent (id) ); CREATE INDEX parent_id ON child_index (parent_id); INSERT INTO parent VALUES (1, 'parent_1', NOW()); parent í…Œì´ë¸”ì˜ idë¥¼ foreign key / unique keyë¡œ ê°€ì§€ê³  ìˆëŠ” child í…Œì´ë¸” ìƒì„± parent í…Œì´ë¸”ì˜ idë¥¼ foreign key / idnexë¡œ ê°€ì§€ê³  ìˆëŠ” child_index í…Œì´ë¸” ìƒì„± parent í…Œì´ë¸”ì— í…ŒìŠ¤íŠ¸ ë°ì´í„° ì ì¬ ê·¸ëŸ¼ ì´ì œ ë°ë“œë½ì„ ë°œìƒì‹œì¼œ ë³´ì ìì‹ row insert -&gt; ë¶€ëª¨ row update ê°€ 2ê°œì˜ ì„¸ì…˜ì—ì„œ ìˆ˜í–‰ë˜ë©´, ë°ë“œë½ì´ ë°œìƒ ğŸ’£ TX1 TX2 lock BEGIN ; INSERT INTO child VALUES (1, â€˜child1â€™, 1); Â  (1) child X,REC_NOT_GAP Lock, parent S Lock Â  BEGIN ; INSERT INTO child VALUES (1, â€˜child1â€™, 1); (2) child X Lock ëŒ€ê¸°, parent S Lock UPDATE parent SET name = â€˜newParentâ€™ WHERE id = 1; Â  (3) Â  Deadlock found when trying to get lock; try restarting transaction (3) parent X lock ì´ í•„ìš”í•˜ì§€ë§Œ, (2) ì—ì„œ parentëŠ” S lock ìƒíƒœ (3) í•´ì†Œë¥¼ ìœ„í•´ì„œ (2) í•´ì†Œ í•„ìš” -&gt; (2) í•´ì†Œ ìœ„í•´ì„œ TX1 ì»¤ë°‹ í•„ìš” -&gt; TX1ì´ ì»¤ë°‹í•˜ë ¤ë©´ (3) í•´ì†Œ í•„ìš” -&gt; ë°ë“œë½ ë°œìƒ ìì‹ í…Œì´ë¸”ì— ëŒ€í•œ ì“°ê¸° ì¿¼ë¦¬ë¥¼ ìˆ˜í–‰í•  ë•Œ foreign í‚¤ ì œì•½ìœ¼ë¡œ ì¸í•´ ë¶€ëª¨ì˜ ì ê¸ˆ ìƒíƒœë¥¼ í™•ì¸í›„ ë¬¸ì œê°€ ì—†ìœ¼ë©´ ì¿¼ë¦¬ë¥¼ ìˆ˜í–‰í•˜ê³ , ì •í•©ì„±ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ ë¶€ëª¨ í…Œì´ë¸”ì— í•´ë‹¹ í–‰ì„ ê³µìœ ì ê¸ˆ í•œë‹¤. ê³µìœ  ë½(Shared(S) Lock) ê³µìœ  ë½(Shared Lock)ì€ ì½ê¸° ë½(Read Lock)ì´ë¼ê³ ë„ ë¶ˆë¦°ë‹¤. ê³µìœ  ë½ì´ ê±¸ë¦° ë°ì´í„°ì— ëŒ€í•´ì„œëŠ” ì½ê¸° ì—°ì‚°(SELECT)ë§Œ ì‹¤í–‰ ê°€ëŠ¥í•˜ë©°, ì“°ê¸° ì—°ì‚°ì€ ì‹¤í–‰ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤. ê³µìœ  ë½ì´ ê±¸ë¦° ë°ì´í„°ì— ëŒ€í•´ì„œ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ë„ ë˜‘ê°™ì´ ê³µìœ  ë½ì„ íšë“í•  ìˆ˜ ìˆìœ¼ë‚˜, ë°°íƒ€ ë½ì€ íšë“í•  ìˆ˜ ì—†ë‹¤. ê³µìœ  ë½ì´ ê±¸ë ¤ë„ ì½ê¸° ì‘ì—…ì€ ê°€ëŠ¥í•˜ë‹¤ëŠ” ëœ»ì´ë‹¤. ê³µìœ  ë½ì„ ì‚¬ìš©í•˜ë©´, ì¡°íšŒí•œ ë°ì´í„°ê°€ íŠ¸ëœì­ì…˜ ë‚´ë‚´ ë³€ê²½ë˜ì§€ ì•ŠìŒì„ ë³´ì¥í•œë‹¤. ë² íƒ€ ë½(Exclusive(X) Lock) ë°°íƒ€ ë½ì€ ì“°ê¸° ë½(Write Lock)ì´ë¼ê³ ë„ ë¶ˆë¦°ë‹¤. ë°ì´í„°ì— ëŒ€í•´ ë°°íƒ€ ë½ì„ íšë“í•œ íŠ¸ëœì­ì…˜ì€, ì½ê¸° ì—°ì‚°ê³¼ ì“°ê¸° ì—°ì‚°ì„ ëª¨ë‘ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤. ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì€ ë°°íƒ€ ë½ì´ ê±¸ë¦° ë°ì´í„°ì— ëŒ€í•´ ì½ê¸° ì‘ì—…ë„, ì“°ê¸° ì‘ì—…ë„ ìˆ˜í–‰í•  ìˆ˜ ì—†ë‹¤. ì¦‰, ë°°íƒ€ ë½ì´ ê±¸ë ¤ìˆë‹¤ë©´ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì€ ê³µìœ  ë½, ë°°íƒ€ ë½ ë‘˜ ë‹¤ íšë“ í•  ìˆ˜ ì—†ë‹¤. ë°°íƒ€ ë½ì„ íšë“í•œ íŠ¸ëœì­ì…˜ì€ í•´ë‹¹ ë°ì´í„°ì— ëŒ€í•œ ë…ì ê¶Œì„ ê°–ëŠ” ê²ƒì´ë‹¤. ë¶€ëª¨ row update â†’ ìì‹ row insert ê°€ ë‘ê°œì˜ ì„¸ì…˜ì—ì„œ ìˆ˜í–‰ë˜ë©´, ì¤‘ë³µí‚¤ ì—ëŸ¬ ë°œìƒ ë¶€ëª¨ row ì—ì„œ ë¨¼ì € update ê°€ ì¼ì–´ë‚˜ë©´, ë°ë“œë½ì€ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤. ì¤‘ë³µí‚¤ ì—ëŸ¬ëŠ” ì„œë¹„ìŠ¤ íŠ¹ì„±ìƒ í•„ìš”í•´ì„œ ì¶”ê°€í•œ ì˜µì…˜ì´ë‹¤. ìš´ì˜í™˜ê²½ì—ì„œ ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ë¡œì§ì„ ì‚´í´ë³´ì ì„œë¹„ìŠ¤ì—ì„œëŠ” jpa ë¥¼ ì‚¬ìš©í•˜ê³  ìˆì–´, show-sql ì˜µì…˜ì„ í†µí•´ í™•ì¸í•˜ì. SELECT * from parent WHERE id = 1; INSERT INTO child VALUES (1, 'child_1', 1); DELETE FROM child_index WHERE parent_id = 1; INSERT INTO child_index VALUES (1, 'child_index_1', 1); UPDATE parent SET updated_at = NOW() WHERE id = 1; (í…Œì´ë¸” ë° ì»¬ëŸ¼ì„ ê°„ì†Œí™” ì‹œí‚¨ ë²„ì „) ìì‹ row insert -&gt; ë¶€ëª¨ row update ê°€ 2ê°œì˜ ì„¸ì…˜ì—ì„œ ìˆ˜í–‰ë˜ë©´, ë°ë“œë½ì´ ë°œìƒ ğŸ’£ 2ê°œì˜ ì„¸ì…˜ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì´ìœ ë¥¼ í”„ë¡ íŠ¸ì—ì„œ ë³´ë‚´ëŠ” ë”°ë‹¥(2ë²ˆ ì´ìƒì˜ ë™ì‹œ ìš”ì²­)ìœ¼ë¡œ ë³´ì•˜ë‹¤. ğŸ–±ğŸ¤ğŸ–±ğŸ¤ í”„ë¡ íŠ¸ì˜ ë‹¤ë¥¸ ë²„íŠ¼ì—ì„œëŠ” ê°™ì€ ì´ìŠˆê°€ ì—†ëŠ”ë°, í•´ë‹¹ ë²„íŠ¼ë§Œ ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ê²ƒë„ ê¶ê¸ˆí•˜ë‹¤ ğŸ¤” ì›ì¸ì€ ì•Œì•˜ê³ , ì„œë²„ì—ì„œ ë°ë“œë½ì„ í•´ê²°í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ê³ ë¯¼í•´ë³´ì â ì²«ë²ˆì§¸ ì‹œë„, ë¶€ëª¨ row update â†’ ìì‹ row insert ë¡œì§ìœ¼ë¡œ ë³€ê²½í•´ì„œ ì¤‘ë³µí‚¤ ì—ëŸ¬ ë°œìƒí•˜ë„ë¡ ì¡°ì • @Transactional public void createChildAndChildIndex (long parentId) { var parent = parentRepository.findById(parentId); // ë¶€ëª¨ row update paraent.setUpdateAt(LocalDateTime.now()); // ìì‹ row insert childRepository.save(new Child('child_1', parent)); childIndexRepository.deleteByParent(parent); childIndexRepository.save(new Child_Index('child_index_1', parent)); } í•˜ì§€ë§Œ ì—¬ì „íˆ ìì‹ row insert â†’ ë¶€ëª¨ row update ë¡œì§ìœ¼ë¡œ ì¿¼ë¦¬ê°€ ë‚˜ê°€ì„œ ë°ë“œë½ì´ ë°œìƒí•˜ê³  ìˆë‹¤. ğŸ˜‡ Hibernate ì¿¼ë¦¬ ì‹¤í–‰ ìš°ì„ ìˆœìœ„ JPA ì“°ê¸° ì§€ì—° ë•ë¶„ì— service method ê°€ ëë‚˜ê³  íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë˜ëŠ” ì‹œì ì— ì¿¼ë¦¬ê°€ DBì— ë°˜ì˜ëœë‹¤ëŠ” ê²ƒì€ ì•Œê³  ìˆì—ˆì§€ë§Œ, ìš°ì„ ìˆœìœ„ê°€ ìˆì—ˆë‹¤ê³ ..?? OrphanRemovalAction AbstractEntityInsertAction EntityUpdateAction QueuedOperationCollectionAction CollectionRemoveAction CollectionUpdateAction CollectionRecreateAction EntityDeleteAction 1. Inserts, in the order they were performed 2. Updates 3. Deletion of collection elements 4. Insertion of collection elements 5. Deletes, in the order they were performed fyi; í•˜ì´ë²„ë„¤ì´íŠ¸ ì¿¼ë¦¬ ì‹¤í–‰ ìˆœì„œ ì™¸ë˜í‚¤ ì œì•½ ì¡°ê±´ì´ë€? ì™¸ë˜í‚¤ë¥¼ ê°–ëŠ” í…Œì´ë¸”ì— ë°ì´í„°ë¥¼ ì‚½ì…í•  ë•ŒëŠ” ê¸°ì¤€ í…Œì´ë¸”(ì™¸ë˜í‚¤ì— í•´ë‹¹ë˜ëŠ” í…Œì´ë¸”)ì— ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ” ë°ì´í„°ë§Œ ì°¸ì¡°í•´ì•¼ í•œë‹¤. ì—†ëŠ” ë°ì´í„°ë¥¼ ì°¸ì¡°í•´ì„œ ì™¸ë˜í‚¤ë¡œ ì¨ë¨¹ìœ¼ë©´ ì•ˆëœë‹¤ê³ . ê·¸ë˜ì„œ í•­ìƒ insertê°€ ë¨¼ì € ë˜ê²Œ í•˜ëŠ” ê²ƒ ê°™ë‹¤! ë¡œì§ì„ ë³€ê²½í–ˆìŒì—ë„ ì—¬ì „íˆ ìì‹ row insert â†’ ë¶€ëª¨ row update ë¡œì§ìœ¼ë¡œ ì¿¼ë¦¬ê°€ ë‚˜ê°€ëŠ” ì´ìœ ëŠ” ì“°ê¸° ì§€ì—°ì— ì˜í•´ ìì‹ row insert ê°€ ë¶€ëª¨ row update ë³´ë‹¤ ìš°ì„  ìˆ˜í–‰ë˜ê¸° ë•Œë¬¸ì´êµ°! â ë‘ë²ˆì§¸ ì‹œë„, ë¶€ëª¨ row update í›„ì— flush() í•˜ì—¬ ì¿¼ë¦¬ ì‹¤í–‰ @Transactional public void createParent (long parentId) { var parent = parentRepository.findById(parentId); // ë¶€ëª¨ row update paraent.setUpdateAt(LocalDateTime.now()); // ë¶€ëª¨ row update í›„ì— flush() parentRepository.flush(); // ìì‹ row insert childRepository.save(new Child('child_1', parent)); childIndexRepository.deleteByParent(parent); childIndexRepository.save(new Child_Index('child_index_1', parent)); } ë¡œì§ëŒ€ë¡œ ì¿¼ë¦¬ê°€ ë‚˜ê°„ë‹¤! SELECT * from parent WHERE id = 1; UPDATE parent SET updated_at = NOW() WHERE id = 1; INSERT INTO child VALUES (1, 'child_1', 1); DELETE FROM child_index WHERE parent_id = 1; INSERT INTO child_index VALUES (1, 'child_index_1', 1); í•˜ì§€ë§Œ flush() ê°€ ì–´ë–¤ ì‚¬ì´ë“œ ì´í™ì´ ìˆì„ì§€ì™€ ë‚˜ì¤‘ì— íˆìŠ¤í† ë¦¬ë¥¼ ëª¨ë¥´ëŠ” ë™ë£Œê°€ ëœ¬ê¸ˆì—†ëŠ” flush() ë¥¼ ë³´ê³  ì´í•´í•˜ì§€ ëª» í•˜ëŠ” ë¬¸ì œê°€ ìˆë‹¤. âœ… ì„¸ë²ˆì§¸ ì‹œë„, ìì‹ í…Œì´ë¸”ì— ì¡´ì¬í•˜ëŠ” ì™¸ë˜í‚¤ ì œê±° ğŸ¤” 2288112 ê°œì˜ row ê°€ ìˆëŠ” í…Œì´ë¸”ì—ì„œ ì™¸ë˜í‚¤ ì œê±°í•˜ëŠ”ë° ì†Œìš”ë˜ëŠ” ì‹œê°„ì€?! ìì‹ row ì— ë³€ê²½ì‚¬í•­ ë•Œë¬¸ì— ë¶€ëª¨ rowê¹Œì§€ ê³µìœ ì ê¸ˆì´ ê±¸ë ¤ì„œ ë°ë“œë½ì´ ë°œìƒí•˜ê³  ìˆë‹¤. ê·¼ë³¸ì ì¸ ë¬¸ì œë¥¼ ì œê±°í•˜ë©´ ë˜ì§€ ì•Šì„ê¹Œ? ì™¸ë˜í‚¤ë¥¼ ì œê±°í•˜ëŠ” ë™ì•ˆ ì„œë¹„ìŠ¤ ì¤‘ë‹¨ì´ ìƒê¸¸ê¹Œ ê±±ì •ì´ ë˜ê¸°ë„ í•˜ê³ , ê¶ê¸ˆí•´ì„œ í•´ë³¸ í…ŒìŠ¤íŠ¸ 54973 ê¸°ì¤€ 14 ms ì†Œìš” íŒ€ì—ì„œ ë…¼ì˜ í›„ì— ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ì—†ì´ fk í‚¤ë¥¼ ì œê±°í•˜ì˜€ê³ , ëª¨ë‹ˆí„°ë§ ê²°ê³¼ ì™¸ë˜í‚¤ ì œê±° í›„ì— ìì‹ í…Œì´ë¸”ì—ì„œ ë°œìƒí•˜ë˜ SQLTransactionRollbackException(ë°ë“œë½) ì€ DataIntegrityViolationException(ì¤‘ë³µí‚¤) ë¡œ ë°œìƒëœë‹¤. ëª» í•´ì¹˜ì› ã„´â€¦ ì¸ë±ìŠ¤ê°€ ë‚  ê¸°ë‹¤ë¦¬ê³  ìˆì—ˆ.. ì •ë¦¬ ì™¸ë˜í‚¤ê°€ ê±¸ë ¤ìˆëŠ” ê²½ìš°, ìì‹ rowì— ë³€ê²½ì´ ì¼ì–´ë‚˜ë©´ ë¶€ëª¨ rowì— ê³µìœ  ì ê¸ˆì´ ê±¸ë¦°ë‹¤. JPA ì¿¼ë¦¬ ì§€ì—°ì—ëŠ” ì‹¤í–‰ ìˆœì„œê°€ ìˆë‹¤. FK í‚¤ë¥¼ ì œê±°í•˜ëŠ”ë° ì†Œìš”ë˜ëŠ” ì‹œê°„ì€ ìƒê°ë³´ë‹¤ ì ë‹¤. ê¸°ë¡ìš© SHOW ENGINE innodb STATUS; - SHOW ENGINE innodb STATUS; LOCK WAIT 4 lock struct(s), heap size 1128, 2 row lock(s), undo log entries 1 *** (1) HOLDS THE LOCK(S): RECORD LOCKS space id 148 page no 4 n bits 72 index PRIMARY of table `jpa`.`parent` trx id 12534 lock mode S locks rec but not gap Record lock, heap no 2 PHYSICAL RECORD: n_fields 4; compact format; info bits 0 *** (1) WAITING FOR THIS LOCK TO BE GRANTED: RECORD LOCKS space id 149 page no 5 n bits 72 index parent_id_unique of table `jpa`.`child` trx id 12534 lock mode S waiting Record lock, heap no 2 PHYSICAL RECORD: n_fields 2; compact format; info bits 0 *** (2) TRANSACTION: TRANSACTION 12533, ACTIVE 13 sec starting index read mysql tables in use 1, locked 1 LOCK WAIT 6 lock struct(s), heap size 1128, 3 row lock(s), undo log entries 1 MySQL thread id 128, OS thread handle 6143324160, query id 12894 localhost 127.0.0.1 root updating /* ApplicationName=DataGrip 2022.3.2 */ UPDATE parent SET name = 'newParent' WHERE id = 1 *** (2) HOLDS THE LOCK(S): RECORD LOCKS space id 149 page no 5 n bits 72 index parent_id_unique of table `jpa`.`child` trx id 12533 lock_mode X locks rec but not gap Record lock, heap no 2 PHYSICAL RECORD: n_fields 2; compact format; info bits 0 *** (2) WAITING FOR THIS LOCK TO BE GRANTED: RECORD LOCKS space id 148 page no 4 n bits 72 index PRIMARY of table `jpa`.`parent` trx id 12533 lock_mode X locks rec but not gap waiting Record lock, heap no 2 PHYSICAL RECORD: n_fields 4; compact format; info bits 0]]></summary></entry></feed>