<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>[Troubleshooting - DB] ì¸ë±ìŠ¤(Index)ì™€ ë°ë“œë½(DeadLock) | this.hocaron</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="[Troubleshooting - DB] ì¸ë±ìŠ¤(Index)ì™€ ë°ë“œë½(DeadLock)" />
<meta name="author" content="Hocaron" />
<meta property="og:locale" content="ko" />
<meta name="description" content="ì—­ì‹œ í•´ì¹˜ì› ë‚˜ë¥¼ ì™¸ì¹˜ë©´ ì•ˆ ë˜ëŠ” ê²ƒì¸ê°€â€¦ ë˜ ìš¸ê¸° ì‹œì‘í•œ í˜í˜â€¦ (ê·¸ë§Œ ìš¸ì–´ì‡!) ì˜ë¯¸ìˆëŠ” ê²½í—˜ìœ¼ë¡œ ë‚¨ê¸°ê¸°ìœ„í•´ ê¸°ë¡í•´ë³´ì. ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ìƒí™© ë‹¤ì‹œ ì¬í˜„ í˜„ì¬ í…Œì´ë¸” ìƒíƒœ CREATE TABLE parent ( id bigint not null primary key, name varchar(255) null, updated_at datetime(6) null ); CREATE TABLE child ( id bigint not null primary key, name varchar(255) null, parent_id bigint null, CONSTRAINT parent_id_unique UNIQUE (parent_id) ); CREATE TABLE child_index ( id bigint not null primary key, name varchar(255) null, parent_id bigint null, ); CREATE INDEX parent_id ON child_index (parent_id); INSERT INTO parent VALUES (1, &#39;parent_1&#39;, NOW()); parent í…Œì´ë¸”ì˜ idë¥¼ indexë¡œ ê°€ì§€ê³  ìˆëŠ” child_index í…Œì´ë¸” ìƒì„±(ì™¸ë˜í‚¤ëŠ” ìš´ì˜ì—ì„œ ì‚­ì œë˜ì–´ì„œ í…ŒìŠ¤íŠ¸ì‹œ ê³ ë ¤í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤) parent í…Œì´ë¸”ì˜ idë¥¼ ìœ ë‹ˆí¬ í‚¤ë¡œ ê°€ì§€ê³  ìˆëŠ” child í…Œì´ë¸” ìƒì„±(ë§ˆì°¬ê°€ì§€ë¡œ ì™¸ë˜í‚¤ ê³ ë ¤í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.) parent í…Œì´ë¸”ì— í…ŒìŠ¤íŠ¸ ë°ì´í„° ì ì¬ ê·¸ëŸ¼ ì´ì œ ë°ë“œë½ì„ ë°œìƒì‹œì¼œ ë³´ì index ê±¸ë ¤ìˆëŠ” row delete â†’ index ê±¸ë ¤ìˆëŠ” ìì‹ row insertê°€ ë‘ê°œì˜ ì„¸ì…˜ì—ì„œ ìˆ˜í–‰ë˜ë©´, ë°ë“œë½ì´ ë°œìƒ ğŸ’£ TX1 TX2 lock BEGIN ; DELETE FROM child_index WHERE parent_id = 2; Â  (1) child X Lock ì¸ë°, TX2ì—ì„œ X Lock íšë“ ê°€ëŠ¥í• ê¹Œ ğŸ¤” Â  BEGIN ; DELETE FROM child_index WHERE parent_id = 2; (2) child X Lock INSERT INTO child_index VALUES (â€˜1â€™, â€˜name2â€™, 2); Â  (3) child X,INSERT_INTENTION Lock ëŒ€ê¸° Â  INSERT INTO child_index VALUES (â€˜2â€™, â€˜name2â€™, 2); (4) child X,INSERT_INTENTION Lock ëŒ€ê¸° Â  Deadlock found when trying to get lock; try restarting transaction (4) child X lock ì´ í•„ìš”í•˜ì§€ë§Œ, (2) ì—ì„œ child X lock ìƒíƒœ (4) í•´ì†Œë¥¼ ìœ„í•´ì„œ (3) í•´ì†Œ í•„ìš” -&gt; (3) í•´ì†Œ ìœ„í•´ì„œ TX2 ì»¤ë°‹ í•„ìš” -&gt; TX2 ì»¤ë°‹í•˜ë ¤ë©´ (4) í•´ì†Œ í•„ìš” -&gt; ë°ë“œë½ ë°œìƒ ìš´ì˜í™˜ê²½ì—ì„œ ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ë¡œì§ì„ ì‚´í´ë³´ì index ê±¸ë ¤ìˆëŠ” row delete â†’ index ê±¸ë ¤ìˆëŠ” ìì‹ row insertê°€ ë‘ê°œì˜ ì„¸ì…˜ì—ì„œ ìˆ˜í–‰ë˜ë©´, ë°ë“œë½ì´ ë°œìƒ ğŸ’£ SELECT * from parent WHERE id = 1; INSERT INTO child VALUES (1, &#39;child_1&#39;, 1); DELETE FROM child_index WHERE parent_id = 1; INSERT INTO child_index VALUES (1, &#39;child_index_1&#39;, 1); UPDATE parent SET updated_at = NOW() WHERE id = 1; @Transactional public void createChildAndChildIndex (long parentId) { var parent = parentRepository.findById(parentId); childIndexRepository.deleteByParent(parent); childIndexRepository.save(new Child_Index(&#39;child_index_1&#39;, parent)); } í•œê°€ì§€ ì‹ ê¸°í•œ ì ì€ delete í•˜ë ¤ëŠ” ë°ì´í„°ê°€ ì—†ì„ ë•Œ, ë°ë“œë½ì´ ë°œìƒí•œë‹¤. delete í•˜ë ¤ëŠ” ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ì—ëŠ” ê°™ì€ ë¡œì§ì„ ìˆ˜í–‰í•˜ë©´ ë½ì„ ì¡ì„ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê²Œ ëœë‹¤. ì›ì¸ì€ ì•Œì•˜ê³ , ì„œë²„ì—ì„œ ë°ë“œë½ì„ í•´ê²°í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ê³ ë¯¼í•´ë³´ì â ì²«ë²ˆì§¸ ì‹œë„, ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ row ì‚­ì œ @Transactional public void createParent (long parentId) { var parent = parentRepository.findById(parentId); if(childIndexRepository.findByParent(parent).isPresent()) { childIndexRepository.deleteByParent(parent); } childIndexRepository.save(new Child_Index(&#39;child_index_1&#39;, parent)); } ë¬´ì¡°ê±´ delete í•˜ëŠ” ë¡œì§ìœ¼ë¡œ ì¸í•œ ë°°íƒ€ë½ì€ ë°©ì§€ ê°€ëŠ¥í•˜ë‹¤. ë™ì‹œ ìš”ì²­ì‹œì— childIndexRepository.findByParent ì— ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ë¡œ ë¶„ê¸°ì²˜ë¦¬ë˜ëŠ” ê²½ìš°, ë°ì´í„°ê°€ 2ë°°ë¡œ ì ì¬ë  ìˆ˜ ìˆë‹¤. 300ms ë¡œ ì“°ë ˆë“œ sleep() ê±¸ì–´ì„œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ 2ë°°ë¡œ ìŒ“ì´ëŠ” ê²ƒì„ í™•ì¸ âœ… ë‘ë²ˆì§¸ ì‹œë„, ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ row ì‚­ì œí•˜ë©´ì„œ ìœ ë‹ˆí¬ ì¡°ê±´ ì¶”ê°€ CREATE TABLE child_index ( id bigint not null primary key, name varchar(255) null, parent_id bigint null, CONSTRAINT parent_id_unique UNIQUE (parent_id) ); CREATE INDEX parent_id ON child_index (parent_id); ë™ì‹œ ìš”ì²­ì‹œì— childIndexRepository.findByParent ì— ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ë¡œ ë¶„ê¸°ì²˜ë¦¬ë˜ëŠ” ê²½ìš°, í›„ì— ì»¤ë°‹ë˜ì–´ ì ì¬ëœ ë°ì´í„°ëŠ” ì¤‘ë³µí‚¤ ì—ëŸ¬ ì²˜ë¦¬ëœë‹¤. â ì„¸ë²ˆì§¸ ì‹œë„, Redis ì— ë™ì‹œì„± ì œì–´ë¥¼ ìœ„í•œ í‚¤ ì¶”ê°€ ê°„í—ì ì¸ ë°ë“œë½ì´ê³ , ìœ„ ì„œë¹„ìŠ¤ì—ì„œ Redisë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ ìºì‹œ ë¦¬ì†ŒìŠ¤ê°€ ë” í´ ê²ƒ ê°™ì•„ ë‚˜ê°€ë¦¬! â ë„¤ë²ˆì§¸ ì‹œë„, ìš”ì²­ ì œí•œ Bucket4jë¥¼ ì´ìš©í•´ì„œ í´ë¼ì´ì–¸íŠ¸ê°€ íŠ¹ì • ì‹œê°„ í”„ë ˆì„ ë‚´ì— ë§Œë“¤ ìˆ˜ ìˆëŠ” API í˜¸ì¶œ ìˆ˜ë¥¼ ì œí•œí•œë‹¤. ìœ„ ì„œë¹„ìŠ¤ëŠ” ì„œë²„ê°€ ì—¬ëŸ¬ëŒ€ì¸ ê²½ìš°ë¼ì„œ ë‹¤ë¥¸ ì„œë²„ë¡œ ë™ì‹œ ìš”ì²­ì´ ë“¤ì–´ê°€ëŠ” ê²½ìš°, ë°ë“œë½ ë°©ì§€ ë¶ˆê°€ëŠ¥ ì •ë¦¬ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°, ì‚­ì œ ì¿¼ë¦¬ë¥¼ ë‚ ë¦¬ë©´ delete, select ëŠ” ê°€ëŠ¥í•˜ì§€ë§Œ insert ì‹œì— ë½ì„ ê¸°ë‹¤ë¦¬ê²Œ ëœë‹¤. ë½ì´ ê¶ê¸ˆí•˜ë‹¤ë©´, MySQL ê³µì‹ë¬¸ì„œ ì¤‘ InnoDB Lock ë©”ë‰´ì–¼ì„ ì°¸ê³ í•´ë³´ì. (ì˜ˆì œì™€ í•¨ê»˜ ì •ë¦¬ê°€ ë„ˆë¬´ ì˜ ë˜ì–´ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.) í¥ë¯¸ë¡œìš´ ì‹¤í—˜ ì¸ë±ìŠ¤ê°€ ê±¸ë¦° ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ì¿¼ë¦¬ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ì—ëŠ”, 2ë²ˆì§¸ íŠ¸ëœì­ì…˜ì—ì„œ delete ì‹œì— ë½ íšë“ì„ ê¸°ë‹¤ë¦°ë‹¤. BEGIN ; DELETE FROM child_index WHERE parent_id = 1; INSERT INTO child_index VALUES (1, &#39;child_index_1&#39;, 1); COMMIT ; ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ì—ëŠ”, 2ë²ˆì§¸ íŠ¸ëœì­ì…˜ì—ì„œ delete ì‹œì— ë½ íšë“ì´ ë°”ë¡œ ê°€ëŠ¥í•˜ë‹¤. BEGIN ; DELETE FROM child_index WHERE parent_id = 1; INSERT INTO child_index VALUES (1, &#39;child_index_1&#39;, 1); COMMIT ; ì¸ë±ìŠ¤ê°€ ê±¸ë¦¬ì§€ ì•Šì€ ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ì¿¼ë¦¬ ë°ì´í„°ê°€ ìˆëŠ” / ì—†ëŠ” ê²½ìš°, 2ë²ˆì§¸ íŠ¸ëœì­ì…˜ì—ì„œ delete ì‹œì— ë½ íšë“ì„ ê¸°ë‹¤ë¦°ë‹¤. BEGIN ; DELETE FROM child_index WHERE name = &#39;child_index_2&#39;; INSERT INTO child_index VALUES (1, &#39;child_index_1&#39;, 1); COMMIT ; ê¸°ë¡ìš© SHOW ENGINE innodb STATUS; *** (1) TRANSACTION:TRANSACTION 13034, ACTIVE 6 sec insertingmysql tables in use 1, locked 1LOCK WAIT 4 lock struct(s), heap size 1128, 3 row lock(s), undo log entries 1MySQL thread id 280, OS thread handle 6136639488, query id 21716 localhost 127.0.0.1 root update/* ApplicationName=DataGrip 2022.3.2 */ insert into child values (&#39;2&#39;, &#39;name2&#39;, 2) *** (1) HOLDS THE LOCK(S):RECORD LOCKS space id 154 page no 4 n bits 72 index PRIMARY of table jpa.child trx id 13034 lock_mode X locks rec but not gapRecord lock, heap no 3 PHYSICAL RECORD: n_fields 5; compact format; info bits 0 *** (1) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 154 page no 5 n bits 72 index parent_id of table jpa.child trx id 13034 lock_mode X insert intention waitingRecord lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0 *** (2) TRANSACTION:TRANSACTION 13035, ACTIVE 4 sec insertingmysql tables in use 1, locked 1LOCK WAIT 3 lock struct(s), heap size 1128, 2 row lock(s)MySQL thread id 281, OS thread handle 6135525376, query id 21726 localhost 127.0.0.1 root update/* ApplicationName=DataGrip 2022.3.2 */ insert into child values (&#39;2&#39;, &#39;name2&#39;, 2) *** (2) HOLDS THE LOCK(S):RECORD LOCKS space id 154 page no 5 n bits 72 index parent_id of table jpa.child trx id 13035 lock_mode XRecord lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0 *** (2) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 154 page no 4 n bits 72 index PRIMARY of table jpa.child trx id 13035 lock mode S locks rec but not gap waitingRecord lock, heap no 3 PHYSICAL RECORD: n_fields 5; compact format; info bits 0 - SELECT * FROM performance_schema.data_locks; | INDEX\_NAME | OBJECT\_INSTANCE\_BEGIN | LOCK\_TYPE | LOCK\_MODE | LOCK\_STATUS | LOCK\_DATA | | :--- | :--- | :--- | :--- | :--- | :--- | | null | 4813003272 | TABLE | IX | GRANTED | null | | parent\_id | 4823656472 | RECORD | X | GRANTED | supremum pseudo-record | | parent\_id | 4823656816 | RECORD | X,INSERT\_INTENTION | GRANTED | supremum pseudo-record | | parent\_id | 4823657160 | RECORD | X,GAP | GRANTED | 1, 1 |" />
<meta property="og:description" content="ì—­ì‹œ í•´ì¹˜ì› ë‚˜ë¥¼ ì™¸ì¹˜ë©´ ì•ˆ ë˜ëŠ” ê²ƒì¸ê°€â€¦ ë˜ ìš¸ê¸° ì‹œì‘í•œ í˜í˜â€¦ (ê·¸ë§Œ ìš¸ì–´ì‡!) ì˜ë¯¸ìˆëŠ” ê²½í—˜ìœ¼ë¡œ ë‚¨ê¸°ê¸°ìœ„í•´ ê¸°ë¡í•´ë³´ì. ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ìƒí™© ë‹¤ì‹œ ì¬í˜„ í˜„ì¬ í…Œì´ë¸” ìƒíƒœ CREATE TABLE parent ( id bigint not null primary key, name varchar(255) null, updated_at datetime(6) null ); CREATE TABLE child ( id bigint not null primary key, name varchar(255) null, parent_id bigint null, CONSTRAINT parent_id_unique UNIQUE (parent_id) ); CREATE TABLE child_index ( id bigint not null primary key, name varchar(255) null, parent_id bigint null, ); CREATE INDEX parent_id ON child_index (parent_id); INSERT INTO parent VALUES (1, &#39;parent_1&#39;, NOW()); parent í…Œì´ë¸”ì˜ idë¥¼ indexë¡œ ê°€ì§€ê³  ìˆëŠ” child_index í…Œì´ë¸” ìƒì„±(ì™¸ë˜í‚¤ëŠ” ìš´ì˜ì—ì„œ ì‚­ì œë˜ì–´ì„œ í…ŒìŠ¤íŠ¸ì‹œ ê³ ë ¤í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤) parent í…Œì´ë¸”ì˜ idë¥¼ ìœ ë‹ˆí¬ í‚¤ë¡œ ê°€ì§€ê³  ìˆëŠ” child í…Œì´ë¸” ìƒì„±(ë§ˆì°¬ê°€ì§€ë¡œ ì™¸ë˜í‚¤ ê³ ë ¤í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.) parent í…Œì´ë¸”ì— í…ŒìŠ¤íŠ¸ ë°ì´í„° ì ì¬ ê·¸ëŸ¼ ì´ì œ ë°ë“œë½ì„ ë°œìƒì‹œì¼œ ë³´ì index ê±¸ë ¤ìˆëŠ” row delete â†’ index ê±¸ë ¤ìˆëŠ” ìì‹ row insertê°€ ë‘ê°œì˜ ì„¸ì…˜ì—ì„œ ìˆ˜í–‰ë˜ë©´, ë°ë“œë½ì´ ë°œìƒ ğŸ’£ TX1 TX2 lock BEGIN ; DELETE FROM child_index WHERE parent_id = 2; Â  (1) child X Lock ì¸ë°, TX2ì—ì„œ X Lock íšë“ ê°€ëŠ¥í• ê¹Œ ğŸ¤” Â  BEGIN ; DELETE FROM child_index WHERE parent_id = 2; (2) child X Lock INSERT INTO child_index VALUES (â€˜1â€™, â€˜name2â€™, 2); Â  (3) child X,INSERT_INTENTION Lock ëŒ€ê¸° Â  INSERT INTO child_index VALUES (â€˜2â€™, â€˜name2â€™, 2); (4) child X,INSERT_INTENTION Lock ëŒ€ê¸° Â  Deadlock found when trying to get lock; try restarting transaction (4) child X lock ì´ í•„ìš”í•˜ì§€ë§Œ, (2) ì—ì„œ child X lock ìƒíƒœ (4) í•´ì†Œë¥¼ ìœ„í•´ì„œ (3) í•´ì†Œ í•„ìš” -&gt; (3) í•´ì†Œ ìœ„í•´ì„œ TX2 ì»¤ë°‹ í•„ìš” -&gt; TX2 ì»¤ë°‹í•˜ë ¤ë©´ (4) í•´ì†Œ í•„ìš” -&gt; ë°ë“œë½ ë°œìƒ ìš´ì˜í™˜ê²½ì—ì„œ ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ë¡œì§ì„ ì‚´í´ë³´ì index ê±¸ë ¤ìˆëŠ” row delete â†’ index ê±¸ë ¤ìˆëŠ” ìì‹ row insertê°€ ë‘ê°œì˜ ì„¸ì…˜ì—ì„œ ìˆ˜í–‰ë˜ë©´, ë°ë“œë½ì´ ë°œìƒ ğŸ’£ SELECT * from parent WHERE id = 1; INSERT INTO child VALUES (1, &#39;child_1&#39;, 1); DELETE FROM child_index WHERE parent_id = 1; INSERT INTO child_index VALUES (1, &#39;child_index_1&#39;, 1); UPDATE parent SET updated_at = NOW() WHERE id = 1; @Transactional public void createChildAndChildIndex (long parentId) { var parent = parentRepository.findById(parentId); childIndexRepository.deleteByParent(parent); childIndexRepository.save(new Child_Index(&#39;child_index_1&#39;, parent)); } í•œê°€ì§€ ì‹ ê¸°í•œ ì ì€ delete í•˜ë ¤ëŠ” ë°ì´í„°ê°€ ì—†ì„ ë•Œ, ë°ë“œë½ì´ ë°œìƒí•œë‹¤. delete í•˜ë ¤ëŠ” ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ì—ëŠ” ê°™ì€ ë¡œì§ì„ ìˆ˜í–‰í•˜ë©´ ë½ì„ ì¡ì„ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê²Œ ëœë‹¤. ì›ì¸ì€ ì•Œì•˜ê³ , ì„œë²„ì—ì„œ ë°ë“œë½ì„ í•´ê²°í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ê³ ë¯¼í•´ë³´ì â ì²«ë²ˆì§¸ ì‹œë„, ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ row ì‚­ì œ @Transactional public void createParent (long parentId) { var parent = parentRepository.findById(parentId); if(childIndexRepository.findByParent(parent).isPresent()) { childIndexRepository.deleteByParent(parent); } childIndexRepository.save(new Child_Index(&#39;child_index_1&#39;, parent)); } ë¬´ì¡°ê±´ delete í•˜ëŠ” ë¡œì§ìœ¼ë¡œ ì¸í•œ ë°°íƒ€ë½ì€ ë°©ì§€ ê°€ëŠ¥í•˜ë‹¤. ë™ì‹œ ìš”ì²­ì‹œì— childIndexRepository.findByParent ì— ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ë¡œ ë¶„ê¸°ì²˜ë¦¬ë˜ëŠ” ê²½ìš°, ë°ì´í„°ê°€ 2ë°°ë¡œ ì ì¬ë  ìˆ˜ ìˆë‹¤. 300ms ë¡œ ì“°ë ˆë“œ sleep() ê±¸ì–´ì„œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ 2ë°°ë¡œ ìŒ“ì´ëŠ” ê²ƒì„ í™•ì¸ âœ… ë‘ë²ˆì§¸ ì‹œë„, ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ row ì‚­ì œí•˜ë©´ì„œ ìœ ë‹ˆí¬ ì¡°ê±´ ì¶”ê°€ CREATE TABLE child_index ( id bigint not null primary key, name varchar(255) null, parent_id bigint null, CONSTRAINT parent_id_unique UNIQUE (parent_id) ); CREATE INDEX parent_id ON child_index (parent_id); ë™ì‹œ ìš”ì²­ì‹œì— childIndexRepository.findByParent ì— ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ë¡œ ë¶„ê¸°ì²˜ë¦¬ë˜ëŠ” ê²½ìš°, í›„ì— ì»¤ë°‹ë˜ì–´ ì ì¬ëœ ë°ì´í„°ëŠ” ì¤‘ë³µí‚¤ ì—ëŸ¬ ì²˜ë¦¬ëœë‹¤. â ì„¸ë²ˆì§¸ ì‹œë„, Redis ì— ë™ì‹œì„± ì œì–´ë¥¼ ìœ„í•œ í‚¤ ì¶”ê°€ ê°„í—ì ì¸ ë°ë“œë½ì´ê³ , ìœ„ ì„œë¹„ìŠ¤ì—ì„œ Redisë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ ìºì‹œ ë¦¬ì†ŒìŠ¤ê°€ ë” í´ ê²ƒ ê°™ì•„ ë‚˜ê°€ë¦¬! â ë„¤ë²ˆì§¸ ì‹œë„, ìš”ì²­ ì œí•œ Bucket4jë¥¼ ì´ìš©í•´ì„œ í´ë¼ì´ì–¸íŠ¸ê°€ íŠ¹ì • ì‹œê°„ í”„ë ˆì„ ë‚´ì— ë§Œë“¤ ìˆ˜ ìˆëŠ” API í˜¸ì¶œ ìˆ˜ë¥¼ ì œí•œí•œë‹¤. ìœ„ ì„œë¹„ìŠ¤ëŠ” ì„œë²„ê°€ ì—¬ëŸ¬ëŒ€ì¸ ê²½ìš°ë¼ì„œ ë‹¤ë¥¸ ì„œë²„ë¡œ ë™ì‹œ ìš”ì²­ì´ ë“¤ì–´ê°€ëŠ” ê²½ìš°, ë°ë“œë½ ë°©ì§€ ë¶ˆê°€ëŠ¥ ì •ë¦¬ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°, ì‚­ì œ ì¿¼ë¦¬ë¥¼ ë‚ ë¦¬ë©´ delete, select ëŠ” ê°€ëŠ¥í•˜ì§€ë§Œ insert ì‹œì— ë½ì„ ê¸°ë‹¤ë¦¬ê²Œ ëœë‹¤. ë½ì´ ê¶ê¸ˆí•˜ë‹¤ë©´, MySQL ê³µì‹ë¬¸ì„œ ì¤‘ InnoDB Lock ë©”ë‰´ì–¼ì„ ì°¸ê³ í•´ë³´ì. (ì˜ˆì œì™€ í•¨ê»˜ ì •ë¦¬ê°€ ë„ˆë¬´ ì˜ ë˜ì–´ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.) í¥ë¯¸ë¡œìš´ ì‹¤í—˜ ì¸ë±ìŠ¤ê°€ ê±¸ë¦° ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ì¿¼ë¦¬ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ì—ëŠ”, 2ë²ˆì§¸ íŠ¸ëœì­ì…˜ì—ì„œ delete ì‹œì— ë½ íšë“ì„ ê¸°ë‹¤ë¦°ë‹¤. BEGIN ; DELETE FROM child_index WHERE parent_id = 1; INSERT INTO child_index VALUES (1, &#39;child_index_1&#39;, 1); COMMIT ; ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ì—ëŠ”, 2ë²ˆì§¸ íŠ¸ëœì­ì…˜ì—ì„œ delete ì‹œì— ë½ íšë“ì´ ë°”ë¡œ ê°€ëŠ¥í•˜ë‹¤. BEGIN ; DELETE FROM child_index WHERE parent_id = 1; INSERT INTO child_index VALUES (1, &#39;child_index_1&#39;, 1); COMMIT ; ì¸ë±ìŠ¤ê°€ ê±¸ë¦¬ì§€ ì•Šì€ ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ì¿¼ë¦¬ ë°ì´í„°ê°€ ìˆëŠ” / ì—†ëŠ” ê²½ìš°, 2ë²ˆì§¸ íŠ¸ëœì­ì…˜ì—ì„œ delete ì‹œì— ë½ íšë“ì„ ê¸°ë‹¤ë¦°ë‹¤. BEGIN ; DELETE FROM child_index WHERE name = &#39;child_index_2&#39;; INSERT INTO child_index VALUES (1, &#39;child_index_1&#39;, 1); COMMIT ; ê¸°ë¡ìš© SHOW ENGINE innodb STATUS; *** (1) TRANSACTION:TRANSACTION 13034, ACTIVE 6 sec insertingmysql tables in use 1, locked 1LOCK WAIT 4 lock struct(s), heap size 1128, 3 row lock(s), undo log entries 1MySQL thread id 280, OS thread handle 6136639488, query id 21716 localhost 127.0.0.1 root update/* ApplicationName=DataGrip 2022.3.2 */ insert into child values (&#39;2&#39;, &#39;name2&#39;, 2) *** (1) HOLDS THE LOCK(S):RECORD LOCKS space id 154 page no 4 n bits 72 index PRIMARY of table jpa.child trx id 13034 lock_mode X locks rec but not gapRecord lock, heap no 3 PHYSICAL RECORD: n_fields 5; compact format; info bits 0 *** (1) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 154 page no 5 n bits 72 index parent_id of table jpa.child trx id 13034 lock_mode X insert intention waitingRecord lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0 *** (2) TRANSACTION:TRANSACTION 13035, ACTIVE 4 sec insertingmysql tables in use 1, locked 1LOCK WAIT 3 lock struct(s), heap size 1128, 2 row lock(s)MySQL thread id 281, OS thread handle 6135525376, query id 21726 localhost 127.0.0.1 root update/* ApplicationName=DataGrip 2022.3.2 */ insert into child values (&#39;2&#39;, &#39;name2&#39;, 2) *** (2) HOLDS THE LOCK(S):RECORD LOCKS space id 154 page no 5 n bits 72 index parent_id of table jpa.child trx id 13035 lock_mode XRecord lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0 *** (2) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 154 page no 4 n bits 72 index PRIMARY of table jpa.child trx id 13035 lock mode S locks rec but not gap waitingRecord lock, heap no 3 PHYSICAL RECORD: n_fields 5; compact format; info bits 0 - SELECT * FROM performance_schema.data_locks; | INDEX\_NAME | OBJECT\_INSTANCE\_BEGIN | LOCK\_TYPE | LOCK\_MODE | LOCK\_STATUS | LOCK\_DATA | | :--- | :--- | :--- | :--- | :--- | :--- | | null | 4813003272 | TABLE | IX | GRANTED | null | | parent\_id | 4823656472 | RECORD | X | GRANTED | supremum pseudo-record | | parent\_id | 4823656816 | RECORD | X,INSERT\_INTENTION | GRANTED | supremum pseudo-record | | parent\_id | 4823657160 | RECORD | X,GAP | GRANTED | 1, 1 |" />
<link rel="canonical" href="https://hocaron.github.io/ko/dead-lock-by-index/" />
<meta property="og:url" content="https://hocaron.github.io/dead-lock-by-index/" />
<meta property="og:site_name" content="this.hocaron" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-05-23T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="[Troubleshooting - DB] ì¸ë±ìŠ¤(Index)ì™€ ë°ë“œë½(DeadLock)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Hocaron","url":"https://hocaron.github.io"},"dateModified":"2023-05-23T00:00:00+00:00","datePublished":"2023-05-23T00:00:00+00:00","description":"ì—­ì‹œ í•´ì¹˜ì› ë‚˜ë¥¼ ì™¸ì¹˜ë©´ ì•ˆ ë˜ëŠ” ê²ƒì¸ê°€â€¦ ë˜ ìš¸ê¸° ì‹œì‘í•œ í˜í˜â€¦ (ê·¸ë§Œ ìš¸ì–´ì‡!) ì˜ë¯¸ìˆëŠ” ê²½í—˜ìœ¼ë¡œ ë‚¨ê¸°ê¸°ìœ„í•´ ê¸°ë¡í•´ë³´ì. ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ìƒí™© ë‹¤ì‹œ ì¬í˜„ í˜„ì¬ í…Œì´ë¸” ìƒíƒœ CREATE TABLE parent ( id bigint not null primary key, name varchar(255) null, updated_at datetime(6) null ); CREATE TABLE child ( id bigint not null primary key, name varchar(255) null, parent_id bigint null, CONSTRAINT parent_id_unique UNIQUE (parent_id) ); CREATE TABLE child_index ( id bigint not null primary key, name varchar(255) null, parent_id bigint null, ); CREATE INDEX parent_id ON child_index (parent_id); INSERT INTO parent VALUES (1, &#39;parent_1&#39;, NOW()); parent í…Œì´ë¸”ì˜ idë¥¼ indexë¡œ ê°€ì§€ê³  ìˆëŠ” child_index í…Œì´ë¸” ìƒì„±(ì™¸ë˜í‚¤ëŠ” ìš´ì˜ì—ì„œ ì‚­ì œë˜ì–´ì„œ í…ŒìŠ¤íŠ¸ì‹œ ê³ ë ¤í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤) parent í…Œì´ë¸”ì˜ idë¥¼ ìœ ë‹ˆí¬ í‚¤ë¡œ ê°€ì§€ê³  ìˆëŠ” child í…Œì´ë¸” ìƒì„±(ë§ˆì°¬ê°€ì§€ë¡œ ì™¸ë˜í‚¤ ê³ ë ¤í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.) parent í…Œì´ë¸”ì— í…ŒìŠ¤íŠ¸ ë°ì´í„° ì ì¬ ê·¸ëŸ¼ ì´ì œ ë°ë“œë½ì„ ë°œìƒì‹œì¼œ ë³´ì index ê±¸ë ¤ìˆëŠ” row delete â†’ index ê±¸ë ¤ìˆëŠ” ìì‹ row insertê°€ ë‘ê°œì˜ ì„¸ì…˜ì—ì„œ ìˆ˜í–‰ë˜ë©´, ë°ë“œë½ì´ ë°œìƒ ğŸ’£ TX1 TX2 lock BEGIN ; DELETE FROM child_index WHERE parent_id = 2; Â  (1) child X Lock ì¸ë°, TX2ì—ì„œ X Lock íšë“ ê°€ëŠ¥í• ê¹Œ ğŸ¤” Â  BEGIN ; DELETE FROM child_index WHERE parent_id = 2; (2) child X Lock INSERT INTO child_index VALUES (â€˜1â€™, â€˜name2â€™, 2); Â  (3) child X,INSERT_INTENTION Lock ëŒ€ê¸° Â  INSERT INTO child_index VALUES (â€˜2â€™, â€˜name2â€™, 2); (4) child X,INSERT_INTENTION Lock ëŒ€ê¸° Â  Deadlock found when trying to get lock; try restarting transaction (4) child X lock ì´ í•„ìš”í•˜ì§€ë§Œ, (2) ì—ì„œ child X lock ìƒíƒœ (4) í•´ì†Œë¥¼ ìœ„í•´ì„œ (3) í•´ì†Œ í•„ìš” -&gt; (3) í•´ì†Œ ìœ„í•´ì„œ TX2 ì»¤ë°‹ í•„ìš” -&gt; TX2 ì»¤ë°‹í•˜ë ¤ë©´ (4) í•´ì†Œ í•„ìš” -&gt; ë°ë“œë½ ë°œìƒ ìš´ì˜í™˜ê²½ì—ì„œ ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ë¡œì§ì„ ì‚´í´ë³´ì index ê±¸ë ¤ìˆëŠ” row delete â†’ index ê±¸ë ¤ìˆëŠ” ìì‹ row insertê°€ ë‘ê°œì˜ ì„¸ì…˜ì—ì„œ ìˆ˜í–‰ë˜ë©´, ë°ë“œë½ì´ ë°œìƒ ğŸ’£ SELECT * from parent WHERE id = 1; INSERT INTO child VALUES (1, &#39;child_1&#39;, 1); DELETE FROM child_index WHERE parent_id = 1; INSERT INTO child_index VALUES (1, &#39;child_index_1&#39;, 1); UPDATE parent SET updated_at = NOW() WHERE id = 1; @Transactional public void createChildAndChildIndex (long parentId) { var parent = parentRepository.findById(parentId); childIndexRepository.deleteByParent(parent); childIndexRepository.save(new Child_Index(&#39;child_index_1&#39;, parent)); } í•œê°€ì§€ ì‹ ê¸°í•œ ì ì€ delete í•˜ë ¤ëŠ” ë°ì´í„°ê°€ ì—†ì„ ë•Œ, ë°ë“œë½ì´ ë°œìƒí•œë‹¤. delete í•˜ë ¤ëŠ” ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ì—ëŠ” ê°™ì€ ë¡œì§ì„ ìˆ˜í–‰í•˜ë©´ ë½ì„ ì¡ì„ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê²Œ ëœë‹¤. ì›ì¸ì€ ì•Œì•˜ê³ , ì„œë²„ì—ì„œ ë°ë“œë½ì„ í•´ê²°í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ê³ ë¯¼í•´ë³´ì â ì²«ë²ˆì§¸ ì‹œë„, ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ row ì‚­ì œ @Transactional public void createParent (long parentId) { var parent = parentRepository.findById(parentId); if(childIndexRepository.findByParent(parent).isPresent()) { childIndexRepository.deleteByParent(parent); } childIndexRepository.save(new Child_Index(&#39;child_index_1&#39;, parent)); } ë¬´ì¡°ê±´ delete í•˜ëŠ” ë¡œì§ìœ¼ë¡œ ì¸í•œ ë°°íƒ€ë½ì€ ë°©ì§€ ê°€ëŠ¥í•˜ë‹¤. ë™ì‹œ ìš”ì²­ì‹œì— childIndexRepository.findByParent ì— ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ë¡œ ë¶„ê¸°ì²˜ë¦¬ë˜ëŠ” ê²½ìš°, ë°ì´í„°ê°€ 2ë°°ë¡œ ì ì¬ë  ìˆ˜ ìˆë‹¤. 300ms ë¡œ ì“°ë ˆë“œ sleep() ê±¸ì–´ì„œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ 2ë°°ë¡œ ìŒ“ì´ëŠ” ê²ƒì„ í™•ì¸ âœ… ë‘ë²ˆì§¸ ì‹œë„, ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ row ì‚­ì œí•˜ë©´ì„œ ìœ ë‹ˆí¬ ì¡°ê±´ ì¶”ê°€ CREATE TABLE child_index ( id bigint not null primary key, name varchar(255) null, parent_id bigint null, CONSTRAINT parent_id_unique UNIQUE (parent_id) ); CREATE INDEX parent_id ON child_index (parent_id); ë™ì‹œ ìš”ì²­ì‹œì— childIndexRepository.findByParent ì— ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ë¡œ ë¶„ê¸°ì²˜ë¦¬ë˜ëŠ” ê²½ìš°, í›„ì— ì»¤ë°‹ë˜ì–´ ì ì¬ëœ ë°ì´í„°ëŠ” ì¤‘ë³µí‚¤ ì—ëŸ¬ ì²˜ë¦¬ëœë‹¤. â ì„¸ë²ˆì§¸ ì‹œë„, Redis ì— ë™ì‹œì„± ì œì–´ë¥¼ ìœ„í•œ í‚¤ ì¶”ê°€ ê°„í—ì ì¸ ë°ë“œë½ì´ê³ , ìœ„ ì„œë¹„ìŠ¤ì—ì„œ Redisë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ ìºì‹œ ë¦¬ì†ŒìŠ¤ê°€ ë” í´ ê²ƒ ê°™ì•„ ë‚˜ê°€ë¦¬! â ë„¤ë²ˆì§¸ ì‹œë„, ìš”ì²­ ì œí•œ Bucket4jë¥¼ ì´ìš©í•´ì„œ í´ë¼ì´ì–¸íŠ¸ê°€ íŠ¹ì • ì‹œê°„ í”„ë ˆì„ ë‚´ì— ë§Œë“¤ ìˆ˜ ìˆëŠ” API í˜¸ì¶œ ìˆ˜ë¥¼ ì œí•œí•œë‹¤. ìœ„ ì„œë¹„ìŠ¤ëŠ” ì„œë²„ê°€ ì—¬ëŸ¬ëŒ€ì¸ ê²½ìš°ë¼ì„œ ë‹¤ë¥¸ ì„œë²„ë¡œ ë™ì‹œ ìš”ì²­ì´ ë“¤ì–´ê°€ëŠ” ê²½ìš°, ë°ë“œë½ ë°©ì§€ ë¶ˆê°€ëŠ¥ ì •ë¦¬ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°, ì‚­ì œ ì¿¼ë¦¬ë¥¼ ë‚ ë¦¬ë©´ delete, select ëŠ” ê°€ëŠ¥í•˜ì§€ë§Œ insert ì‹œì— ë½ì„ ê¸°ë‹¤ë¦¬ê²Œ ëœë‹¤. ë½ì´ ê¶ê¸ˆí•˜ë‹¤ë©´, MySQL ê³µì‹ë¬¸ì„œ ì¤‘ InnoDB Lock ë©”ë‰´ì–¼ì„ ì°¸ê³ í•´ë³´ì. (ì˜ˆì œì™€ í•¨ê»˜ ì •ë¦¬ê°€ ë„ˆë¬´ ì˜ ë˜ì–´ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.) í¥ë¯¸ë¡œìš´ ì‹¤í—˜ ì¸ë±ìŠ¤ê°€ ê±¸ë¦° ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ì¿¼ë¦¬ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ì—ëŠ”, 2ë²ˆì§¸ íŠ¸ëœì­ì…˜ì—ì„œ delete ì‹œì— ë½ íšë“ì„ ê¸°ë‹¤ë¦°ë‹¤. BEGIN ; DELETE FROM child_index WHERE parent_id = 1; INSERT INTO child_index VALUES (1, &#39;child_index_1&#39;, 1); COMMIT ; ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ì—ëŠ”, 2ë²ˆì§¸ íŠ¸ëœì­ì…˜ì—ì„œ delete ì‹œì— ë½ íšë“ì´ ë°”ë¡œ ê°€ëŠ¥í•˜ë‹¤. BEGIN ; DELETE FROM child_index WHERE parent_id = 1; INSERT INTO child_index VALUES (1, &#39;child_index_1&#39;, 1); COMMIT ; ì¸ë±ìŠ¤ê°€ ê±¸ë¦¬ì§€ ì•Šì€ ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ì¿¼ë¦¬ ë°ì´í„°ê°€ ìˆëŠ” / ì—†ëŠ” ê²½ìš°, 2ë²ˆì§¸ íŠ¸ëœì­ì…˜ì—ì„œ delete ì‹œì— ë½ íšë“ì„ ê¸°ë‹¤ë¦°ë‹¤. BEGIN ; DELETE FROM child_index WHERE name = &#39;child_index_2&#39;; INSERT INTO child_index VALUES (1, &#39;child_index_1&#39;, 1); COMMIT ; ê¸°ë¡ìš© SHOW ENGINE innodb STATUS; *** (1) TRANSACTION:TRANSACTION 13034, ACTIVE 6 sec insertingmysql tables in use 1, locked 1LOCK WAIT 4 lock struct(s), heap size 1128, 3 row lock(s), undo log entries 1MySQL thread id 280, OS thread handle 6136639488, query id 21716 localhost 127.0.0.1 root update/* ApplicationName=DataGrip 2022.3.2 */ insert into child values (&#39;2&#39;, &#39;name2&#39;, 2) *** (1) HOLDS THE LOCK(S):RECORD LOCKS space id 154 page no 4 n bits 72 index PRIMARY of table jpa.child trx id 13034 lock_mode X locks rec but not gapRecord lock, heap no 3 PHYSICAL RECORD: n_fields 5; compact format; info bits 0 *** (1) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 154 page no 5 n bits 72 index parent_id of table jpa.child trx id 13034 lock_mode X insert intention waitingRecord lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0 *** (2) TRANSACTION:TRANSACTION 13035, ACTIVE 4 sec insertingmysql tables in use 1, locked 1LOCK WAIT 3 lock struct(s), heap size 1128, 2 row lock(s)MySQL thread id 281, OS thread handle 6135525376, query id 21726 localhost 127.0.0.1 root update/* ApplicationName=DataGrip 2022.3.2 */ insert into child values (&#39;2&#39;, &#39;name2&#39;, 2) *** (2) HOLDS THE LOCK(S):RECORD LOCKS space id 154 page no 5 n bits 72 index parent_id of table jpa.child trx id 13035 lock_mode XRecord lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0 *** (2) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 154 page no 4 n bits 72 index PRIMARY of table jpa.child trx id 13035 lock mode S locks rec but not gap waitingRecord lock, heap no 3 PHYSICAL RECORD: n_fields 5; compact format; info bits 0 - SELECT * FROM performance_schema.data_locks; | INDEX\\_NAME | OBJECT\\_INSTANCE\\_BEGIN | LOCK\\_TYPE | LOCK\\_MODE | LOCK\\_STATUS | LOCK\\_DATA | | :--- | :--- | :--- | :--- | :--- | :--- | | null | 4813003272 | TABLE | IX | GRANTED | null | | parent\\_id | 4823656472 | RECORD | X | GRANTED | supremum pseudo-record | | parent\\_id | 4823656816 | RECORD | X,INSERT\\_INTENTION | GRANTED | supremum pseudo-record | | parent\\_id | 4823657160 | RECORD | X,GAP | GRANTED | 1, 1 |","headline":"[Troubleshooting - DB] ì¸ë±ìŠ¤(Index)ì™€ ë°ë“œë½(DeadLock)","mainEntityOfPage":{"@type":"WebPage","@id":"https://hocaron.github.io/dead-lock-by-index/"},"url":"https://hocaron.github.io/dead-lock-by-index/"}</script>
<!-- End Jekyll SEO tag -->


  <!-- CSS -->
  <link rel="stylesheet" href="/ko/assets/main.css">
  <link rel="stylesheet" href="../assets/main.js">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/all.min.css" />

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/ko/assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/ko/assets/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/ko/assets/apple-touch-icon.png">

  <!-- RSS -->
  <link type="application/atom+xml" rel="alternate" href="https://hocaron.github.io/ko/feed.xml" title="this.hocaron" />

  <!-- Google Analytics-->
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UAâ€”XXXXXXXX-X', 'auto');
  ga('send', 'pageview');
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

  <!-- JavaScript -->
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script type="text/javascript" src="../assets/main.js"></script>

  <!-- SEO for Polyglot -->
  
</head>


<body>
<div>
  




<nav class="nav">
  <div class="nav-container">
    <a href="/ko/">
      <h2 class="nav-title">this.hocaron</h2>
    </a>
    <ul>
      <li class="selected">
      <a href="/ko/">Posts</a>
      </li>
      <li >
        <a href="/ko/series">Series</a>
      </li>
      <li >
        <a href="/ko/about">About</a>
      </li>

      <li>
        
        
        
        <a class="lang active"
           href="
                /ko/dead-lock-by-index/
              ">
          KOR
          |
        </a>
        
        
        
        <a class="lang "
           href="
                /dead-lock-by-index/
              ">
          ENG
          
        </a>
        
      </li>

    </ul>
  </div>
</nav>


  <main>
    <div class="post">
  <div class="post-info">
<!--    <span>Written by</span>-->
<!--    -->
<!--        Hocaron-->
<!--    -->

    
      <br>
      <span>on&nbsp;</span><time datetime="2023-05-23 00:00:00 +0000">May 23, 2023</time>
    
  </div>

  <h1 class="post-title">[Troubleshooting - DB] ì¸ë±ìŠ¤(Index)ì™€ ë°ë“œë½(DeadLock)</h1>
<!--  <div class="post-line"></div>-->
  <article class="post-article">
    <div class="toc">
      <ul><li><a href="#ë°ë“œë½ì´-ë°œìƒí•˜ëŠ”-ìƒí™©-ë‹¤ì‹œ-ì¬í˜„">ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ìƒí™© ë‹¤ì‹œ ì¬í˜„</a><ul><li><a href="#í˜„ì¬-í…Œì´ë¸”-ìƒíƒœ">í˜„ì¬ í…Œì´ë¸” ìƒíƒœ</a></li><li><a href="#ê·¸ëŸ¼-ì´ì œ-ë°ë“œë½ì„-ë°œìƒì‹œì¼œ-ë³´ì">ê·¸ëŸ¼ ì´ì œ ë°ë“œë½ì„ ë°œìƒì‹œì¼œ ë³´ì</a></li><li><a href="#index-ê±¸ë ¤ìˆëŠ”-row-delete---index-ê±¸ë ¤ìˆëŠ”-ìì‹-row-insertê°€-ë‘ê°œì˜-ì„¸ì…˜ì—ì„œ-ìˆ˜í–‰ë˜ë©´-ë°ë“œë½ì´-ë°œìƒ-">index ê±¸ë ¤ìˆëŠ” row delete â†’  index ê±¸ë ¤ìˆëŠ” ìì‹ row insertê°€ ë‘ê°œì˜ ì„¸ì…˜ì—ì„œ ìˆ˜í–‰ë˜ë©´, ë°ë“œë½ì´ ë°œìƒ ğŸ’£</a></li></ul></li><li><a href="#ìš´ì˜í™˜ê²½ì—ì„œ-ë°ë“œë½ì´-ë°œìƒí•˜ëŠ”-ë¡œì§ì„-ì‚´í´ë³´ì">ìš´ì˜í™˜ê²½ì—ì„œ ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ë¡œì§ì„ ì‚´í´ë³´ì</a><ul><li><a href="#index-ê±¸ë ¤ìˆëŠ”-row-delete---index-ê±¸ë ¤ìˆëŠ”-ìì‹-row-insertê°€-ë‘ê°œì˜-ì„¸ì…˜ì—ì„œ-ìˆ˜í–‰ë˜ë©´-ë°ë“œë½ì´-ë°œìƒ--1">index ê±¸ë ¤ìˆëŠ” row delete â†’  index ê±¸ë ¤ìˆëŠ” ìì‹ row insertê°€ ë‘ê°œì˜ ì„¸ì…˜ì—ì„œ ìˆ˜í–‰ë˜ë©´, ë°ë“œë½ì´ ë°œìƒ ğŸ’£</a></li></ul></li><li><a href="#ì›ì¸ì€-ì•Œì•˜ê³ -ì„œë²„ì—ì„œ-ë°ë“œë½ì„-í•´ê²°í• -ìˆ˜-ìˆëŠ”-ë°©ë²•ì„-ê³ ë¯¼í•´ë³´ì">ì›ì¸ì€ ì•Œì•˜ê³ , ì„œë²„ì—ì„œ ë°ë“œë½ì„ í•´ê²°í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ê³ ë¯¼í•´ë³´ì</a><ul><li><a href="#-ì²«ë²ˆì§¸-ì‹œë„-ì¡´ì¬í•˜ëŠ”-ê²½ìš°ì—ë§Œ-row-ì‚­ì œ">â ì²«ë²ˆì§¸ ì‹œë„, ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ row ì‚­ì œ</a></li><li><a href="#-ë‘ë²ˆì§¸-ì‹œë„-ì¡´ì¬í•˜ëŠ”-ê²½ìš°ì—ë§Œ-row-ì‚­ì œí•˜ë©´ì„œ-ìœ ë‹ˆí¬-ì¡°ê±´-ì¶”ê°€">âœ… ë‘ë²ˆì§¸ ì‹œë„, ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ row ì‚­ì œí•˜ë©´ì„œ ìœ ë‹ˆí¬ ì¡°ê±´ ì¶”ê°€</a></li><li><a href="#-ì„¸ë²ˆì§¸-ì‹œë„-redis-ì—-ë™ì‹œì„±-ì œì–´ë¥¼-ìœ„í•œ-í‚¤-ì¶”ê°€">â ì„¸ë²ˆì§¸ ì‹œë„, Redis ì— ë™ì‹œì„± ì œì–´ë¥¼ ìœ„í•œ í‚¤ ì¶”ê°€</a></li><li><a href="#-ë„¤ë²ˆì§¸-ì‹œë„-ìš”ì²­-ì œí•œ">â ë„¤ë²ˆì§¸ ì‹œë„, ìš”ì²­ ì œí•œ</a></li></ul></li><li><a href="#ì •ë¦¬">ì •ë¦¬</a><ul><li><a href="#í¥ë¯¸ë¡œìš´-ì‹¤í—˜">í¥ë¯¸ë¡œìš´ ì‹¤í—˜</a><ul><li><a href="#ì¸ë±ìŠ¤ê°€-ê±¸ë¦°-ì»¬ëŸ¼-ê¸°ì¤€ìœ¼ë¡œ-ì¿¼ë¦¬">ì¸ë±ìŠ¤ê°€ ê±¸ë¦° ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ì¿¼ë¦¬</a></li><li><a href="#ì¸ë±ìŠ¤ê°€-ê±¸ë¦¬ì§€-ì•Šì€-ì»¬ëŸ¼-ê¸°ì¤€ìœ¼ë¡œ-ì¿¼ë¦¬">ì¸ë±ìŠ¤ê°€ ê±¸ë¦¬ì§€ ì•Šì€ ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ì¿¼ë¦¬</a></li></ul></li><li><a href="#ê¸°ë¡ìš©">ê¸°ë¡ìš©</a></li></ul></li></ul>

    </div>
    <p><img src="https://velog.velcdn.com/images/haron/post/329afb75-8be4-47ed-ab19-cb087ec1a934/image.png" alt="" /></p>

<p>ì—­ì‹œ <a href="https://velog.io/@haron/%EC%99%B8%EB%9E%98%ED%82%A4Foreign-Key%EC%99%80-%EB%8D%B0%EB%93%9C%EB%9D%BDDeadLock-%EA%B7%B8%EB%A6%AC%EA%B3%A0-%EC%BF%BC%EB%A6%AC-%EC%A7%80%EC%97%B0-%EC%8B%A4%ED%96%89-eruedsy4">í•´ì¹˜ì› ë‚˜</a>ë¥¼ ì™¸ì¹˜ë©´ ì•ˆ ë˜ëŠ” ê²ƒì¸ê°€â€¦ ë˜ ìš¸ê¸° ì‹œì‘í•œ í˜í˜â€¦ (ê·¸ë§Œ ìš¸ì–´ì‡!)
ì˜ë¯¸ìˆëŠ” ê²½í—˜ìœ¼ë¡œ ë‚¨ê¸°ê¸°ìœ„í•´ ê¸°ë¡í•´ë³´ì.
<img src="https://velog.velcdn.com/images/haron/post/1687c152-873d-425f-96f9-174735a9c262/image.png" alt="" /></p>

<h2 id="ë°ë“œë½ì´-ë°œìƒí•˜ëŠ”-ìƒí™©-ë‹¤ì‹œ-ì¬í˜„">ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ìƒí™© ë‹¤ì‹œ ì¬í˜„</h2>

<h3 id="í˜„ì¬-í…Œì´ë¸”-ìƒíƒœ">í˜„ì¬ í…Œì´ë¸” ìƒíƒœ</h3>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">parent</span>
<span class="p">(</span>
    <span class="n">id</span>             <span class="nb">bigint</span>        <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">name</span>           <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>  <span class="k">null</span><span class="p">,</span>
    <span class="n">updated_at</span>     <span class="nb">datetime</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>   <span class="k">null</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">child</span>
<span class="p">(</span>
    <span class="n">id</span>           <span class="nb">bigint</span>          <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">name</span>         <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>    <span class="k">null</span><span class="p">,</span>
    <span class="n">parent_id</span>    <span class="nb">bigint</span>          <span class="k">null</span><span class="p">,</span>
    <span class="k">CONSTRAINT</span> <span class="n">parent_id_unique</span> <span class="k">UNIQUE</span> <span class="p">(</span><span class="n">parent_id</span><span class="p">)</span>
<span class="p">);</span>


<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">child_index</span>
<span class="p">(</span>
    <span class="n">id</span>           <span class="nb">bigint</span>          <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">name</span>         <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>    <span class="k">null</span><span class="p">,</span>
    <span class="n">parent_id</span>    <span class="nb">bigint</span>          <span class="k">null</span><span class="p">,</span>
<span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">parent_id</span> <span class="k">ON</span> <span class="n">child_index</span> <span class="p">(</span><span class="n">parent_id</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">parent</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'parent_1'</span><span class="p">,</span> <span class="n">NOW</span><span class="p">());</span>
</code></pre></div></div>
<ol>
  <li>parent í…Œì´ë¸”ì˜ idë¥¼ indexë¡œ ê°€ì§€ê³  ìˆëŠ” child_index í…Œì´ë¸” ìƒì„±(ì™¸ë˜í‚¤ëŠ” ìš´ì˜ì—ì„œ ì‚­ì œë˜ì–´ì„œ í…ŒìŠ¤íŠ¸ì‹œ ê³ ë ¤í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤)</li>
  <li>parent í…Œì´ë¸”ì˜ idë¥¼ ìœ ë‹ˆí¬ í‚¤ë¡œ ê°€ì§€ê³  ìˆëŠ” child í…Œì´ë¸” ìƒì„±(ë§ˆì°¬ê°€ì§€ë¡œ ì™¸ë˜í‚¤ ê³ ë ¤í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)</li>
  <li>parent í…Œì´ë¸”ì— í…ŒìŠ¤íŠ¸ ë°ì´í„° ì ì¬</li>
</ol>

<h3 id="ê·¸ëŸ¼-ì´ì œ-ë°ë“œë½ì„-ë°œìƒì‹œì¼œ-ë³´ì">ê·¸ëŸ¼ ì´ì œ ë°ë“œë½ì„ ë°œìƒì‹œì¼œ ë³´ì</h3>
<h3 id="index-ê±¸ë ¤ìˆëŠ”-row-delete---index-ê±¸ë ¤ìˆëŠ”-ìì‹-row-insertê°€-ë‘ê°œì˜-ì„¸ì…˜ì—ì„œ-ìˆ˜í–‰ë˜ë©´-ë°ë“œë½ì´-ë°œìƒ-">index ê±¸ë ¤ìˆëŠ” row delete â†’  index ê±¸ë ¤ìˆëŠ” ìì‹ row insertê°€ ë‘ê°œì˜ ì„¸ì…˜ì—ì„œ ìˆ˜í–‰ë˜ë©´, ë°ë“œë½ì´ ë°œìƒ ğŸ’£</h3>
<p><img src="https://velog.velcdn.com/images/haron/post/bc47166e-b1b7-4f30-ac1f-09932cb38ff7/image.png" alt="" /></p>

<table>
  <thead>
    <tr>
      <th>TX1</th>
      <th>TX2</th>
      <th>lock</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>BEGIN ;  <br /> DELETE FROM child_index WHERE parent_id = 2;</td>
      <td>Â </td>
      <td>(1) child X Lock ì¸ë°, TX2ì—ì„œ X Lock íšë“ ê°€ëŠ¥í• ê¹Œ ğŸ¤”</td>
    </tr>
    <tr>
      <td>Â </td>
      <td>BEGIN ;  <br /> DELETE FROM child_index WHERE parent_id = 2;</td>
      <td>(2) child X Lock</td>
    </tr>
    <tr>
      <td>INSERT INTO child_index VALUES (â€˜1â€™, â€˜name2â€™, 2);</td>
      <td>Â </td>
      <td>(3) child X,INSERT_INTENTION Lock ëŒ€ê¸°</td>
    </tr>
    <tr>
      <td>Â </td>
      <td>INSERT INTO child_index VALUES (â€˜2â€™, â€˜name2â€™, 2);</td>
      <td>(4) child X,INSERT_INTENTION Lock ëŒ€ê¸°</td>
    </tr>
    <tr>
      <td>Â </td>
      <td>Deadlock found when trying to get lock; try restarting transaction</td>
      <td>(4) child X lock ì´ í•„ìš”í•˜ì§€ë§Œ, (2) ì—ì„œ child X lock ìƒíƒœ <br /> (4) í•´ì†Œë¥¼ ìœ„í•´ì„œ (3) í•´ì†Œ í•„ìš” <br /> -&gt; (3) í•´ì†Œ ìœ„í•´ì„œ TX2 ì»¤ë°‹ í•„ìš” <br /> -&gt; TX2 ì»¤ë°‹í•˜ë ¤ë©´ (4) í•´ì†Œ í•„ìš” <br /> -&gt; ë°ë“œë½ ë°œìƒ</td>
    </tr>
  </tbody>
</table>

<h2 id="ìš´ì˜í™˜ê²½ì—ì„œ-ë°ë“œë½ì´-ë°œìƒí•˜ëŠ”-ë¡œì§ì„-ì‚´í´ë³´ì">ìš´ì˜í™˜ê²½ì—ì„œ ë°ë“œë½ì´ ë°œìƒí•˜ëŠ” ë¡œì§ì„ ì‚´í´ë³´ì</h2>

<h3 id="index-ê±¸ë ¤ìˆëŠ”-row-delete---index-ê±¸ë ¤ìˆëŠ”-ìì‹-row-insertê°€-ë‘ê°œì˜-ì„¸ì…˜ì—ì„œ-ìˆ˜í–‰ë˜ë©´-ë°ë“œë½ì´-ë°œìƒ--1">index ê±¸ë ¤ìˆëŠ” row delete â†’  index ê±¸ë ¤ìˆëŠ” ìì‹ row insertê°€ ë‘ê°œì˜ ì„¸ì…˜ì—ì„œ ìˆ˜í–‰ë˜ë©´, ë°ë“œë½ì´ ë°œìƒ ğŸ’£</h3>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">parent</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">child</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'child_1'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">child_index</span> <span class="k">WHERE</span> <span class="n">parent_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">child_index</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'child_index_1'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">UPDATE</span> <span class="n">parent</span> <span class="k">SET</span>  <span class="n">updated_at</span> <span class="o">=</span> <span class="n">NOW</span><span class="p">()</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nd">@Transactional</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createChildAndChildIndex</span> <span class="o">(</span><span class="kt">long</span> <span class="n">parentId</span><span class="o">)</span> <span class="o">{</span>

    <span class="kt">var</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">parentRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">parentId</span><span class="o">);</span>
    
    <span class="n">childIndexRepository</span><span class="o">.</span><span class="na">deleteByParent</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
    <span class="n">childIndexRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="n">Child_Index</span><span class="o">(</span><span class="err">'</span><span class="n">child_index_1</span><span class="err">'</span><span class="o">,</span> <span class="n">parent</span><span class="o">));</span>

  <span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>í•œê°€ì§€ ì‹ ê¸°í•œ ì ì€ delete í•˜ë ¤ëŠ” ë°ì´í„°ê°€ ì—†ì„ ë•Œ, ë°ë“œë½ì´ ë°œìƒí•œë‹¤.</li>
  <li>delete í•˜ë ¤ëŠ” ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ì—ëŠ” ê°™ì€ ë¡œì§ì„ ìˆ˜í–‰í•˜ë©´ ë½ì„ ì¡ì„ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê²Œ ëœë‹¤.</li>
</ul>

<h2 id="ì›ì¸ì€-ì•Œì•˜ê³ -ì„œë²„ì—ì„œ-ë°ë“œë½ì„-í•´ê²°í• -ìˆ˜-ìˆëŠ”-ë°©ë²•ì„-ê³ ë¯¼í•´ë³´ì">ì›ì¸ì€ ì•Œì•˜ê³ , ì„œë²„ì—ì„œ ë°ë“œë½ì„ í•´ê²°í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ê³ ë¯¼í•´ë³´ì</h2>
<h3 id="-ì²«ë²ˆì§¸-ì‹œë„-ì¡´ì¬í•˜ëŠ”-ê²½ìš°ì—ë§Œ-row-ì‚­ì œ">â ì²«ë²ˆì§¸ ì‹œë„, ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ row ì‚­ì œ</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nd">@Transactional</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createParent</span> <span class="o">(</span><span class="kt">long</span> <span class="n">parentId</span><span class="o">)</span> <span class="o">{</span>

    <span class="kt">var</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">parentRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">parentId</span><span class="o">);</span>
    
    <span class="k">if</span><span class="o">(</span><span class="n">childIndexRepository</span><span class="o">.</span><span class="na">findByParent</span><span class="o">(</span><span class="n">parent</span><span class="o">).</span><span class="na">isPresent</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">childIndexRepository</span><span class="o">.</span><span class="na">deleteByParent</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">childIndexRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="n">Child_Index</span><span class="o">(</span><span class="err">'</span><span class="n">child_index_1</span><span class="err">'</span><span class="o">,</span> <span class="n">parent</span><span class="o">));</span>
  <span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>ë¬´ì¡°ê±´ delete í•˜ëŠ” ë¡œì§ìœ¼ë¡œ ì¸í•œ ë°°íƒ€ë½ì€ ë°©ì§€ ê°€ëŠ¥í•˜ë‹¤.</li>
  <li>ë™ì‹œ ìš”ì²­ì‹œì— childIndexRepository.findByParent ì— ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ë¡œ ë¶„ê¸°ì²˜ë¦¬ë˜ëŠ” ê²½ìš°, ë°ì´í„°ê°€ 2ë°°ë¡œ ì ì¬ë  ìˆ˜ ìˆë‹¤.
    <ul>
      <li>300ms ë¡œ ì“°ë ˆë“œ sleep() ê±¸ì–´ì„œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ 2ë°°ë¡œ ìŒ“ì´ëŠ” ê²ƒì„ í™•ì¸</li>
    </ul>
  </li>
</ul>

<h3 id="-ë‘ë²ˆì§¸-ì‹œë„-ì¡´ì¬í•˜ëŠ”-ê²½ìš°ì—ë§Œ-row-ì‚­ì œí•˜ë©´ì„œ-ìœ ë‹ˆí¬-ì¡°ê±´-ì¶”ê°€">âœ… ë‘ë²ˆì§¸ ì‹œë„, ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ row ì‚­ì œí•˜ë©´ì„œ ìœ ë‹ˆí¬ ì¡°ê±´ ì¶”ê°€</h3>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">child_index</span>
<span class="p">(</span>
    <span class="n">id</span>           <span class="nb">bigint</span>          <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">name</span>         <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>    <span class="k">null</span><span class="p">,</span>
    <span class="n">parent_id</span>    <span class="nb">bigint</span>          <span class="k">null</span><span class="p">,</span>
    <span class="k">CONSTRAINT</span> <span class="n">parent_id_unique</span> <span class="k">UNIQUE</span> <span class="p">(</span><span class="n">parent_id</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">parent_id</span> <span class="k">ON</span> <span class="n">child_index</span> <span class="p">(</span><span class="n">parent_id</span><span class="p">);</span>
</code></pre></div></div>
<ul>
  <li>ë™ì‹œ ìš”ì²­ì‹œì— childIndexRepository.findByParent ì— ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ë¡œ ë¶„ê¸°ì²˜ë¦¬ë˜ëŠ” ê²½ìš°, í›„ì— ì»¤ë°‹ë˜ì–´ ì ì¬ëœ ë°ì´í„°ëŠ” ì¤‘ë³µí‚¤ ì—ëŸ¬ ì²˜ë¦¬ëœë‹¤.</li>
</ul>

<h3 id="-ì„¸ë²ˆì§¸-ì‹œë„-redis-ì—-ë™ì‹œì„±-ì œì–´ë¥¼-ìœ„í•œ-í‚¤-ì¶”ê°€">â ì„¸ë²ˆì§¸ ì‹œë„, Redis ì— ë™ì‹œì„± ì œì–´ë¥¼ ìœ„í•œ í‚¤ ì¶”ê°€</h3>
<ul>
  <li>ê°„í—ì ì¸ ë°ë“œë½ì´ê³ , ìœ„ ì„œë¹„ìŠ¤ì—ì„œ Redisë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ ìºì‹œ ë¦¬ì†ŒìŠ¤ê°€ ë” í´ ê²ƒ ê°™ì•„ ë‚˜ê°€ë¦¬!</li>
</ul>

<h3 id="-ë„¤ë²ˆì§¸-ì‹œë„-ìš”ì²­-ì œí•œ">â ë„¤ë²ˆì§¸ ì‹œë„, ìš”ì²­ ì œí•œ</h3>
<ul>
  <li>Bucket4jë¥¼ ì´ìš©í•´ì„œ í´ë¼ì´ì–¸íŠ¸ê°€ íŠ¹ì • ì‹œê°„ í”„ë ˆì„ ë‚´ì— ë§Œë“¤ ìˆ˜ ìˆëŠ” API í˜¸ì¶œ ìˆ˜ë¥¼ ì œí•œí•œë‹¤.</li>
  <li>ìœ„ ì„œë¹„ìŠ¤ëŠ” ì„œë²„ê°€ ì—¬ëŸ¬ëŒ€ì¸ ê²½ìš°ë¼ì„œ ë‹¤ë¥¸ ì„œë²„ë¡œ ë™ì‹œ ìš”ì²­ì´ ë“¤ì–´ê°€ëŠ” ê²½ìš°, ë°ë“œë½ ë°©ì§€ ë¶ˆê°€ëŠ¥</li>
</ul>

<h2 id="ì •ë¦¬">ì •ë¦¬</h2>
<ol>
  <li>ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°, ì‚­ì œ ì¿¼ë¦¬ë¥¼ ë‚ ë¦¬ë©´ delete, select ëŠ” ê°€ëŠ¥í•˜ì§€ë§Œ insert ì‹œì— ë½ì„ ê¸°ë‹¤ë¦¬ê²Œ ëœë‹¤.</li>
  <li>ë½ì´ ê¶ê¸ˆí•˜ë‹¤ë©´, <a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html#innodb-record-locks">MySQL ê³µì‹ë¬¸ì„œ ì¤‘ InnoDB Lock ë©”ë‰´ì–¼</a>ì„ ì°¸ê³ í•´ë³´ì. (ì˜ˆì œì™€ í•¨ê»˜ ì •ë¦¬ê°€ ë„ˆë¬´ ì˜ ë˜ì–´ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.)</li>
</ol>

<h3 id="í¥ë¯¸ë¡œìš´-ì‹¤í—˜">í¥ë¯¸ë¡œìš´ ì‹¤í—˜</h3>
<h4 id="ì¸ë±ìŠ¤ê°€-ê±¸ë¦°-ì»¬ëŸ¼-ê¸°ì¤€ìœ¼ë¡œ-ì¿¼ë¦¬">ì¸ë±ìŠ¤ê°€ ê±¸ë¦° ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ì¿¼ë¦¬</h4>
<ul>
  <li>ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ì—ëŠ”, 2ë²ˆì§¸ íŠ¸ëœì­ì…˜ì—ì„œ delete ì‹œì— ë½ íšë“ì„ ê¸°ë‹¤ë¦°ë‹¤.
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">BEGIN</span> <span class="p">;</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">child_index</span> <span class="k">WHERE</span> <span class="n">parent_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">child_index</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'child_index_1'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">COMMIT</span> <span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ì—ëŠ”, 2ë²ˆì§¸ íŠ¸ëœì­ì…˜ì—ì„œ delete ì‹œì— ë½ íšë“ì´ ë°”ë¡œ ê°€ëŠ¥í•˜ë‹¤.
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">BEGIN</span> <span class="p">;</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">child_index</span> <span class="k">WHERE</span> <span class="n">parent_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">child_index</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'child_index_1'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">COMMIT</span> <span class="p">;</span>
</code></pre></div>    </div>
    <h4 id="ì¸ë±ìŠ¤ê°€-ê±¸ë¦¬ì§€-ì•Šì€-ì»¬ëŸ¼-ê¸°ì¤€ìœ¼ë¡œ-ì¿¼ë¦¬">ì¸ë±ìŠ¤ê°€ ê±¸ë¦¬ì§€ ì•Šì€ ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ì¿¼ë¦¬</h4>
  </li>
  <li>ë°ì´í„°ê°€ ìˆëŠ” / ì—†ëŠ” ê²½ìš°, 2ë²ˆì§¸ íŠ¸ëœì­ì…˜ì—ì„œ delete ì‹œì— ë½ íšë“ì„ ê¸°ë‹¤ë¦°ë‹¤.
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">BEGIN</span> <span class="p">;</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">child_index</span> <span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">'child_index_2'</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">child_index</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'child_index_1'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">COMMIT</span> <span class="p">;</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="ê¸°ë¡ìš©">ê¸°ë¡ìš©</h3>
<details>
<summary>SHOW ENGINE innodb STATUS;</summary>
  *** (1) TRANSACTION:TRANSACTION 13034, ACTIVE 6 sec insertingmysql tables in use 1, locked 1LOCK WAIT 4 lock struct(s), heap size 1128, 3 row lock(s), undo log entries 1MySQL thread id 280, OS thread handle 6136639488, query id 21716 localhost 127.0.0.1 root update/* ApplicationName=DataGrip 2022.3.2 */ insert into child values ('2', 'name2', 2)

*** (1) HOLDS THE LOCK(S):RECORD LOCKS space id 154 page no 4 n bits 72 index PRIMARY of table jpa.child trx id 13034 lock_mode X locks rec but not gapRecord lock, heap no 3 PHYSICAL RECORD: n_fields 5; compact format; info bits 0

*** (1) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 154 page no 5 n bits 72 index parent_id of table jpa.child trx id 13034 lock_mode X insert intention waitingRecord lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0

*** (2) TRANSACTION:TRANSACTION 13035, ACTIVE 4 sec insertingmysql tables in use 1, locked 1LOCK WAIT 3 lock struct(s), heap size 1128, 2 row lock(s)MySQL thread id 281, OS thread handle 6135525376, query id 21726 localhost 127.0.0.1 root update/* ApplicationName=DataGrip 2022.3.2 */ insert into child values ('2', 'name2', 2)

*** (2) HOLDS THE LOCK(S):RECORD LOCKS space id 154 page no 5 n bits 72 index parent_id of table jpa.child trx id 13035 lock_mode XRecord lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0

*** (2) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 154 page no 4 n bits 72 index PRIMARY of table jpa.child trx id 13035 lock mode S locks rec but not gap waitingRecord lock, heap no 3 PHYSICAL RECORD: n_fields 5; compact format; info bits 0

- SELECT * FROM performance_schema.data_locks;

| INDEX\_NAME | OBJECT\_INSTANCE\_BEGIN | LOCK\_TYPE | LOCK\_MODE | LOCK\_STATUS | LOCK\_DATA |
| :--- | :--- | :--- | :--- | :--- | :--- |
| null | 4813003272 | TABLE | IX | GRANTED | null |
| parent\_id | 4823656472 | RECORD | X | GRANTED | supremum pseudo-record |
| parent\_id | 4823656816 | RECORD | X,INSERT\_INTENTION | GRANTED | supremum pseudo-record |
| parent\_id | 4823657160 | RECORD | X,GAP | GRANTED | 1, 1 |
</details>

  </article>
</div>

<div class="pagination">
  
  
    <a href="/ko/dead-lock-by-fk/" class="right arrow">&#8594;</a>
  

  
  <!-- Start giscus -->
<script src="https://giscus.app/client.js"
        data-repo="hocaron/hocaron.github.io"
        data-repo-id="R_kgDOL3mLWw"
        data-category="Comments"
        data-category-id="DIC_kwDOL3mLW84CfNm5"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="light"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>
<!-- End giscus -->

  

  <a href="#" class="top">Top</a>
</div>

<script src="../assets/js/toc.js"></script>

  </main>

  <footer>
  <a href="mailto:kkannu0407@gmail.com">
    <i class="far fa-envelope fa-fw"></i>
  </a>
  <a href="https://github.com/hocaron" target="_blank">
    <i class="fab fa-github fa-fw"></i>
  </a>
  <a href="https://www.linkedin.com/in/sunwoo-ho-86b45823a" target="_blank">
    <i class="fab fa-linkedin fa-fw"></i>
  </a>

  <br>
  <span>&copy; 2024 Hocaron</span>
</footer>

</div>
</body>
</html>
